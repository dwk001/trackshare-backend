import{a as e}from"./apiService-sJWJ5l_Y.js";var t={};const r={spotify:{name:"spotify",displayName:"Spotify",icon:"ğŸµ",color:"#1DB954",authUrl:"https://accounts.spotify.com/authorize",tokenUrl:"https://accounts.spotify.com/api/token",scopes:["user-read-private","user-read-email","user-read-playback-state","user-modify-playback-state","user-read-currently-playing","user-read-recently-played"],clientId:t.VITE_SPOTIFY_CLIENT_ID},apple_music:{name:"apple_music",displayName:"Apple Music",icon:"ğŸ",color:"#FA243C",authUrl:"https://appleid.apple.com/auth/authorize",tokenUrl:"https://appleid.apple.com/auth/token",scopes:["music"],clientId:t.VITE_APPLE_MUSIC_CLIENT_ID},youtube_music:{name:"youtube_music",displayName:"YouTube Music",icon:"ğŸ“º",color:"#FF0000",authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token",scopes:["https://www.googleapis.com/auth/youtube.readonly"],clientId:t.VITE_YOUTUBE_CLIENT_ID},deezer:{name:"deezer",displayName:"Deezer",icon:"ğŸ¶",color:"#FF0000",authUrl:"https://connect.deezer.com/oauth/auth.php",tokenUrl:"https://connect.deezer.com/oauth/access_token.php",scopes:["basic_access","email","offline_access"],clientId:t.VITE_DEEZER_CLIENT_ID},tidal:{name:"tidal",displayName:"Tidal",icon:"ğŸŒŠ",color:"#00FFFF",authUrl:"https://auth.tidal.com/oauth2/authorize",tokenUrl:"https://auth.tidal.com/oauth2/token",scopes:["r_usr","w_usr"],clientId:t.VITE_TIDAL_CLIENT_ID},soundcloud:{name:"soundcloud",displayName:"SoundCloud",icon:"â˜ï¸",color:"#FF5500",authUrl:"https://soundcloud.com/connect",tokenUrl:"https://api.soundcloud.com/oauth2/token",scopes:["non-expiring"],clientId:t.VITE_SOUNDCLOUD_CLIENT_ID}};const a=new class{baseUrl="/api/providers";async connectProvider(e){const t=r[e];if(!t.clientId)throw new Error(`${t.displayName} OAuth not configured`);const a=new URLSearchParams({client_id:t.clientId,response_type:"code",redirect_uri:`${window.location.origin}/api/providers/callback/${e}`,scope:t.scopes.join(" "),state:this.generateState()}),o=`${t.authUrl}?${a.toString()}`;window.location.href=o}async getConnectedProviders(){try{return(await e.get(`${this.baseUrl}/status`)).data||[]}catch(t){return[]}}async disconnectProvider(t){try{await e.post(`${this.baseUrl}/disconnect/${t}`)}catch(r){throw r}}async refreshToken(t){try{return(await e.post(`${this.baseUrl}/refresh/${t}`)).data}catch(r){throw r}}getProviderConfig(e){return r[e]}getAllProviders(){return Object.values(r).map(e=>({provider:e.name,isConnected:!1,displayName:e.displayName,icon:e.icon,color:e.color}))}async isProviderConnected(e){return(await this.getConnectedProviders()).some(t=>t.provider===e&&t.isConnected)}async getPrimaryProvider(){return(await this.getConnectedProviders()).find(e=>e.isConnected)||null}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async handleCallback(t,r,a){try{return(await e.post(`${this.baseUrl}/callback/${t}`,{code:r,state:a})).data}catch(o){throw o}}async getListeningActivity(t,r=50){try{return(await e.get(`${this.baseUrl}/activity/${t}?limit=${r}`)).data||[]}catch(a){return[]}}async getPlaylists(t){try{return(await e.get(`${this.baseUrl}/playlists/${t}`)).data||[]}catch(r){return[]}}async getSavedTracks(t,r=50){try{return(await e.get(`${this.baseUrl}/saved-tracks/${t}?limit=${r}`)).data||[]}catch(a){return[]}}async searchTracks(t,r,a=20){try{return(await e.get(`${this.baseUrl}/search/${t}?q=${encodeURIComponent(r)}&limit=${a}`)).data||[]}catch(o){return[]}}async playTrack(t,r){try{await e.post(`${this.baseUrl}/play/${t}`,{trackId:r})}catch(a){throw a}}async addToLibrary(t,r){try{await e.post(`${this.baseUrl}/library/${t}`,{trackId:r})}catch(a){throw a}}async removeFromLibrary(t,r){try{await e.delete(`${this.baseUrl}/library/${t}/${r}`)}catch(a){throw a}}},o={spotify:{provider:"spotify",nativeUrl:"spotify:track:{id}",webUrl:"https://open.spotify.com/track/{id}",searchUrl:"spotify:search:{query}",fallbackUrl:"https://open.spotify.com/search/{query}"},apple_music:{provider:"apple_music",nativeUrl:"music://music.apple.com/album/{albumId}?i={trackId}",webUrl:"https://music.apple.com/us/album/{albumId}?i={trackId}",searchUrl:"music://music.apple.com/search?term={query}",fallbackUrl:"https://music.apple.com/us/search?term={query}"},youtube_music:{provider:"youtube_music",nativeUrl:"youtubemusic://watch?v={videoId}",webUrl:"https://music.youtube.com/watch?v={videoId}",searchUrl:"youtubemusic://search?q={query}",fallbackUrl:"https://music.youtube.com/search?q={query}"},deezer:{provider:"deezer",nativeUrl:"deezer://www.deezer.com/track/{id}",webUrl:"https://www.deezer.com/track/{id}",searchUrl:"deezer://search/{query}",fallbackUrl:"https://www.deezer.com/search/{query}"},tidal:{provider:"tidal",nativeUrl:"tidal://track/{id}",webUrl:"https://tidal.com/browse/track/{id}",searchUrl:"tidal://search/{query}",fallbackUrl:"https://tidal.com/search/{query}"},soundcloud:{provider:"soundcloud",nativeUrl:"soundcloud://sounds:{id}",webUrl:"https://soundcloud.com/{permalink}",searchUrl:"soundcloud://search/{query}",fallbackUrl:"https://soundcloud.com/search/sounds?q={query}"}};const i=new class{generateTrackLink(e,t,r){const a=o[t],i=r?.[t];let s=e.id,c="",n="",l="";switch(t){case"spotify":s=i?.spotify?.id||e.spotify_url?.split("/").pop()||e.id;break;case"apple_music":s=i?.apple_music?.id||e.apple_music_url?.split("/").pop()||e.id,c=i?.apple_music?.id||e.id;break;case"youtube_music":n=i?.youtube_music?.videoId||e.youtube_url?.split("v=")[1]?.split("&")[0]||e.id;break;case"deezer":s=i?.deezer?.id||e.id;break;case"tidal":s=i?.tidal?.id||e.id;break;case"soundcloud":s=i?.soundcloud?.id||e.id,l=i?.soundcloud?.permalink_url?.split("/").pop()||e.id}return{nativeUrl:this.replacePlaceholders(a.nativeUrl,{id:s,albumId:c,videoId:n,permalink:l}),webUrl:this.replacePlaceholders(a.webUrl,{id:s,albumId:c,videoId:n,permalink:l}),searchUrl:this.replacePlaceholders(a.searchUrl,{query:encodeURIComponent(`${e.artist} ${e.title}`)}),fallbackUrl:this.replacePlaceholders(a.fallbackUrl,{query:encodeURIComponent(`${e.artist} ${e.title}`)})}}async openInProvider(e,t,r){const a=this.generateTrackLink(e,t,r);try{await this.attemptDeepLink(a.nativeUrl),setTimeout(()=>{window.open(a.webUrl,"_blank")},800)}catch(o){window.open(a.webUrl,"_blank")}}async attemptDeepLink(e){return new Promise((t,r)=>{const a=document.createElement("iframe");a.style.display="none",a.src=e,document.body.appendChild(a),setTimeout(()=>{document.body.removeChild(a),t()},100),a.onerror=()=>{document.body.removeChild(a),r(new Error("Deep link failed"))}})}async openProviderSelection(e,t){const r=await this.generateShareLink(e,t);window.open(`/t/${r.shortId}`,"_blank")}async generateShareLink(e,t){try{const r=await fetch("/api/share",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({track:e,providerData:t})});return{shortId:(await r.json()).shortId}}catch(r){return{shortId:this.generateShortId()}}}async isProviderInstalled(e){const t=o[e];try{return await this.attemptDeepLink(t.searchUrl.replace("{query}","test")),!0}catch(r){return!1}}getAllProviderLinks(e,t){const r={};return Object.keys(o).forEach(a=>{r[a]=this.generateTrackLink(e,a,t)}),r}replacePlaceholders(e,t){let r=e;return Object.entries(t).forEach(([e,t])=>{r=r.replace(`{${e}}`,t)}),r}generateShortId(){return Math.random().toString(36).substring(2,8)}getProviderInfo(e){return{spotify:{name:"spotify",displayName:"Spotify",icon:"ğŸµ",color:"#1DB954"},apple_music:{name:"apple_music",displayName:"Apple Music",icon:"ğŸ",color:"#FA243C"},youtube_music:{name:"youtube_music",displayName:"YouTube Music",icon:"ğŸ“º",color:"#FF0000"},deezer:{name:"deezer",displayName:"Deezer",icon:"ğŸ¶",color:"#FF0000"},tidal:{name:"tidal",displayName:"Tidal",icon:"ğŸŒŠ",color:"#00FFFF"},soundcloud:{name:"soundcloud",displayName:"SoundCloud",icon:"â˜ï¸",color:"#FF5500"}}[e]}isDeepLinkSupported(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t="navigator"in window&&"registerProtocolHandler"in navigator;return e||t}getRecommendedProvider(){const e=navigator.userAgent.toLowerCase();return e.includes("iphone")||e.includes("ipad")?"apple_music":(e.includes("android"),"spotify")}};export{i as d,a as p};
