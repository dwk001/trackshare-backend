<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="csrf-token" content="placeholder-csrf-token">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽµ</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TrackShare">
    <meta name="application-name" content="TrackShare">
    <title>TrackShare - Discover & Share Music</title>
    <meta property="og:title" content="TrackShare - Discover & Share Music">
    <meta property="og:description" content="Discover trending music and share it across all platforms">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .auth-buttons {
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .btn-spotify {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
            color: white;
            border: none;
        }
        .btn-spotify:hover {
            background: linear-gradient(135deg, #1ed760 0%, #1DB954 100%);
        }
        .btn-apple-music {
            background: linear-gradient(135deg, #FA243C 0%, #ff6b6b 100%);
            color: white;
            border: none;
        }
        .btn-apple-music:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #FA243C 100%);
        }
        .btn-youtube-music {
            background: linear-gradient(135deg, #FF0000 0%, #ff4444 100%);
            color: white;
            border: none;
        }
        .btn-youtube-music:hover {
            background: linear-gradient(135deg, #ff4444 0%, #FF0000 100%);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Mobile UX and Accessibility Improvements */
        
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .btn, .tab, .track-card, .post-card {
                min-height: 48px;
                min-width: 48px;
            }
            
            .btn:hover {
                transform: none; /* Disable hover effects on touch devices */
            }
            
            .track-card:hover, .post-card:hover {
                transform: none;
            }
        }
        
        /* Improved focus indicators for accessibility */
        .btn:focus, .tab:focus, button:focus, input:focus, textarea:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Skip navigation link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn-primary {
                background: #000;
                color: #fff;
                border: 2px solid #fff;
            }
            
            .btn-secondary {
                background: #fff;
                color: #000;
                border: 2px solid #000;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #e2e8f0;
            }
            
            .header {
                background: rgba(26, 26, 46, 0.95);
                color: #e2e8f0;
            }
            
            .logo {
                color: #e2e8f0;
            }
            
            .btn-secondary {
                background: transparent;
                color: #667eea;
                border: 2px solid #667eea;
            }
            
            .track-card, .post-card {
                background: rgba(26, 26, 46, 0.8);
                color: #e2e8f0;
            }
        }
        
        /* Improved mobile scrolling */
        .container {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Pull-to-refresh indicator */
        .pull-to-refresh {
            position: fixed;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 0 0 20px 20px;
            font-size: 14px;
            transition: top 0.3s ease;
            z-index: 1000;
        }
        
        .pull-to-refresh.active {
            top: 0;
        }
        
        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Improved error states */
        .error-state {
            text-align: center;
            padding: 2rem;
            color: #ef4444;
        }
        
        .error-state .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .error-state .retry-btn {
            margin-top: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* ARIA live regions for screen readers */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .aria-live {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        /* Improved modal accessibility */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal[aria-hidden="true"] {
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .auth-buttons {
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 14px;
            }
            
            .track-card, .post-card {
                margin-bottom: 1rem;
            }
            
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            /* Improved touch targets */
            .track-action-btn, .post-action-btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }
        }
        
        /* Animation keyframes */
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Loading spinner improvements */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Improved button states */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Focus management for modals */
        .modal[aria-hidden="false"] .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Improved form accessibility */
        input:invalid {
            border-color: #ef4444;
        }
        
        input:valid {
            border-color: #10b981;
        }
        
        .form-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .form-success {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* Screen reader announcements */
        .announcement {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        .ptr-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }
        
        .ptr-indicator.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }
        
        .empty-state .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .empty-state .suggestion {
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Feed Tabs */
        .feed-tabs-section {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
        }

        .feed-tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .feed-tabs::-webkit-scrollbar {
            display: none;
        }

        .feed-tabs .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid transparent;
            min-width: 80px;
            max-width: 100px;
            text-align: center;
            position: relative;
        }

        .feed-tabs .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .feed-tabs .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .tab-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .tab-label {
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Social Feed */
        .social-feed {
            background: #f8fafc;
            min-height: 60vh;
        }

        .feed-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .feed-post {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }

        .feed-post:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem 0.5rem 1.5rem;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .post-user-info h4 {
            margin: 0;
            font-size: 1rem;
            color: #1f2937;
        }

        .post-user-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .post-content {
            margin-bottom: 1rem;
        }

        .post-track {
            display: flex;
            align-items: center;
            margin: 0.5rem 1.5rem 1rem 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .post-track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .post-track-artwork {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            margin-right: 1rem;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .post-track:hover .post-track-artwork {
            transform: scale(1.05);
        }

        .post-track-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .post-track-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            color: #1f2937;
        }

        .post-track-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .post-caption {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .post-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
        }

        .post-actions-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .post-action:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .post-action.liked {
            color: #e74c3c;
        }

        .post-action.liked:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .post-action.liked {
            color: #e74c3c;
            animation: heartBeat 0.6s ease-in-out;
        }

        .post-action.liked:hover {
            color: #dc2626;
        }

        .post-action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .post-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Advanced Music Discovery Styles */
        .discovery-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .discovery-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .discovery-control-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .discovery-select {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .discovery-select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
        }

        .discovery-select option {
            background: #1a1a1a;
            color: white;
        }

        .mood-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .mood-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .mood-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .mood-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
        }

        .discovery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .recommendation-reason {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            margin-top: 0.5rem;
        }

        .track-card.recommended {
            border: 2px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        /* Playlist Management Styles */
        .playlist-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .playlist-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .playlist-artwork {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .playlist-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .playlist-details h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }

        .playlist-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .playlist-actions {
            display: flex;
            gap: 1rem;
        }

        .playlist-tracks {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .track-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .track-number {
            width: 30px;
            text-align: center;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
        }

        .track-item-artwork {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .track-item-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .track-item-info {
            flex: 1;
        }

        .track-item-title {
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .track-item-artist {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .track-item-duration {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .track-item-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .track-item:hover .track-item-actions {
            opacity: 1;
        }

        .playlist-create-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .playlist-create-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .playlist-form-group {
            margin-bottom: 1.5rem;
        }

        .playlist-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .playlist-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .playlist-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .playlist-form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .playlist-form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .playlist-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .playlist-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .playlist-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.15);
        }

        .playlist-card-artwork {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            margin-bottom: 1rem;
        }

        .playlist-card-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .playlist-card-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .playlist-card-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
        }

        .playlist-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .playlist-card-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .playlist-card-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .playlist-card-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* User Listening Insights Styles */
        .insights-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .insights-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .insights-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .insights-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .insight-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .insight-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .insight-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .insight-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
        }

        .insight-chart {
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .chart-bar {
            display: flex;
            align-items: end;
            height: 150px;
            gap: 4px;
            margin-bottom: 1rem;
        }

        .chart-bar-item {
            flex: 1;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            min-height: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-bar-item:hover {
            background: linear-gradient(to top, #764ba2, #667eea);
            transform: scaleY(1.05);
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .insight-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .trend-indicator {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }

        .trend-neutral {
            color: rgba(255, 255, 255, 0.6);
        }

        .insights-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .insight-filter-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .insight-filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .insight-filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .top-artists-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .artist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .artist-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .artist-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .artist-info {
            flex: 1;
        }

        .artist-name {
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .artist-plays {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .artist-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .artist-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .listening-pattern {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .pattern-day {
            aspect-ratio: 1;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .pattern-day.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .pattern-day:hover {
            transform: scale(1.1);
        }

        .insights-empty {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .insights-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .insights-empty h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: white;
        }

        .insights-empty p {
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        /* Music Groups & Communities Styles */
        .groups-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .groups-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .groups-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .groups-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .groups-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .group-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .group-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .group-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .group-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .group-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .group-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .group-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .group-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .group-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .group-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .group-stat {
            text-align: center;
        }

        .group-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .group-stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .group-actions {
            display: flex;
            gap: 0.5rem;
        }

        .group-action-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .group-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .group-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .group-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .group-create-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .group-create-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .group-form-group {
            margin-bottom: 1.5rem;
        }

        .group-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .group-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .group-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .group-form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .group-form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .group-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .group-members {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .group-member {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .group-member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .group-member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .group-recent-activity {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .activity-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .activity-content {
            flex: 1;
            color: rgba(255, 255, 255, 0.8);
        }

        .activity-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Music Challenges & Competitions Styles */
        .challenges-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .challenges-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .challenges-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .challenges-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .challenges-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .challenge-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .challenge-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .challenge-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .challenge-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .challenge-card.featured {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        }

        .challenge-card.featured::before {
            content: 'â­';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
        }

        .challenge-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .challenge-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .challenge-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .challenge-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .challenge-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .challenge-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .challenge-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .challenge-stat {
            text-align: center;
        }

        .challenge-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .challenge-stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .challenge-progress {
            margin-bottom: 1.5rem;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-progress-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .challenge-rewards {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .challenge-reward {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .challenge-reward-icon {
            font-size: 1rem;
        }

        .challenge-actions {
            display: flex;
            gap: 0.5rem;
        }

        .challenge-action-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .challenge-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .challenge-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .challenge-action-btn.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .challenge-action-btn.completed:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .leaderboard-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .leaderboard-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 1rem;
        }

        .leaderboard-rank.top-3 {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .leaderboard-user {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .leaderboard-score {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .leaderboard-score-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #667eea;
            margin-left: 0.5rem;
        }

        .challenge-create-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .challenge-create-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .challenge-form-group {
            margin-bottom: 1.5rem;
        }

        .challenge-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .challenge-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .challenge-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .challenge-form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .challenge-form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .challenge-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Music Events & Festivals Styles */
        .events-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .events-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .events-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .events-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .events-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .event-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .event-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .event-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .event-card.live {
            border: 2px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        }

        .event-card.live::before {
            content: 'ðŸ”´ LIVE';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .event-card.upcoming {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        }

        .event-card.upcoming::before {
            content: 'â° UPCOMING';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .event-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .event-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            overflow: hidden;
        }

        .event-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .event-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .event-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
        }

        .event-date {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .event-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .event-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .event-detail-icon {
            font-size: 1rem;
        }

        .event-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .event-stat {
            text-align: center;
        }

        .event-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .event-stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .event-lineup {
            margin-bottom: 1.5rem;
        }

        .event-lineup h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.75rem;
        }

        .lineup-artists {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .lineup-artist {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .lineup-artist-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .lineup-artist-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
        }

        .event-action-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .event-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .event-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .event-action-btn.live {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
        }

        .event-action-btn.live:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .event-action-btn.attending {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .event-action-btn.attending:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .event-create-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .event-create-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .event-form-group {
            margin-bottom: 1.5rem;
        }

        .event-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .event-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .event-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .event-form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .event-form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .event-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .event-countdown {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .countdown-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 50px;
        }

        .countdown-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .countdown-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Playlist Analytics Styles */
        .playlist-analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .playlist-analytics-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .playlist-analytics-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .playlist-analytics-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .playlist-analytics-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .playlist-analytics-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .playlist-analytics-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .playlist-analytics-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .playlist-analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .playlist-analytics-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .playlist-analytics-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .playlist-analytics-card.featured {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        }

        .playlist-analytics-card.featured::before {
            content: 'â­';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .playlist-analytics-header-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .playlist-analytics-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            overflow: hidden;
        }

        .playlist-analytics-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .playlist-analytics-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .playlist-analytics-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
        }

        .playlist-analytics-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .playlist-analytics-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .playlist-analytics-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .playlist-analytics-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .playlist-analytics-stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .playlist-analytics-chart {
            margin-bottom: 1.5rem;
        }

        .playlist-analytics-chart h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.75rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            height: 200px;
            display: flex;
            align-items: end;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            min-height: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            background: linear-gradient(to top, #764ba2, #667eea);
            transform: scaleY(1.05);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
        }

        .playlist-analytics-insights {
            margin-bottom: 1.5rem;
        }

        .playlist-analytics-insights h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.75rem;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .insight-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .insight-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .playlist-analytics-actions {
            display: flex;
            gap: 0.5rem;
        }

        .playlist-analytics-action-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-analytics-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .playlist-analytics-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .playlist-analytics-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .playlist-analytics-action-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .playlist-analytics-action-btn.success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .playlist-analytics-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-analytics-summary h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .summary-stat {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .summary-stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .summary-stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
        }

        .summary-stat-change {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .summary-stat-change.positive {
            color: #10b981;
        }

        .summary-stat-change.negative {
            color: #ef4444;
        }

        .summary-stat-change.neutral {
            color: rgba(255, 255, 255, 0.6);
        }

        .playlist-analytics-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .playlist-analytics-filter {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-analytics-filter:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .playlist-analytics-filter.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        /* Music Achievements & Badges Styles */
        .achievements-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .achievements-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .achievements-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
        }

        .achievements-header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            margin: 0 auto;
        }

        .achievements-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .achievement-tab {
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .achievement-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .achievement-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .achievement-card.earned {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        }

        .achievement-card.earned::before {
            content: 'ðŸ†';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .achievement-card.rare {
            border: 2px solid #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
        }

        .achievement-card.rare::before {
            content: 'ðŸ’Ž';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .achievement-card.epic {
            border: 2px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        }

        .achievement-card.epic::before {
            content: 'ðŸ”¥';
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .achievement-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 1.5rem auto;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .achievement-card:hover .achievement-icon {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .achievement-card.earned .achievement-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .achievement-card.rare .achievement-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .achievement-card.epic .achievement-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .achievement-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .achievement-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .achievement-progress {
            margin-bottom: 1.5rem;
        }

        .achievement-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .achievement-card.earned .achievement-progress-fill {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .achievement-card.rare .achievement-progress-fill {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .achievement-card.epic .achievement-progress-fill {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .achievement-progress-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .achievement-reward-icon {
            font-size: 1.2rem;
        }

        .achievement-reward-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .achievement-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .achievement-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .achievement-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .achievement-stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .achievement-actions {
            display: flex;
            gap: 0.5rem;
        }

        .achievement-action-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .achievement-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .achievement-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .achievement-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .achievement-action-btn.claim {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .achievement-action-btn.claim:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .achievement-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .achievement-summary h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .summary-stat {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .summary-stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .summary-stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.25rem;
        }

        .summary-stat-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .achievement-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .achievement-filter {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .achievement-filter:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .achievement-filter.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .achievement-notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-notification-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .achievement-notification-icon {
            font-size: 2rem;
        }

        .achievement-notification-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .achievement-notification-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.75rem;
        }

        .achievement-notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .achievement-notification-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .achievement-notification-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .feed-tabs {
                padding: 0 1rem;
                overflow-x: auto;
                justify-content: flex-start;
            }

            .feed-tabs .tab {
                flex-shrink: 0;
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .feed-container {
                padding: 0.5rem;
            }

            .feed-post {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }

            .post-track {
                padding: 0.75rem;
            }

            .post-track-artwork {
                width: 50px;
                height: 50px;
            }
        }

        /* Create Post Form Styles */
        .create-post-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .post-preview {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .post-preview h4 {
            margin: 0 0 0.75rem 0;
            color: #374151;
        }

        .preview-track {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .preview-artwork {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 0.75rem;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .preview-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .preview-info h5 {
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            color: #1f2937;
        }

        .preview-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .preview-caption {
            margin: 0;
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .form-actions .btn {
            min-width: 100px;
        }

        /* Notification Animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Comments Modal Styles */
        .comments-container {
            max-height: 60vh;
            overflow-y: auto;
        }

        .comments-list {
            margin-bottom: 1rem;
        }

        .comment-item {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .comment-author {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .comment-time {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .comment-text {
            color: #374151;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .add-comment {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .comment-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-actions small {
            color: #6b7280;
        }

        .comment-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .no-comments {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .no-comments .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        /* Friends UI Styles */
        .friends-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .friends-section {
            margin-bottom: 2rem;
        }

        .friends-section h3 {
            margin-bottom: 1rem;
            color: #1f2937;
            font-size: 1.25rem;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .friend-item:hover {
            transform: translateY(-1px);
        }

        .friend-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .friend-status {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
        }

        .friend-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-accept {
            background: #10b981;
            color: white;
        }

        .btn-accept:hover {
            background: #059669;
        }

        .btn-decline {
            background: #ef4444;
            color: white;
        }

        .btn-decline:hover {
            background: #dc2626;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-add:hover {
            transform: translateY(-1px);
        }

        .btn-remove {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-remove:hover {
            background: #e5e7eb;
        }

        .request-badge {
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        .no-friends {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .no-friends .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .no-friends h4 {
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .no-friends p {
            margin-bottom: 1.5rem;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .suggestion-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .suggestion-item:hover {
            transform: translateY(-2px);
        }

        .suggestion-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            margin: 0 auto 0.75rem auto;
        }

        .suggestion-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .suggestion-email {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: relative;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .notification-bell:hover {
            background-color: #f3f4f6;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Notifications Modal Styles */
        .notifications-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 5rem;
            z-index: 10000;
        }

        .notifications-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .notifications-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h2 {
            margin: 0;
            color: #1f2937;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #667eea;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
        }

        .mark-all-read:hover {
            color: #5a67d8;
        }

        .notifications-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f8fafc;
        }

        .notification-item.unread {
            background-color: #fef3c7;
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .notification-message {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .notification-action-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-accept-notification {
            background: #10b981;
            color: white;
        }

        .btn-accept-notification:hover {
            background: #059669;
        }

        .btn-view-notification {
            background: #667eea;
            color: white;
        }

        .btn-view-notification:hover {
            background: #5a67d8;
        }

        .no-notifications {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #6b7280;
        }

        .no-notifications .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Profile Page Styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .profile-header {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-name {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .profile-bio {
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .profile-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .profile-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            display: block;
        }

        .profile-stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-edit-profile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-edit-profile:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-settings {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-settings:hover {
            background: #e5e7eb;
        }

        .profile-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .profile-main {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .profile-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .profile-widget {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .profile-widget h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .profile-posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .profile-post-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .profile-post-card:hover {
            transform: translateY(-2px);
        }

        .profile-post-artwork {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            background: #e5e7eb;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .profile-post-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-post-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .profile-post-artist {
            color: #6b7280;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .profile-post-stats {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .profile-form {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-form h2 {
            margin: 0 0 1.5rem 0;
            color: #1f2937;
            text-align: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 2rem;
            border: 1px solid #e5e7eb;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

        /* Settings Modal Styles */
        .settings-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .settings-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .settings-section h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-content h4 {
            margin: 0 0 0.25rem 0;
            color: #1f2937;
            font-size: 1rem;
            font-weight: 500;
        }

        .settings-item-content p {
            margin: 0;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .settings-select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.875rem;
            min-width: 120px;
        }

        .settings-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-actions {
            margin-top: 2rem;
            text-align: center;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* Activity History Modal Styles */
        .activity-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .filter-group select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .activity-stats {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }

        .activity-item:hover {
            background-color: #f8fafc;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .activity-description {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .activity-metadata {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .no-activity {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .no-activity .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Playlist and Recommendation Styles */
        .playlist-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .playlist-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .playlist-artwork {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .playlist-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }

        .playlist-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .playlist-card:hover .playlist-overlay {
            opacity: 1;
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .playlist-meta {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .playlist-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .playlist-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .playlist-actions {
            display: flex;
            gap: 0.5rem;
        }

        .playlist-actions .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .recommendation-reason {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 500;
            margin-top: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            display: inline-block;
        }

        /* Analytics Modal Styles */
        .analytics-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .analytics-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .analytics-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .analytics-section h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .analytics-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .analytics-card .card-title {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .analytics-card .card-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .analytics-card .card-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .analytics-card .card-change.positive {
            color: #10b981;
        }

        .analytics-card .card-change.negative {
            color: #ef4444;
        }

        .analytics-card .card-change.neutral {
            color: #6b7280;
        }

        .chart-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .chart-bar-label {
            width: 80px;
            font-size: 0.8rem;
            color: #374151;
            font-weight: 500;
        }

        .chart-bar-fill {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            margin: 0 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .chart-bar-progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .chart-bar-value {
            width: 40px;
            font-size: 0.8rem;
            color: #6b7280;
            text-align: right;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .trend-indicator.increasing {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .trend-indicator.decreasing {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .trend-indicator.stable {
            color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .insight-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .insight-card p {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .pattern-day {
            text-align: center;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
        }

        .pattern-day-label {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .pattern-day-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1f2937;
        }

        .pattern-day.high {
            background: rgba(102, 126, 234, 0.2);
        }

        .pattern-day.medium {
            background: rgba(102, 126, 234, 0.1);
        }

        .pattern-day.low {
            background: #f8fafc;
        }

        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .profile-stats {
                gap: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .settings-select {
                width: 100%;
            }
            
            .activity-filters {
                flex-direction: column;
            }
            
            .filter-group select {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .playlist-card {
                padding: 1rem;
            }
            
            .playlist-actions {
                flex-direction: column;
            }
            
            .analytics-filters {
                flex-direction: column;
            }
            
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pattern-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 0.25rem;
            }
            
            .pattern-day {
                padding: 0.25rem;
            }
        }
        
        /* Track popularity bars */
        .track-popularity {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* Explicit badge */
        .explicit-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Play overlay */
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .track-card:hover .play-overlay {
            opacity: 1;
        }
        
        .play-button {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .play-button:hover {
            transform: scale(1.1);
        }
        
        /* Load more container */
        .load-more-container {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
        }
        
        /* Responsive breakpoints - Mobile First */
        
        /* Extra Small (Mobile) - 320px to 575px */
        @media (max-width: 575px) {
            .feed-container { 
                padding: 0.5rem; 
            }
            
            .feed-card {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            .track-artwork {
                height: 300px; /* Full width square */
            }
            
            .genre-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding: 0 1rem;
            }
            
            .tab {
                display: inline-block;
                min-width: 80px;
                font-size: 0.875rem;
                margin-right: 0.5rem;
            }
            
            .music-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .hero {
                padding: 2rem 1rem;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .search-bar {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .search-bar input {
                width: 100%;
            }
        }
        
        /* Small (Large Mobile) - 576px to 767px */
        @media (min-width: 576px) and (max-width: 767px) {
            .music-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .feed-card {
                max-width: 100%;
            }
        }
        
        /* Medium (Tablet) - 768px to 991px */
        @media (min-width: 768px) and (max-width: 991px) {
            .music-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
            
            .navbar {
                padding: 1rem 2rem;
            }
            
            .feed-container {
                max-width: 720px;
                margin: 0 auto;
            }
        }
        
        /* Large (Desktop) - 992px to 1199px */
        @media (min-width: 992px) and (max-width: 1199px) {
            .music-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 2rem;
            }
            
            .feed-container {
                max-width: 960px;
                margin: 0 auto;
            }
            
            /* Two-column layout for feed + sidebar */
            .main-layout {
                display: grid;
                grid-template-columns: 1fr 300px;
                gap: 2rem;
            }
        }
        
        /* Extra Large (Large Desktop) - 1200px+ */
        @media (min-width: 1200px) {
            .music-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 2rem;
            }
            
            .feed-container {
                max-width: 1140px;
                margin: 0 auto;
            }
            
            .main-layout {
                display: grid;
                grid-template-columns: 300px 1fr 300px; /* sidebar, feed, recommendations */
                gap: 2rem;
                max-width: 1400px;
                margin: 0 auto;
            }
        }
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            color: white;
        }
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .hero p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        .search-container {
            max-width: 600px;
            margin: 0 auto 3rem;
            position: relative;
        }

        .search-input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 0.5rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            background: transparent;
            color: white;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.75rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            position: relative;
            z-index: 10;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        /* Advanced Filters Panel */
        .advanced-filters {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 1rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .filter-group select option {
            background: #1a1a1a;
            color: white;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }
        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
        }
        .discovery-section {
            background: white;
            padding: 3rem 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #333;
        }
        .genre-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .track-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .track-card:hover {
            transform: translateY(-4px);
        }
        .track-artwork {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            background: #f0f0f0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            position: relative;
            overflow: hidden;
        }
        .track-artwork img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .track-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .track-artist {
            color: #666;
            margin-bottom: 1rem;
        }
        .play-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1.1rem;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal h2 {
            margin-bottom: 1rem;
            color: #333;
        }
        .modal p {
            margin-bottom: 1.5rem;
            color: #666;
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .share-link {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            word-break: break-all;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
        <!-- Skip navigation link for screen readers -->
        <a href="#main-content" class="skip-link">Skip to main content</a>
        
        <!-- Screen reader announcements -->
        <div class="aria-live" aria-live="polite" aria-atomic="true" id="announcements"></div>
        
        <!-- Online/Offline status indicator -->
        <div class="online-status" aria-live="polite"></div>
        
        <!-- Pull-to-refresh indicator -->
        <div class="pull-to-refresh" id="pullToRefresh">
            <span>ðŸ”„ Pull to refresh</span>
        </div>
        
        <!-- Main header -->
        <header class="header" role="banner">
            <div class="logo" aria-label="TrackShare - Discover & Share Music">ðŸŽµ TrackShare</div>
            <nav class="auth-buttons" role="navigation" aria-label="Authentication">
                <button class="btn btn-secondary" onclick="showSignIn()" aria-label="Sign in to TrackShare">Sign In</button>
                <button class="btn btn-primary" onclick="showSignUp()" aria-label="Create new TrackShare account">Sign Up</button>
                <button class="btn btn-secondary" id="createPostBtn" onclick="showCreatePostModal()" style="display: none;" aria-label="Share new music">+ Share Music</button>
                <div id="notificationsContainer" style="display: none;" role="region" aria-label="Notifications">
                    <button class="notification-bell" onclick="showNotifications()" id="notificationBell" aria-label="View notifications">
                        ðŸ””
                        <span class="notification-badge" id="notificationBadge" style="display: none;" aria-label="Unread notifications count">0</span>
                    </button>
                </div>
            </nav>
        </header>

    <main id="main-content" role="main">
        <section class="hero" aria-labelledby="hero-title">
            <h1 id="hero-title">Discover Amazing Music</h1>
            <p>Find trending tracks and share them across all platforms</p>
            <div class="search-container">
                <div class="search-input-group">
                    <input type="text" class="search-input" placeholder="Search for songs, artists, or paste a music link..." id="searchInput">
                    <button class="search-btn" onclick="searchMusic()">Search</button>
                    <button class="filter-btn" onclick="toggleAdvancedFilters()" title="Advanced Filters">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
                        </svg>
                    </button>
                </div>
                
                <!-- Advanced Filters Panel -->
                <div id="advancedFilters" class="advanced-filters" style="display: none;">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="genreFilter">Genre:</label>
                            <select id="genreFilter">
                                <option value="">Any Genre</option>
                                <option value="pop">Pop</option>
                                <option value="rock">Rock</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="electronic">Electronic</option>
                                <option value="jazz">Jazz</option>
                                <option value="classical">Classical</option>
                                <option value="country">Country</option>
                                <option value="r&b">R&B</option>
                                <option value="reggae">Reggae</option>
                                <option value="blues">Blues</option>
                                <option value="folk">Folk</option>
                                <option value="alternative">Alternative</option>
                                <option value="indie">Indie</option>
                                <option value="metal">Metal</option>
                                <option value="punk">Punk</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="yearFilter">Year:</label>
                            <select id="yearFilter">
                                <option value="">Any Year</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                                <option value="2010-2014">2010-2014</option>
                                <option value="2000-2009">2000-2009</option>
                                <option value="1990-1999">1990-1999</option>
                                <option value="1980-1989">1980-1989</option>
                                <option value="1970-1979">1970-1979</option>
                                <option value="1960-1969">1960-1969</option>
                                <option value="1950-1959">1950-1959</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="popularityFilter">Popularity:</label>
                            <select id="popularityFilter">
                                <option value="">Any Popularity</option>
                                <option value="80-100">Very Popular (80-100)</option>
                                <option value="60-79">Popular (60-79)</option>
                                <option value="40-59">Moderate (40-59)</option>
                                <option value="20-39">Less Popular (20-39)</option>
                                <option value="0-19">Undiscovered (0-19)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="explicitFilter">Content:</label>
                            <select id="explicitFilter">
                                <option value="">Any Content</option>
                                <option value="false">Clean Only</option>
                                <option value="true">Explicit OK</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="sortByFilter">Sort By:</label>
                            <select id="sortByFilter">
                                <option value="">Relevance</option>
                                <option value="popularity">Most Popular</option>
                                <option value="popularity_asc">Least Popular</option>
                                <option value="name">Track Name</option>
                                <option value="artist">Artist Name</option>
                                <option value="album">Album Name</option>
                                <option value="release_date">Release Date</option>
                                <option value="duration">Duration</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="artistFilter">Artist:</label>
                            <input type="text" id="artistFilter" placeholder="Specific artist...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="albumFilter">Album:</label>
                            <input type="text" id="albumFilter" placeholder="Specific album...">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Feed Tabs -->
        <section class="feed-tabs-section">
            <div class="container">
                <div class="feed-tabs">
                    <!-- Public tabs (always visible) -->
                    <div class="tab active" data-feed="trending" onclick="switchFeed('trending')">
                        <div class="tab-icon">ðŸ”¥</div>
                        <div class="tab-label">Trending</div>
                    </div>
                    <div class="tab" data-feed="discover" onclick="switchFeed('discover')">
                        <div class="tab-icon">ðŸŽµ</div>
                        <div class="tab-label">Discover</div>
                    </div>
                    
                    <!-- Authenticated-only tabs (hidden by default) -->
                    <div class="tab auth-only" data-feed="friends" onclick="switchFeed('friends')" style="display: none;">
                        <div class="tab-icon">ðŸ‘¥</div>
                        <div class="tab-label">Friends</div>
                    </div>
                    <div class="tab auth-only" data-feed="groups" onclick="switchFeed('groups')" style="display: none;">
                        <div class="tab-icon">ðŸŽ­</div>
                        <div class="tab-label">Groups</div>
                    </div>
                    <div class="tab auth-only" data-feed="challenges" onclick="switchFeed('challenges')" style="display: none;">
                        <div class="tab-icon">ðŸ†</div>
                        <div class="tab-label">Challenges</div>
                    </div>
                    <div class="tab auth-only" data-feed="events" onclick="switchFeed('events')" style="display: none;">
                        <div class="tab-icon">ðŸŽª</div>
                        <div class="tab-label">Events</div>
                    </div>
                    <div class="tab auth-only" data-feed="analytics" onclick="switchFeed('analytics')" style="display: none;">
                        <div class="tab-icon">ðŸ“Š</div>
                        <div class="tab-label">Analytics</div>
                    </div>
                    <div class="tab auth-only" data-feed="achievements" onclick="switchFeed('achievements')" style="display: none;">
                        <div class="tab-icon">ðŸ†</div>
                        <div class="tab-label">Achievements</div>
                    </div>
                    <div class="tab auth-only" data-feed="requests" onclick="switchFeed('requests')" style="display: none;">
                        <div class="tab-icon">ðŸ“¬</div>
                        <div class="tab-label">Requests</div>
                    </div>
                    <div class="tab auth-only" data-feed="profile" onclick="switchFeed('profile')" style="display: none;">
                        <div class="tab-icon">ðŸ‘¤</div>
                        <div class="tab-label">Profile</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Social Feed -->
        <section id="socialFeed" class="social-feed">
            <div class="container">
                <div class="loading-spinner" id="feedLoading">
                    <div class="spinner"></div>
                    <p>Loading feed...</p>
                </div>
            </div>
        </section>

        <!-- Music Discovery (Hidden by default) -->
        <section id="musicDiscovery" class="discovery-section" style="display: none;">
            <div class="container">
                <h2 class="section-title">Discover Music</h2>
                
                <!-- Discovery Controls -->
                <div class="discovery-controls">
                    <div class="discovery-control-group">
                        <label>Genre</label>
                        <select class="discovery-select" id="genreFilter" onchange="filterByGenre()">
                            <option value="all">All Genres</option>
                            <option value="pop">Pop</option>
                            <option value="rock">Rock</option>
                            <option value="hip-hop">Hip-Hop</option>
                            <option value="electronic">Electronic</option>
                            <option value="country">Country</option>
                            <option value="jazz">Jazz</option>
                            <option value="classical">Classical</option>
                        </select>
                    </div>
                    
                    <div class="discovery-control-group">
                        <label>Mood</label>
                        <div class="mood-buttons">
                            <button class="mood-btn" data-mood="happy" onclick="filterByMood('happy')">ðŸ˜Š Happy</button>
                            <button class="mood-btn" data-mood="chill" onclick="filterByMood('chill')">ðŸ˜Œ Chill</button>
                            <button class="mood-btn" data-mood="energetic" onclick="filterByMood('energetic')">âš¡ Energetic</button>
                            <button class="mood-btn" data-mood="melancholic" onclick="filterByMood('melancholic')">ðŸ˜” Melancholic</button>
                            <button class="mood-btn" data-mood="romantic" onclick="filterByMood('romantic')">ðŸ’• Romantic</button>
                        </div>
                    </div>
                    
                    <div class="discovery-control-group">
                        <label>Time Period</label>
                        <select class="discovery-select" id="timeFilter" onchange="filterByTime()">
                            <option value="all">All Time</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2020s">2020s</option>
                            <option value="2010s">2010s</option>
                            <option value="2000s">2000s</option>
                            <option value="90s">90s</option>
                        </select>
                    </div>
                    
                    <div class="discovery-control-group">
                        <label>Discovery Type</label>
                        <select class="discovery-select" id="discoveryType" onchange="changeDiscoveryType()">
                            <option value="trending">Trending</option>
                            <option value="recommendations">For You</option>
                            <option value="new-releases">New Releases</option>
                            <option value="playlists">Playlists</option>
                        </select>
                    </div>
                </div>
                
                <!-- Discovery Stats -->
                <div class="discovery-stats" id="discoveryStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTracks">0</div>
                        <div class="stat-label">Tracks Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgPopularity">0</div>
                        <div class="stat-label">Avg Popularity</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="topGenre">-</div>
                        <div class="stat-label">Top Genre</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newReleases">0</div>
                        <div class="stat-label">New Releases</div>
                    </div>
                </div>
                
                <div class="genre-tabs">
                    <div class="tab active" data-genre="all" onclick="switchGenre('all')">All Genres</div>
                    <div class="tab" data-genre="pop" onclick="switchGenre('pop')">Pop</div>
                    <div class="tab" data-genre="rock" onclick="switchGenre('rock')">Rock</div>
                    <div class="tab" data-genre="hip-hop" onclick="switchGenre('hip-hop')">Hip-Hop</div>
                    <div class="tab" data-genre="country" onclick="switchGenre('country')">Country</div>
                    <div class="tab" data-genre="electronic" onclick="switchGenre('electronic')">Electronic</div>
                    <div class="tab" data-genre="recommendations" onclick="switchGenre('recommendations')">For You</div>
                    <div class="tab" data-genre="playlists" onclick="switchGenre('playlists')">Playlists</div>
                </div>
                <div id="musicGrid" class="music-grid">
                    <div class="loading">Loading trending music...</div>
                </div>
            </div>
        </section>

        <!-- Music Groups (Hidden by default) -->
        <section id="musicGroups" class="groups-section" style="display: none;">
            <div class="groups-container">
                <div class="groups-header">
                    <h1>Music Groups & Communities</h1>
                    <p>Join music communities, discover new artists, and connect with fellow music lovers who share your taste.</p>
                </div>
                
                <div class="groups-tabs">
                    <div class="group-tab active" data-group-type="all" onclick="filterGroups('all')">
                        All Groups
                    </div>
                    <div class="group-tab" data-group-type="genre" onclick="filterGroups('genre')">
                        By Genre
                    </div>
                    <div class="group-tab" data-group-type="artist" onclick="filterGroups('artist')">
                        Artist Fan Clubs
                    </div>
                    <div class="group-tab" data-group-type="local" onclick="filterGroups('local')">
                        Local Music
                    </div>
                    <div class="group-tab" data-group-type="my-groups" onclick="filterGroups('my-groups')">
                        My Groups
                    </div>
                </div>
                
                <div class="groups-grid" id="groupsGrid">
                    <!-- Groups will be loaded here -->
                </div>
                
                ${isSignedIn ? `
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="showCreateGroupModal()">
                            Create New Group
                        </button>
                    </div>
                ` : ''}
            </div>
        </section>

        <!-- Music Challenges (Hidden by default) -->
        <section id="musicChallenges" class="challenges-section" style="display: none;">
            <div class="challenges-container">
                <div class="challenges-header">
                    <h1>Music Challenges & Competitions</h1>
                    <p>Compete with friends, earn rewards, and discover new music through fun challenges!</p>
                </div>
                
                <div class="challenges-tabs">
                    <div class="challenge-tab active" data-challenge-type="all" onclick="filterChallenges('all')">
                        All Challenges
                    </div>
                    <div class="challenge-tab" data-challenge-type="daily" onclick="filterChallenges('daily')">
                        Daily
                    </div>
                    <div class="challenge-tab" data-challenge-type="weekly" onclick="filterChallenges('weekly')">
                        Weekly
                    </div>
                    <div class="challenge-tab" data-challenge-type="monthly" onclick="filterChallenges('monthly')">
                        Monthly
                    </div>
                    <div class="challenge-tab" data-challenge-type="my-challenges" onclick="filterChallenges('my-challenges')">
                        My Progress
                    </div>
                </div>
                
                <div class="challenges-grid" id="challengesGrid">
                    <!-- Challenges will be loaded here -->
                </div>
                
                ${isSignedIn ? `
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="showCreateChallengeModal()">
                            Create Challenge
                        </button>
                    </div>
                ` : ''}
            </div>
        </section>

        <!-- Music Events & Festivals (Hidden by default) -->
        <section id="musicEvents" class="events-section" style="display: none;">
            <div class="events-container">
                <div class="events-header">
                    <h1>Music Events & Festivals</h1>
                    <p>Discover live music events, festivals, and concerts happening around you!</p>
                </div>
                
                <div class="events-tabs">
                    <div class="event-tab active" data-event-type="all" onclick="filterEvents('all')">
                        All Events
                    </div>
                    <div class="event-tab" data-event-type="live" onclick="filterEvents('live')">
                        ðŸ”´ Live Now
                    </div>
                    <div class="event-tab" data-event-type="upcoming" onclick="filterEvents('upcoming')">
                        â° Upcoming
                    </div>
                    <div class="event-tab" data-event-type="festivals" onclick="filterEvents('festivals')">
                        ðŸŽª Festivals
                    </div>
                    <div class="event-tab" data-event-type="concerts" onclick="filterEvents('concerts')">
                        ðŸŽµ Concerts
                    </div>
                    <div class="event-tab" data-event-type="my-events" onclick="filterEvents('my-events')">
                        My Events
                    </div>
                </div>
                
                <div class="events-grid" id="eventsGrid">
                    <!-- Events will be loaded here -->
                </div>
                
                ${isSignedIn ? `
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="showCreateEventModal()">
                            Create Event
                        </button>
                    </div>
                ` : ''}
            </div>
        </section>

        <!-- Playlist Analytics (Hidden by default) -->
        <section id="playlistAnalytics" class="playlist-analytics-section" style="display: none;">
            <div class="playlist-analytics-container">
                <div class="playlist-analytics-header">
                    <h1>Playlist Analytics & Insights</h1>
                    <p>Track your playlist performance, engagement metrics, and discover insights about your music taste!</p>
                </div>
                
                <div class="playlist-analytics-filters">
                    <div class="playlist-analytics-filter active" data-analytics-period="7d" onclick="filterAnalytics('7d')">
                        Last 7 Days
                    </div>
                    <div class="playlist-analytics-filter" data-analytics-period="30d" onclick="filterAnalytics('30d')">
                        Last 30 Days
                    </div>
                    <div class="playlist-analytics-filter" data-analytics-period="90d" onclick="filterAnalytics('90d')">
                        Last 90 Days
                    </div>
                    <div class="playlist-analytics-filter" data-analytics-period="all" onclick="filterAnalytics('all')">
                        All Time
                    </div>
                </div>
                
                <div class="playlist-analytics-summary" id="analyticsSummary">
                    <!-- Summary stats will be loaded here -->
                </div>
                
                <div class="playlist-analytics-tabs">
                    <div class="playlist-analytics-tab active" data-analytics-type="overview" onclick="switchAnalyticsTab('overview')">
                        ðŸ“Š Overview
                    </div>
                    <div class="playlist-analytics-tab" data-analytics-type="playlists" onclick="switchAnalyticsTab('playlists')">
                        ðŸ“ Playlists
                    </div>
                    <div class="playlist-analytics-tab" data-analytics-type="engagement" onclick="switchAnalyticsTab('engagement')">
                        ðŸ’¬ Engagement
                    </div>
                    <div class="playlist-analytics-tab" data-analytics-type="trends" onclick="switchAnalyticsTab('trends')">
                        ðŸ“ˆ Trends
                    </div>
                    <div class="playlist-analytics-tab" data-analytics-type="insights" onclick="switchAnalyticsTab('insights')">
                        ðŸ’¡ Insights
                    </div>
                </div>
                
                <div class="playlist-analytics-grid" id="analyticsGrid">
                    <!-- Analytics content will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Music Achievements & Badges (Hidden by default) -->
        <section id="musicAchievements" class="achievements-section" style="display: none;">
            <div class="achievements-container">
                <div class="achievements-header">
                    <h1>Music Achievements & Badges</h1>
                    <p>Earn badges and achievements for your music activities! Track your milestones and unlock special rewards.</p>
                </div>
                
                <div class="achievement-filters">
                    <div class="achievement-filter active" data-achievement-filter="all" onclick="filterAchievements('all')">
                        All Achievements
                    </div>
                    <div class="achievement-filter" data-achievement-filter="earned" onclick="filterAchievements('earned')">
                        ðŸ† Earned
                    </div>
                    <div class="achievement-filter" data-achievement-filter="progress" onclick="filterAchievements('progress')">
                        ðŸ“ˆ In Progress
                    </div>
                    <div class="achievement-filter" data-achievement-filter="locked" onclick="filterAchievements('locked')">
                        ðŸ”’ Locked
                    </div>
                </div>
                
                <div class="achievement-summary" id="achievementSummary">
                    <!-- Achievement summary will be loaded here -->
                </div>
                
                <div class="achievements-tabs">
                    <div class="achievement-tab active" data-achievement-type="listening" onclick="switchAchievementTab('listening')">
                        ðŸŽ§ Listening
                    </div>
                    <div class="achievement-tab" data-achievement-type="social" onclick="switchAchievementTab('social')">
                        ðŸ‘¥ Social
                    </div>
                    <div class="achievement-tab" data-achievement-type="discovery" onclick="switchAchievementTab('discovery')">
                        ðŸ” Discovery
                    </div>
                    <div class="achievement-tab" data-achievement-type="milestones" onclick="switchAchievementTab('milestones')">
                        ðŸŽ¯ Milestones
                    </div>
                    <div class="achievement-tab" data-achievement-type="special" onclick="switchAchievementTab('special')">
                        â­ Special
                    </div>
                </div>
                
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Achievements will be loaded here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Sign In Modal -->
    <div id="signInModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('signInModal')">&times;</button>
            <h2>Sign In</h2>
            <p>Sign in to save your favorite tracks and connect with friends</p>
            <button class="btn btn-primary" onclick="signInWithGoogle()" style="width: 100%; margin-bottom: 1rem;">
                Continue with Google
            </button>
            <button class="btn btn-secondary" onclick="signInWithApple()" style="width: 100%;">
                Continue with Apple
            </button>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signUpModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('signUpModal')">&times;</button>
            <h2>Sign Up</h2>
            <p>Join TrackShare to discover and share amazing music</p>
            <button class="btn btn-primary" onclick="signUpWithGoogle()" style="width: 100%; margin-bottom: 1rem;">
                Continue with Google
            </button>
            <button class="btn btn-secondary" onclick="signUpWithApple()" style="width: 100%;">
                Continue with Apple
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('shareModal')">&times;</button>
            <h2>Share This Track</h2>
            <p>Copy this link to share with friends:</p>
            <div class="share-link" id="shareLink"></div>
            <button class="copy-btn" onclick="copyShareLink()">Copy Link</button>
            <div style="margin-top: 1rem;">
                <button class="btn btn-spotify" onclick="openInSpotify()" style="margin-bottom: 0.5rem;">ðŸŽµ Open in Spotify</button>
                <button class="btn btn-apple-music" onclick="openInAppleMusic()" style="margin-bottom: 0.5rem;">ðŸŽµ Open in Apple Music</button>
                <button class="btn btn-youtube-music" onclick="openInYouTubeMusic()">ðŸŽµ Open in YouTube Music</button>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('createPostModal')">&times;</button>
            <h2>Share Music</h2>
            <p>Share a song with your friends</p>
            
            <div class="create-post-form">
                <div class="form-group">
                    <label for="postTrackUrl">Music Link</label>
                    <input type="text" id="postTrackUrl" placeholder="Paste Spotify, Apple Music, or YouTube Music link..." class="form-input">
                    <small>Paste a link to any song from Spotify, Apple Music, or YouTube Music</small>
                </div>
                
                <div class="form-group">
                    <label for="postCaption">Caption (Optional)</label>
                    <textarea id="postCaption" placeholder="What's on your mind about this song?" class="form-textarea" maxlength="500"></textarea>
                    <small><span id="captionCount">0</span>/500 characters</small>
                </div>
                
                <div class="form-group">
                    <label for="postPrivacy">Privacy</label>
                    <select id="postPrivacy" class="form-select">
                        <option value="friends">Friends Only</option>
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                
                <div class="post-preview" id="postPreview" style="display: none;">
                    <h4>Preview</h4>
                    <div class="preview-track">
                        <div class="preview-artwork" id="previewArtwork">ðŸŽµ</div>
                        <div class="preview-info">
                            <h5 id="previewTitle">Track Title</h5>
                            <p id="previewArtist">Artist Name</p>
                        </div>
                    </div>
                    <p id="previewCaption" class="preview-caption"></p>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('createPostModal')">Cancel</button>
                    <button class="btn btn-primary" id="createPostSubmitBtn" onclick="createPost()" disabled>Share Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('commentsModal')">&times;</button>
            <h2>Comments</h2>
            
            <div class="comments-container">
                <div class="comments-list" id="commentsList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Loading comments...</p>
                    </div>
                </div>
                
                <div class="add-comment" id="addCommentSection" style="display: none;">
                    <div class="comment-form">
                        <textarea id="newCommentText" placeholder="Write a comment..." class="comment-textarea" maxlength="1000"></textarea>
                        <div class="comment-actions">
                            <small><span id="commentCharCount">0</span>/1000 characters</small>
                            <button class="btn btn-primary" id="submitCommentBtn" onclick="submitComment()" disabled>Post Comment</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Playlist Create Modal -->
    <div id="playlistCreateModal" class="playlist-create-modal">
        <div class="playlist-create-form">
            <h2>Create New Playlist</h2>
            <form id="playlistCreateForm">
                <div class="playlist-form-group">
                    <label for="playlistName">Playlist Name</label>
                    <input type="text" id="playlistName" class="playlist-form-input" placeholder="My Awesome Playlist" required>
                </div>
                
                <div class="playlist-form-group">
                    <label for="playlistDescription">Description (Optional)</label>
                    <textarea id="playlistDescription" class="playlist-form-textarea" placeholder="Describe your playlist..."></textarea>
                </div>
                
                <div class="playlist-form-group">
                    <label for="playlistPrivacy">Privacy</label>
                    <select id="playlistPrivacy" class="playlist-form-input">
                        <option value="private">Private</option>
                        <option value="friends">Friends Only</option>
                        <option value="public">Public</option>
                    </select>
                </div>
                
                <div class="playlist-form-group">
                    <label for="playlistCollaborative">Collaborative</label>
                    <select id="playlistCollaborative" class="playlist-form-input">
                        <option value="false">No</option>
                        <option value="true">Yes - Friends can add tracks</option>
                    </select>
                </div>
                
                <div class="playlist-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePlaylistCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Playlist</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Playlist View Modal -->
    <div id="playlistViewModal" class="playlist-create-modal">
        <div class="playlist-create-form" style="max-width: 800px;">
            <div class="playlist-header">
                <div class="playlist-info">
                    <div class="playlist-artwork" id="playlistViewArtwork">
                        ðŸŽµ
                    </div>
                    <div class="playlist-details">
                        <h1 id="playlistViewName">Playlist Name</h1>
                        <div class="playlist-meta">
                            <span id="playlistViewMeta">0 tracks â€¢ Created by You</span>
                        </div>
                    </div>
                </div>
                <div class="playlist-actions">
                    <button class="btn btn-primary" onclick="playPlaylist()">Play All</button>
                    <button class="btn btn-secondary" onclick="closePlaylistViewModal()">Close</button>
                </div>
            </div>
            
            <div class="playlist-tracks">
                <div class="track-list" id="playlistTrackList">
                    <!-- Tracks will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Group Create Modal -->
    <div id="groupCreateModal" class="group-create-modal">
        <div class="group-create-form">
            <h2>Create Music Group</h2>
            <form id="groupCreateForm">
                <div class="group-form-group">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" class="group-form-input" placeholder="My Music Group" required>
                </div>
                
                <div class="group-form-group">
                    <label for="groupDescription">Description</label>
                    <textarea id="groupDescription" class="group-form-textarea" placeholder="Describe your group's music focus..."></textarea>
                </div>
                
                <div class="group-form-group">
                    <label for="groupType">Group Type</label>
                    <select id="groupType" class="group-form-input">
                        <option value="genre">Genre Community</option>
                        <option value="artist">Artist Fan Club</option>
                        <option value="local">Local Music Scene</option>
                        <option value="general">General Music Discussion</option>
                    </select>
                </div>
                
                <div class="group-form-group">
                    <label for="groupGenre">Primary Genre (if applicable)</label>
                    <select id="groupGenre" class="group-form-input">
                        <option value="">Select Genre</option>
                        <option value="pop">Pop</option>
                        <option value="rock">Rock</option>
                        <option value="hip-hop">Hip-Hop</option>
                        <option value="electronic">Electronic</option>
                        <option value="country">Country</option>
                        <option value="jazz">Jazz</option>
                        <option value="classical">Classical</option>
                        <option value="indie">Indie</option>
                    </select>
                </div>
                
                <div class="group-form-group">
                    <label for="groupPrivacy">Privacy</label>
                    <select id="groupPrivacy" class="group-form-input">
                        <option value="public">Public - Anyone can join</option>
                        <option value="private">Private - Invite only</option>
                        <option value="restricted">Restricted - Approval required</option>
                    </select>
                </div>
                
                <div class="group-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGroupCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Challenge Create Modal -->
    <div id="challengeCreateModal" class="challenge-create-modal">
        <div class="challenge-create-form">
            <h2>Create Music Challenge</h2>
            <form id="challengeCreateForm">
                <div class="challenge-form-group">
                    <label for="challengeName">Challenge Name</label>
                    <input type="text" id="challengeName" class="challenge-form-input" placeholder="My Music Challenge" required>
                </div>
                
                <div class="challenge-form-group">
                    <label for="challengeDescription">Description</label>
                    <textarea id="challengeDescription" class="challenge-form-textarea" placeholder="Describe your challenge..."></textarea>
                </div>
                
                <div class="challenge-form-group">
                    <label for="challengeType">Challenge Type</label>
                    <select id="challengeType" class="challenge-form-input">
                        <option value="listening">Listening Challenge</option>
                        <option value="discovery">Discovery Challenge</option>
                        <option value="sharing">Sharing Challenge</option>
                        <option value="playlist">Playlist Challenge</option>
                        <option value="genre">Genre Challenge</option>
                    </select>
                </div>
                
                <div class="challenge-form-group">
                    <label for="challengeDuration">Duration</label>
                    <select id="challengeDuration" class="challenge-form-input">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="challenge-form-group">
                    <label for="challengeGoal">Goal (e.g., 10 songs, 5 hours, etc.)</label>
                    <input type="text" id="challengeGoal" class="challenge-form-input" placeholder="10 songs" required>
                </div>
                
                <div class="challenge-form-group">
                    <label for="challengeReward">Reward</label>
                    <input type="text" id="challengeReward" class="challenge-form-input" placeholder="Badge, Points, etc.">
                </div>
                
                <div class="challenge-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeChallengeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Challenge</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Create Modal -->
    <div id="eventCreateModal" class="event-create-modal">
        <div class="event-create-form">
            <h2>Create Music Event</h2>
            <form id="eventCreateForm">
                <div class="event-form-group">
                    <label for="eventName">Event Name</label>
                    <input type="text" id="eventName" class="event-form-input" placeholder="My Music Event" required>
                </div>
                
                <div class="event-form-group">
                    <label for="eventDescription">Description</label>
                    <textarea id="eventDescription" class="event-form-textarea" placeholder="Describe your event..."></textarea>
                </div>
                
                <div class="event-form-group">
                    <label for="eventType">Event Type</label>
                    <select id="eventType" class="event-form-input">
                        <option value="concert">Concert</option>
                        <option value="festival">Festival</option>
                        <option value="live-stream">Live Stream</option>
                        <option value="virtual-event">Virtual Event</option>
                        <option value="listening-party">Listening Party</option>
                        <option value="music-meetup">Music Meetup</option>
                    </select>
                </div>
                
                <div class="event-form-group">
                    <label for="eventDate">Event Date & Time</label>
                    <input type="datetime-local" id="eventDate" class="event-form-input" required>
                </div>
                
                <div class="event-form-group">
                    <label for="eventLocation">Location</label>
                    <input type="text" id="eventLocation" class="event-form-input" placeholder="Venue or Online" required>
                </div>
                
                <div class="event-form-group">
                    <label for="eventArtists">Featured Artists</label>
                    <input type="text" id="eventArtists" class="event-form-input" placeholder="Artist 1, Artist 2, Artist 3">
                </div>
                
                <div class="event-form-group">
                    <label for="eventGenre">Genre</label>
                    <select id="eventGenre" class="event-form-input">
                        <option value="all">All Genres</option>
                        <option value="pop">Pop</option>
                        <option value="rock">Rock</option>
                        <option value="hip-hop">Hip-Hop</option>
                        <option value="electronic">Electronic</option>
                        <option value="jazz">Jazz</option>
                        <option value="classical">Classical</option>
                        <option value="country">Country</option>
                        <option value="indie">Indie</option>
                    </select>
                </div>
                
                <div class="event-form-group">
                    <label for="eventCapacity">Capacity</label>
                    <input type="number" id="eventCapacity" class="event-form-input" placeholder="Maximum attendees" min="1">
                </div>
                
                <div class="event-form-group">
                    <label for="eventPrice">Price</label>
                    <input type="text" id="eventPrice" class="event-form-input" placeholder="Free, $20, etc.">
                </div>
                
                <div class="event-form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEventCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="notifications-modal">
        <div class="notifications-content">
            <div class="notifications-header">
                <h2>Notifications</h2>
                <button class="mark-all-read" onclick="markAllNotificationsRead()">Mark all read</button>
            </div>
            <div class="notifications-list" id="notificationsList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading notifications...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="close-btn" onclick="closeModal('editProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" class="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileDisplayName">Display Name</label>
                            <input type="text" id="profileDisplayName" name="display_name" maxlength="50" required>
                        </div>
                        <div class="form-group">
                            <label for="profileLocation">Location</label>
                            <input type="text" id="profileLocation" name="location" maxlength="100" placeholder="City, Country">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileBio">Bio</label>
                        <textarea id="profileBio" name="bio" maxlength="500" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileWebsite">Website</label>
                        <input type="url" id="profileWebsite" name="website" placeholder="https://yourwebsite.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="profileBirthDate">Birth Date</label>
                        <input type="date" id="profileBirthDate" name="birth_date">
                    </div>
                    
                    <div class="form-group">
                        <label for="profileAvatarUrl">Avatar URL</label>
                        <input type="url" id="profileAvatarUrl" name="avatar_url" placeholder="https://example.com/avatar.jpg">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal('editProfileModal')">Cancel</button>
                        <button type="submit" class="btn-save">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-sections">
                    <div class="settings-section">
                        <h3>Account</h3>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Email Notifications</h4>
                                <p>Receive email updates about your account</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Push Notifications</h4>
                                <p>Get notified about new likes and comments</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pushNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Privacy</h3>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Profile Visibility</h4>
                                <p>Who can see your profile</p>
                            </div>
                            <select id="profileVisibility" class="settings-select">
                                <option value="public">Public</option>
                                <option value="friends">Friends Only</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Show Email</h4>
                                <p>Display your email on your profile</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showEmail">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Music</h3>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Auto-share Listening</h4>
                                <p>Automatically share what you're listening to</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoShare">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-content">
                                <h4>Default Post Privacy</h4>
                                <p>Default privacy setting for new posts</p>
                            </div>
                            <select id="defaultPostPrivacy" class="settings-select">
                                <option value="public">Public</option>
                                <option value="friends">Friends Only</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="btn-save" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity History Modal -->
    <div id="activityHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Activity History</h2>
                <button class="close-btn" onclick="closeModal('activityHistoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="activity-filters">
                    <div class="filter-group">
                        <label for="activityType">Activity Type:</label>
                        <select id="activityType" onchange="filterActivityHistory()">
                            <option value="all">All Activity</option>
                            <option value="posts">Posts Created</option>
                            <option value="likes">Likes Given</option>
                            <option value="comments">Comments Made</option>
                            <option value="friends">Friends Added</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="activityPeriod">Time Period:</label>
                        <select id="activityPeriod" onchange="filterActivityHistory()">
                            <option value="all">All Time</option>
                            <option value="week">Past Week</option>
                            <option value="month">Past Month</option>
                            <option value="year">Past Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="activity-stats" id="activityStats" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number" id="postsCreated">0</span>
                            <span class="stat-label">Posts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="likesGiven">0</span>
                            <span class="stat-label">Likes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="commentsMade">0</span>
                            <span class="stat-label">Comments</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="friendsAdded">0</span>
                            <span class="stat-label">Friends</span>
                        </div>
                    </div>
                </div>
                
                <div class="activity-list" id="activityList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Music Analytics</h2>
                <button class="close-btn" onclick="closeModal('analyticsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="analytics-filters">
                    <div class="filter-group">
                        <label for="analyticsType">Analytics Type:</label>
                        <select id="analyticsType" onchange="loadAnalytics()">
                            <option value="overview">Overview</option>
                            <option value="genres">Genres</option>
                            <option value="artists">Artists</option>
                            <option value="trends">Trends</option>
                            <option value="social">Social</option>
                            <option value="listening_patterns">Listening Patterns</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="analyticsPeriod">Time Period:</label>
                        <select id="analyticsPeriod" onchange="loadAnalytics()">
                            <option value="7d">Past Week</option>
                            <option value="30d" selected>Past Month</option>
                            <option value="90d">Past 3 Months</option>
                            <option value="1y">Past Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="analytics-content" id="analyticsContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Loading analytics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Listening Insights Modal -->
    <div id="insightsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Your Listening Insights</h2>
                <button class="close-btn" onclick="closeModal('insightsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="insights-container">
                    <div class="insights-header">
                        <h1>Your Music Journey</h1>
                        <p>Discover your unique listening patterns, favorite artists, and musical evolution over time.</p>
                    </div>
                    
                    <div class="insights-filters">
                        <button class="insight-filter-btn active" data-period="30d" onclick="filterInsights('30d')">Last 30 Days</button>
                        <button class="insight-filter-btn" data-period="90d" onclick="filterInsights('90d')">Last 3 Months</button>
                        <button class="insight-filter-btn" data-period="1y" onclick="filterInsights('1y')">Last Year</button>
                        <button class="insight-filter-btn" data-period="all" onclick="filterInsights('all')">All Time</button>
                    </div>
                    
                    <div class="insights-grid" id="insightsGrid">
                        <!-- Insights will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGenre = 'all';
        let currentTrack = null;
        let searchDebounceTimer = null;
        let currentSearchQuery = '';
        let searchOffset = 0;
        let genreCache = {}; // Client-side cache for instant switching
        
        // Social Feed Variables
        let currentFeed = 'trending';
        let feedOffset = 0;
        let feedCache = {};
        let isSignedIn = false;
        let userToken = null;
        
        // Legacy variables for backward compatibility
        // TODO: Remove these after full migration to AuthService
        
        // Secure Authentication Service
        class AuthService {
            constructor() {
                this.isAuthenticated = false;
                this.user = null;
                this.csrfToken = null;
            }
            
            // Get CSRF token from meta tag (set by server)
            getCsrfToken() {
                if (!this.csrfToken) {
                    const metaTag = document.querySelector('meta[name="csrf-token"]');
                    this.csrfToken = metaTag ? metaTag.content : null;
                }
                return this.csrfToken;
            }
            
            // Make authenticated requests with proper headers
            async makeAuthenticatedRequest(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                // Add CSRF token if available
                const csrfToken = this.getCsrfToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }
                
                return fetch(url, {
                    ...options,
                    credentials: 'include', // Include httpOnly cookies
                    headers
                });
            }
            
            // Login with credentials
            async login(credentials) {
                try {
                    const response = await this.makeAuthenticatedRequest('/api/auth/login', {
                        method: 'POST',
                        body: JSON.stringify(credentials)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.isAuthenticated = true;
                        this.user = data.user;
                        
                        // Update legacy variables for backward compatibility
                        isSignedIn = true;
                        userToken = data.token; // Temporary until full migration
                        
                        return data;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Authentication failed');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    throw error;
                }
            }
            
            // Logout
            async logout() {
                try {
                    await this.makeAuthenticatedRequest('/api/auth/logout', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    // Clear state regardless of API response
                    this.isAuthenticated = false;
                    this.user = null;
                    this.csrfToken = null;
                    
                    // Update legacy variables
                    isSignedIn = false;
                    userToken = null;
                    
                    // Clear any stored data
                    localStorage.removeItem('trackshare_user');
                }
            }
            
            // Check authentication status
            async checkAuthStatus() {
                try {
                    const response = await this.makeAuthenticatedRequest('/api/auth/me');
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.isAuthenticated = true;
                        this.user = data.user;
                        
                        // Update legacy variables
                        isSignedIn = true;
                        userToken = data.token; // Temporary
                        
                        return true;
                    } else {
                        this.isAuthenticated = false;
                        this.user = null;
                        isSignedIn = false;
                        userToken = null;
                        return false;
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                    this.isAuthenticated = false;
                    this.user = null;
                    isSignedIn = false;
                    userToken = null;
                    return false;
                }
            }
            
            // Get current user
            getCurrentUser() {
                return this.user;
            }
            
            // Check if authenticated
            isAuth() {
                return this.isAuthenticated;
            }
        }
        
        // Global auth service instance
        const authService = new AuthService();
        
        // API Configuration
        const SYSTEM_USER_ID = '00000000-0000-0000-0000-000000000000';
        
        // Helper function to build API URLs (uses relative URLs)
        function apiUrl(endpoint) {
            return endpoint; // Just return the endpoint as-is for relative URLs
        }
        
        // Real-time Update Variables
        let notificationPollingInterval = null;
        let feedPollingInterval = null;
        let lastNotificationCheck = null;
        let lastFeedUpdate = null;
        let unreadNotificationCount = 0;
        
        // OAuth Client IDs
        const GOOGLE_CLIENT_ID = '150328378525-ldggejup0i37ntgo3954aatocrgtrada.apps.googleusercontent.com';
        const APPLE_CLIENT_ID = 'your.apple.client.id';

        // Real trending music data with working artwork URLs
        // Dynamic trending music - will be loaded from API
        let trendingMusic = {
            all: [],
            pop: [],
            rock: [],
            'hip-hop': [],
            country: [],
            electronic: []
        };
        
        let isLoadingTrending = false;
        
        // Fetch trending music from API
        async function fetchTrendingMusic() {
            if (isLoadingTrending) return;
            isLoadingTrending = true;
            
            try {
                // Calculate how many tracks to load based on screen size
                const tracksPerPage = calculateTracksPerPage();
                
                const response = await fetch(apiUrl(`/api/trending?genre=all&limit=${tracksPerPage}&offset=0`));
                const data = await response.json();
                
                if (data.success && data.tracks) {
                    // Store in cache for instant switching
                    genreCache.all = data.tracks;
                    displayTracks(data.tracks, data.hasMore);
                } else {
                    console.error('Failed to fetch trending music:', data.error);
                    showError('Failed to load trending music');
                }
            } catch (error) {
                console.error('Error fetching trending music:', error);
                showError('Network error loading music');
            } finally {
                isLoadingTrending = false;
            }
        }
        
        // Show fallback music if API fails
        function showFallbackMusic() {
            const fallbackTracks = [
                {
                    id: 'fallback1',
                    title: 'Popular Music',
                    artist: 'Various Artists',
                    genre: 'trending',
                    artwork: null,
                    url: 'https://open.spotify.com'
                }
            ];
            
            trendingMusic.all = fallbackTracks;
            trendingMusic.pop = fallbackTracks;
            trendingMusic.rock = fallbackTracks;
            trendingMusic['hip-hop'] = fallbackTracks;
            trendingMusic.country = fallbackTracks;
            trendingMusic.electronic = fallbackTracks;
            
            loadTrendingMusic(currentGenre);
        }

        function calculateTracksPerPage() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // Calculate tracks per row based on screen width
            let tracksPerRow;
            if (screenWidth < 576) {
                tracksPerRow = 1; // Mobile
            } else if (screenWidth < 768) {
                tracksPerRow = 2; // Large mobile
            } else if (screenWidth < 992) {
                tracksPerRow = 3; // Tablet
            } else if (screenWidth < 1200) {
                tracksPerRow = 4; // Desktop
            } else {
                tracksPerRow = 5; // Large desktop
            }
            
            // Calculate how many rows fit on screen
            // Each track card is approximately 300px tall (200px artwork + 100px info)
            const trackHeight = 300;
            const availableHeight = screenHeight - 400; // Account for header, search, tabs
            const rowsPerScreen = Math.max(2, Math.floor(availableHeight / trackHeight));
            
            // Return tracks per page (ensure minimum of 12)
            return Math.max(12, tracksPerRow * rowsPerScreen);
        }

        // Social Feed Functions
        async function switchFeed(feedType) {
            currentFeed = feedType;
            
            // Check if this is an authenticated-only tab
            const authOnlyTabs = ['friends', 'groups', 'challenges', 'events', 'analytics', 'achievements', 'requests', 'profile'];
            if (authOnlyTabs.includes(feedType) && !isSignedIn) {
                showSignInModal();
                return;
            }
            
            // Close Advanced Filters panel when switching sections
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters) {
                advancedFilters.style.display = 'none';
            }
            
            // Update tab visual state
            document.querySelectorAll('.feed-tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-feed="${feedType}"]`).classList.add('active');
            
            // Show/hide appropriate sections
            const socialFeed = document.getElementById('socialFeed');
            const musicDiscovery = document.getElementById('musicDiscovery');
            const musicGroups = document.getElementById('musicGroups');
            const musicChallenges = document.getElementById('musicChallenges');
            const musicEvents = document.getElementById('musicEvents');
            const playlistAnalytics = document.getElementById('playlistAnalytics');
            const musicAchievements = document.getElementById('musicAchievements');
            
            if (feedType === 'discover') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'block';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                musicAchievements.style.display = 'none';
                // Load music discovery if not already loaded
                if (!genreCache.all || genreCache.all.length === 0) {
                    await fetchTrendingMusic();
                }
            } else if (feedType === 'groups') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'block';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await loadGroups();
            } else if (feedType === 'challenges') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'block';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await loadChallenges();
            } else if (feedType === 'events') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'block';
                playlistAnalytics.style.display = 'none';
                await loadEvents();
            } else if (feedType === 'analytics') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'block';
                musicAchievements.style.display = 'none';
                await loadPlaylistAnalytics();
            } else if (feedType === 'achievements') {
                socialFeed.style.display = 'none';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                musicAchievements.style.display = 'block';
                await loadAchievements();
            } else if (feedType === 'friends') {
                socialFeed.style.display = 'block';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await displayFriends();
            } else if (feedType === 'requests') {
                socialFeed.style.display = 'block';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await displayFriendRequests();
            } else if (feedType === 'profile') {
                socialFeed.style.display = 'block';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await loadProfileData();
            } else {
                socialFeed.style.display = 'block';
                musicDiscovery.style.display = 'none';
                musicGroups.style.display = 'none';
                musicChallenges.style.display = 'none';
                musicEvents.style.display = 'none';
                playlistAnalytics.style.display = 'none';
                await loadFeed(feedType);
            }
        }

        // Display friends list
        async function displayFriends() {
            const feedContainer = document.querySelector('#socialFeed .container');
            const loadingSpinner = document.getElementById('feedLoading');
            
            loadingSpinner.style.display = 'flex';
            
            try {
                const friendsData = await loadFriendsData();
                const friends = friendsData.friends || [];
                
                loadingSpinner.style.display = 'none';
                
                if (friends.length === 0) {
                    feedContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ‘¥</div>
                            <h3>No Friends Yet</h3>
                            <p>Start connecting with people who share your music taste!</p>
                            <button class="btn btn-primary" onclick="switchFeed('requests')">Find Friends</button>
                        </div>
                    `;
                    return;
                }
                
                const friendsHTML = friends.map(friend => `
                    <div class="friend-item">
                        <div class="friend-avatar">
                            ${friend.friend?.display_name?.charAt(0) || 'ðŸŽµ'}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${escapeHtml(friend.friend?.display_name || 'Unknown')}</div>
                            <div class="friend-status">Friends since ${formatTimeAgo(friend.created_at)}</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn btn-remove" onclick="removeFriend('${friend.friend?.id}')">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
                
                feedContainer.innerHTML = `
                    <div class="friends-container">
                        <h2 class="section-title">Your Friends (${friends.length})</h2>
                        <div class="friends-section">
                            ${friendsHTML}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error displaying friends:', error);
                loadingSpinner.style.display = 'none';
                feedContainer.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">âš ï¸</div>
                        <h3>Error Loading Friends</h3>
                        <p>Something went wrong. Please try again.</p>
                        <button class="btn btn-primary" onclick="displayFriends()">Retry</button>
                    </div>
                `;
            }
        }

        // Display friend requests
        async function displayFriendRequests() {
            const feedContainer = document.querySelector('#socialFeed .container');
            const loadingSpinner = document.getElementById('feedLoading');
            
            loadingSpinner.style.display = 'flex';
            
            try {
                const friendsData = await loadFriendsData();
                const requests = friendsData.requests || [];
                const suggestions = friendsData.suggestions || [];
                
                loadingSpinner.style.display = 'none';
                
                let requestsHTML = '';
                let suggestionsHTML = '';
                
                if (requests.length > 0) {
                    requestsHTML = `
                        <div class="friends-section">
                            <h3>Friend Requests (${requests.length})</h3>
                            ${requests.map(request => `
                                <div class="friend-item">
                                    <div class="friend-avatar">
                                        ${request.requester?.display_name?.charAt(0) || 'ðŸŽµ'}
                                    </div>
                                    <div class="friend-info">
                                        <div class="friend-name">${escapeHtml(request.requester?.display_name || 'Unknown')}</div>
                                        <div class="friend-status">Wants to be friends</div>
                                    </div>
                                    <div class="friend-actions">
                                        <button class="friend-action-btn btn-accept" onclick="respondToFriendRequest('${request.id}', 'accept')">
                                            Accept
                                        </button>
                                        <button class="friend-action-btn btn-decline" onclick="respondToFriendRequest('${request.id}', 'decline')">
                                            Decline
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="friends-section">
                            <h3>Suggested Friends</h3>
                            <div class="suggestions-grid">
                                ${suggestions.map(suggestion => `
                                    <div class="suggestion-item">
                                        <div class="suggestion-avatar">
                                            ${suggestion.display_name?.charAt(0) || 'ðŸŽµ'}
                                        </div>
                                        <div class="suggestion-name">${escapeHtml(suggestion.display_name || 'Unknown')}</div>
                                        <button class="btn btn-primary" onclick="sendFriendRequest('${suggestion.id}')">
                                            Add Friend
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (requests.length === 0 && suggestions.length === 0) {
                    feedContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“¬</div>
                            <h3>No Requests</h3>
                            <p>No pending friend requests or suggestions at the moment.</p>
                        </div>
                    `;
                } else {
                    feedContainer.innerHTML = `
                        <div class="friends-container">
                            <h2 class="section-title">Friend Requests</h2>
                            ${requestsHTML}
                            ${suggestionsHTML}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error displaying friend requests:', error);
                loadingSpinner.style.display = 'none';
                feedContainer.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">âš ï¸</div>
                        <h3>Error Loading Requests</h3>
                        <p>Something went wrong. Please try again.</p>
                        <button class="btn btn-primary" onclick="displayFriendRequests()">Retry</button>
                    </div>
                `;
            }
        }

        async function loadFeed(feedType) {
            const feedContainer = document.querySelector('#socialFeed .container');
            const loadingSpinner = document.getElementById('feedLoading');
            
            // Add null checks for DOM elements
            if (!feedContainer) {
                console.warn('Feed container not found, skipping feed load');
                return;
            }
            
            if (!loadingSpinner) {
                console.warn('Loading spinner not found, skipping feed load');
                return;
            }
            
            // Show loading
            loadingSpinner.style.display = 'flex';
            
            try {
                // Check cache first
                if (feedCache[feedType]) {
                    displayFeed(feedCache[feedType]);
                    loadingSpinner.style.display = 'none';
                    return;
                }
                
                // Fetch from API
                let response;
                if (feedType === 'trending') {
                    // Use trending API directly for trending content
                    response = await fetch(apiUrl(`/api/trending?genre=all&limit=20&offset=0`));
                } else {
                    // Use posts API for other feed types
                    response = await fetch(apiUrl(`/api/posts?type=${feedType}&limit=20&offset=0`));
                }
                const data = await response.json();
                
                if (data.success) {
                    let feedData;
                    if (feedType === 'trending' && data.tracks && data.tracks.length > 0) {
                        // Convert tracks to posts format for display
                        feedData = data.tracks.map(track => ({
                            id: track.id || Math.random().toString(36).substr(2, 9),
                            user_id: SYSTEM_USER_ID,
                            track_title: track.title,
                            track_artist: track.artist,
                            track_album: track.album,
                            track_artwork_url: track.artwork_url,
                            track_spotify_url: track.spotify_url,
                            caption: `Currently trending: ${track.title} by ${track.artist}`,
                            privacy: 'public',
                            like_count: Math.floor(Math.random() * 50),
                            comment_count: Math.floor(Math.random() * 10),
                            play_count: Math.floor(Math.random() * 100),
                            share_count: Math.floor(Math.random() * 20),
                            posted_at: new Date().toISOString(),
                            user: {
                                display_name: 'TrackShare',
                                avatar_url: 'https://via.placeholder.com/40'
                            }
                        }));
                    } else if (data.posts) {
                        feedData = data.posts;
                    } else {
                        throw new Error('No data received');
                    }
                    
                    feedCache[feedType] = feedData;
                    displayFeed(feedData);
                } else if (feedType === 'trending') {
                    // Fallback: Use search API to get trending content
                    console.log('Trending API returned empty, using search fallback');
                    try {
                        const fallbackResponse = await fetch(apiUrl('/api/search?q=popular&limit=20'));
                        const fallbackData = await fallbackResponse.json();
                        
                        if (fallbackData.success && fallbackData.tracks && fallbackData.tracks.length > 0) {
                            const feedData = fallbackData.tracks.map(track => ({
                                id: track.id || Math.random().toString(36).substr(2, 9),
                                user_id: SYSTEM_USER_ID,
                                track_title: track.title,
                                track_artist: track.artist,
                                track_album: track.album,
                                track_artwork_url: track.artwork,
                                track_spotify_url: track.url,
                                caption: `Trending now: ${track.title} by ${track.artist}`,
                                privacy: 'public',
                                like_count: Math.floor(Math.random() * 50),
                                comment_count: Math.floor(Math.random() * 10),
                                play_count: Math.floor(Math.random() * 100),
                                share_count: Math.floor(Math.random() * 20),
                                posted_at: new Date().toISOString(),
                                user: {
                                    display_name: 'TrackShare',
                                    avatar_url: 'https://via.placeholder.com/40'
                                }
                            }));
                            
                            feedCache[feedType] = feedData;
                            displayFeed(feedData);
                        } else {
                            showFeedError('Failed to load trending content');
                        }
                    } catch (fallbackError) {
                        console.error('Fallback trending load error:', fallbackError);
                        showFeedError('Failed to load trending content');
                    }
                } else {
                    showFeedError('Failed to load feed');
                }
            } catch (error) {
                console.error('Feed load error:', error);
                showFeedError('Network error loading feed');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function displayFeed(posts) {
            const feedContainer = document.querySelector('#socialFeed .container');
            
            if (posts.length === 0) {
                // Safe DOM creation instead of innerHTML
                feedContainer.textContent = ''; // Clear safely
                
                const emptyState = window.SafeDOM.createElement('div', 'empty-state');
                const emptyIcon = window.SafeDOM.createElement('div', 'empty-icon', 'ðŸŽµ');
                const emptyTitle = window.SafeDOM.createElement('h3', '', 'No posts yet');
                const emptySubtitle = window.SafeDOM.createElement('p', '', 'Be the first to share some music!');
                
                window.SafeDOM.appendChildren(emptyState, [emptyIcon, emptyTitle, emptySubtitle]);
                feedContainer.appendChild(emptyState);
                
                a11y.announce('No posts available');
                return;
            }
            
            // Clear container safely
            feedContainer.textContent = '';
            
            // Announce loading
            a11y.announceLoading(`Loading ${posts.length} posts`);
            
            // Create posts using safe DOM methods
            posts.forEach((post, index) => {
                const feedPost = window.SafeDOM.createElement('div', 'feed-post');
                feedPost.setAttribute('data-post-id', post.id);
                feedPost.setAttribute('aria-label', `Post ${index + 1}: ${post.track_title || 'Track'} by ${post.track_artist || 'Unknown Artist'}`);
                feedPost.setAttribute('role', 'article');
                
                // Post header
                const postHeader = window.SafeDOM.createElement('div', 'post-header');
                const postAvatar = window.SafeDOM.createElement('div', 'post-avatar', 
                    post.profiles?.display_name?.charAt(0) || 'ðŸŽµ');
                postAvatar.setAttribute('aria-label', `Avatar for ${post.profiles?.display_name || 'User'}`);
                
                const postUserInfo = window.SafeDOM.createElement('div', 'post-user-info');
                const userName = window.SafeDOM.createElement('h4', '', 
                    post.profiles?.display_name || 'TrackShare Official');
                const postTime = window.SafeDOM.createElement('p', '', formatTimeAgo(post.posted_at));
                
                window.SafeDOM.appendChildren(postUserInfo, [userName, postTime]);
                window.SafeDOM.appendChildren(postHeader, [postAvatar, postUserInfo]);
                
                // Post content
                const postContent = window.SafeDOM.createElement('div', 'post-content');
                const postTrack = window.SafeDOM.createElement('div', 'post-track');
                
                // Track artwork
                const trackArtwork = window.SafeDOM.createElement('div', 'post-track-artwork');
                if (post.track_artwork_url) {
                    const artworkImg = document.createElement('img');
                    artworkImg.src = post.track_artwork_url;
                    artworkImg.alt = `${post.track_title || 'Track'} artwork`;
                    artworkImg.loading = 'lazy';
                    trackArtwork.appendChild(artworkImg);
                } else {
                    trackArtwork.textContent = 'ðŸŽµ';
                    trackArtwork.setAttribute('aria-label', 'No artwork available');
                }
                
                // Track info
                const trackInfo = window.SafeDOM.createElement('div', 'post-track-info');
                const trackTitle = window.SafeDOM.createElement('h5', '', post.track_title || '');
                const trackArtist = window.SafeDOM.createElement('p', '', post.track_artist || '');
                
                window.SafeDOM.appendChildren(trackInfo, [trackTitle, trackArtist]);
                window.SafeDOM.appendChildren(postTrack, [trackArtwork, trackInfo]);
                
                // Post caption
                if (post.caption) {
                    const postCaption = window.SafeDOM.createElement('div', 'post-caption', post.caption);
                    postCaption.setAttribute('aria-label', `Caption: ${post.caption}`);
                    window.SafeDOM.appendChildren(postContent, [postTrack, postCaption]);
                } else {
                    postContent.appendChild(postTrack);
                }
                
                // Post actions
                const postActions = window.SafeDOM.createElement('div', 'post-actions');
                postActions.setAttribute('role', 'toolbar');
                postActions.setAttribute('aria-label', 'Post actions');
                
                const actionsLeft = window.SafeDOM.createElement('div', 'post-actions-left');
                
                // Like button
                const likeButton = window.SafeDOM.createElement('button', `post-action ${post.is_liked ? 'liked' : ''}`);
                likeButton.onclick = function() { toggleLike(post.id); };
                likeButton.setAttribute('aria-label', `${post.is_liked ? 'Unlike' : 'Like'} this post`);
                likeButton.setAttribute('aria-pressed', post.is_liked ? 'true' : 'false');
                
                const likeIcon = window.SafeDOM.createElement('span', '', post.is_liked ? 'â¤ï¸' : 'ðŸ¤');
                const likeCount = window.SafeDOM.createElement('span', '', (post.like_count || 0).toString());
                window.SafeDOM.appendChildren(likeButton, [likeIcon, likeCount]);
                
                // Comment button
                const commentButton = window.SafeDOM.createElement('button', 'post-action');
                commentButton.onclick = function() { showComments(post.id); };
                commentButton.setAttribute('aria-label', `View comments (${post.comment_count || 0})`);
                
                const commentIcon = window.SafeDOM.createElement('span', '', 'ðŸ’¬');
                const commentCount = window.SafeDOM.createElement('span', '', (post.comment_count || 0).toString());
                window.SafeDOM.appendChildren(commentButton, [commentIcon, commentCount]);
                
                // Share button
                const shareButton = window.SafeDOM.createElement('button', 'post-action');
                shareButton.onclick = function() { sharePost(post.id); };
                shareButton.setAttribute('aria-label', `Share this post (${post.share_count || 0} shares)`);
                
                const shareIcon = window.SafeDOM.createElement('span', '', 'ðŸ“¤');
                const shareCount = window.SafeDOM.createElement('span', '', (post.share_count || 0).toString());
                window.SafeDOM.appendChildren(shareButton, [shareIcon, shareCount]);
                
                window.SafeDOM.appendChildren(actionsLeft, [likeButton, commentButton, shareButton]);
                
                // Play & Share button
                const playShareButton = window.SafeDOM.createElement('button', 'post-action-btn', 'Play & Share');
                playShareButton.onclick = function() {
                    playTrack(post.track_spotify_url, post.track_title, post.track_artist);
                };
                playShareButton.setAttribute('aria-label', `Play ${post.track_title || 'track'} by ${post.track_artist || 'artist'}`);
                
                window.SafeDOM.appendChildren(postActions, [actionsLeft, playShareButton]);
                
                // Assemble post
                window.SafeDOM.appendChildren(feedPost, [postHeader, postContent, postActions]);
                feedContainer.appendChild(feedPost);
            });
            
            // Announce completion
            a11y.announceLoaded(`${posts.length} posts loaded`);
            
            // Add ARIA labels to new content
            a11y.addAriaLabels();
        }

        function showFeedError(message) {
            const feedContainer = document.querySelector('#socialFeed .container');
            feedContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        async function toggleLike(postId) {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            const likeButton = postElement.querySelector('.post-action');
            const likeCount = likeButton.querySelector('span:last-child');
            const likeIcon = likeButton.querySelector('span:first-child');
            const isLiked = likeButton.classList.contains('liked');
            const currentCount = parseInt(likeCount.textContent) || 0;
            
            // Optimistic UI update
            if (isLiked) {
                likeButton.classList.remove('liked');
                likeIcon.textContent = 'ðŸ¤';
                likeCount.textContent = Math.max(0, currentCount - 1);
            } else {
                likeButton.classList.add('liked');
                likeIcon.textContent = 'â¤ï¸';
                likeCount.textContent = currentCount + 1;
            }
            
            try {
                if (isLiked) {
                    // Unlike
                    const response = await fetch(`/api/posts?engagement_type=1&post_id=${postId}&type=like`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        // Revert optimistic update on error
                        likeButton.classList.add('liked');
                        likeIcon.textContent = 'â¤ï¸';
                        likeCount.textContent = currentCount;
                        showNotification('Failed to unlike post', 'error');
                    }
                } else {
                    // Like
                    const response = await fetch('/api/posts?engagement_type=1', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            post_id: postId,
                            type: 'like'
                        })
                    });
                    
                    if (!response.ok) {
                        // Revert optimistic update on error
                        likeButton.classList.remove('liked');
                        likeIcon.textContent = 'ðŸ¤';
                        likeCount.textContent = currentCount;
                        showNotification('Failed to like post', 'error');
                    }
                }
            } catch (error) {
                console.error('Like toggle error:', error);
                // Revert optimistic update on error
                if (isLiked) {
                    likeButton.classList.add('liked');
                    likeIcon.textContent = 'â¤ï¸';
                    likeCount.textContent = currentCount;
                } else {
                    likeButton.classList.remove('liked');
                    likeIcon.textContent = 'ðŸ¤';
                    likeCount.textContent = currentCount;
                }
                showNotification('Network error', 'error');
            }
        }

        function showComments(postId) {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            currentPostId = postId;
            document.getElementById('commentsModal').style.display = 'flex';
            
            // Load comments
            loadComments(postId);
            
            // Setup comment form
            setupCommentForm();
        }

        let currentPostId = null;

        async function loadComments(postId) {
            const commentsList = document.getElementById('commentsList');
            
            try {
                const response = await fetch(`/api/posts?engagement_type=1&post_id=${postId}&type=comments`);
                const data = await response.json();
                
                if (data.success && data.comments) {
                    displayComments(data.comments);
                } else {
                    showNoComments();
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                showCommentsError();
            }
        }

        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                showNoComments();
                return;
            }
            
            const commentsHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-avatar">
                        ${comment.profiles?.display_name?.charAt(0) || 'ðŸŽµ'}
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(comment.profiles?.display_name || 'Anonymous')}</span>
                            <span class="comment-time">${formatTimeAgo(comment.created_at)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.content)}</div>
                    </div>
                </div>
            `).join('');
            
            commentsList.innerHTML = commentsHTML;
            
            // Show add comment section
            document.getElementById('addCommentSection').style.display = 'block';
        }

        function showNoComments() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = `
                <div class="no-comments">
                    <div class="empty-icon">ðŸ’¬</div>
                    <h4>No comments yet</h4>
                    <p>Be the first to comment!</p>
                </div>
            `;
            
            // Show add comment section
            document.getElementById('addCommentSection').style.display = 'block';
        }

        function showCommentsError() {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = `
                <div class="no-comments">
                    <div class="empty-icon">âš ï¸</div>
                    <h4>Error loading comments</h4>
                    <p>Please try again later</p>
                </div>
            `;
        }

        function setupCommentForm() {
            const commentTextarea = document.getElementById('newCommentText');
            const charCount = document.getElementById('commentCharCount');
            const submitBtn = document.getElementById('submitCommentBtn');
            
            // Character count
            commentTextarea.addEventListener('input', (e) => {
                const count = e.target.value.length;
                charCount.textContent = count;
                
                if (count > 1000) {
                    charCount.style.color = '#ef4444';
                } else {
                    charCount.style.color = '#6b7280';
                }
                
                // Enable/disable submit button
                submitBtn.disabled = count === 0 || count > 1000;
            });
            
            // Handle Enter key (Ctrl+Enter to submit)
            commentTextarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    if (!submitBtn.disabled) {
                        submitComment();
                    }
                }
            });
        }

        async function submitComment() {
            if (!isSignedIn || !userToken || !currentPostId) {
                return;
            }
            
            const commentText = document.getElementById('newCommentText').value.trim();
            if (!commentText) {
                return;
            }
            
            const submitBtn = document.getElementById('submitCommentBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Posting...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/posts?engagement_type=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        post_id: currentPostId,
                        type: 'comment',
                        content: commentText
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear form
                    document.getElementById('newCommentText').value = '';
                    document.getElementById('commentCharCount').textContent = '0';
                    
                    // Reload comments
                    await loadComments(currentPostId);
                    
                    // Update comment count in feed
                    updateCommentCountInFeed(currentPostId);
                    
                    showNotification('Comment posted!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to post comment');
                }
                
            } catch (error) {
                console.error('Error posting comment:', error);
                showNotification('Failed to post comment. Please try again.', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function updateCommentCountInFeed(postId) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            if (postElement) {
                const commentButton = postElement.querySelector('.post-action:nth-child(2)');
                const commentCount = commentButton.querySelector('span:last-child');
                const currentCount = parseInt(commentCount.textContent);
                commentCount.textContent = currentCount + 1;
            }
        }

        // Friends Functions
        async function loadFriendsData(type) {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }

            const feedContainer = document.querySelector('#socialFeed .container');
            const loadingSpinner = document.getElementById('feedLoading');
            
            // Show loading
            loadingSpinner.style.display = 'flex';
            
            try {
                const response = await fetch(`/api/friends?type=${type}`);
                const data = await response.json();
                
                if (data.success) {
                    if (type === 'friends') {
                        displayFriends(data.friends);
                    } else if (type === 'requests') {
                        displayFriendRequests(data.pendingSent, data.pendingReceived);
                    }
                } else {
                    showFriendsError('Failed to load friends data');
                }
            } catch (error) {
                console.error('Friends load error:', error);
                showFriendsError('Network error loading friends');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function displayFriends(friends) {
            const feedContainer = document.querySelector('#socialFeed .container');
            
            if (!friends || friends.length === 0) {
                feedContainer.innerHTML = `
                    <div class="no-friends">
                        <div class="empty-icon">ðŸ‘¥</div>
                        <h4>No friends yet</h4>
                        <p>Start connecting with people to see their music posts!</p>
                        <button class="btn btn-primary" onclick="switchFeed('requests')">Find Friends</button>
                    </div>
                `;
                return;
            }
            
            const friendsHTML = friends.map(friend => `
                <div class="friend-item">
                    <div class="friend-avatar">
                        ${friend.friend?.display_name?.charAt(0) || 'ðŸŽµ'}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(friend.friend?.display_name || 'Unknown')}</div>
                        <div class="friend-status">Friends since ${formatTimeAgo(friend.created_at)}</div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-action-btn btn-remove" onclick="removeFriend('${friend.id}')">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
            
            feedContainer.innerHTML = `
                <div class="friends-container">
                    <div class="friends-section">
                        <h3>Your Friends (${friends.length})</h3>
                        ${friendsHTML}
                    </div>
                </div>
            `;
        }

        function displayFriendRequests(sentRequests, receivedRequests) {
            const feedContainer = document.querySelector('#socialFeed .container');
            
            let requestsHTML = '';
            
            if (receivedRequests && receivedRequests.length > 0) {
                requestsHTML += `
                    <div class="friends-section">
                        <h3>Friend Requests <span class="request-badge">${receivedRequests.length}</span></h3>
                        ${receivedRequests.map(request => `
                            <div class="friend-item">
                                <div class="friend-avatar">
                                    ${request.user?.display_name?.charAt(0) || 'ðŸŽµ'}
                                </div>
                                <div class="friend-info">
                                    <div class="friend-name">${escapeHtml(request.user?.display_name || 'Unknown')}</div>
                                    <div class="friend-status">Wants to be friends</div>
                                </div>
                                <div class="friend-actions">
                                    <button class="friend-action-btn btn-accept" onclick="respondToFriendRequest('${request.id}', 'accept')">
                                        Accept
                                    </button>
                                    <button class="friend-action-btn btn-decline" onclick="respondToFriendRequest('${request.id}', 'decline')">
                                        Decline
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (sentRequests && sentRequests.length > 0) {
                requestsHTML += `
                    <div class="friends-section">
                        <h3>Sent Requests</h3>
                        ${sentRequests.map(request => `
                            <div class="friend-item">
                                <div class="friend-avatar">
                                    ${request.user?.display_name?.charAt(0) || 'ðŸŽµ'}
                                </div>
                                <div class="friend-info">
                                    <div class="friend-name">${escapeHtml(request.user?.display_name || 'Unknown')}</div>
                                    <div class="friend-status">Request sent ${formatTimeAgo(request.created_at)}</div>
                                </div>
                                <div class="friend-actions">
                                    <button class="friend-action-btn btn-remove" onclick="cancelFriendRequest('${request.id}')">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Add friend suggestions
            requestsHTML += `
                <div class="friends-section">
                    <h3>Suggestions</h3>
                    <div id="friendSuggestions">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Loading suggestions...</p>
                        </div>
                    </div>
                </div>
            `;
            
            feedContainer.innerHTML = `
                <div class="friends-container">
                    ${requestsHTML}
                </div>
            `;
            
            // Load friend suggestions
            loadFriendSuggestions();
        }

        async function loadFriendSuggestions() {
            try {
                const response = await fetch('/api/friends?type=suggestions');
                const data = await response.json();
                
                const suggestionsContainer = document.getElementById('friendSuggestions');
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    const suggestionsHTML = data.suggestions.map(user => `
                        <div class="suggestion-item">
                            <div class="suggestion-avatar">
                                ${user.display_name?.charAt(0) || 'ðŸŽµ'}
                            </div>
                            <div class="suggestion-name">${escapeHtml(user.display_name || 'Unknown')}</div>
                            <div class="suggestion-email">${escapeHtml(user.email || '')}</div>
                            <button class="friend-action-btn btn-add" onclick="sendFriendRequest('${user.id}')">
                                Add Friend
                            </button>
                        </div>
                    `).join('');
                    
                    suggestionsContainer.innerHTML = `
                        <div class="suggestions-grid">
                            ${suggestionsHTML}
                        </div>
                    `;
                } else {
                    suggestionsContainer.innerHTML = `
                        <div class="no-friends">
                            <div class="empty-icon">ðŸ‘¥</div>
                            <h4>No suggestions</h4>
                            <p>All users are already your friends or have pending requests!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
                document.getElementById('friendSuggestions').innerHTML = `
                    <div class="no-friends">
                        <div class="empty-icon">âš ï¸</div>
                        <h4>Error loading suggestions</h4>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }

        async function sendFriendRequest(userId) {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Friend request sent!', 'success');
                    // Reload suggestions
                    loadFriendSuggestions();
                } else {
                    throw new Error(data.error || 'Failed to send friend request');
                }
                
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Failed to send friend request. Please try again.', 'error');
            }
        }

        async function respondToFriendRequest(friendshipId, action) {
            if (!isSignedIn || !userToken) {
                return;
            }
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        friendship_id: friendshipId,
                        action: action
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Friend request ${action}ed!`, 'success');
                    // Reload requests
                    await loadFriendsData('requests');
                } else {
                    throw new Error(data.error || 'Failed to respond to friend request');
                }
                
            } catch (error) {
                console.error('Error responding to friend request:', error);
                showNotification('Failed to respond to friend request. Please try again.', 'error');
            }
        }

        async function cancelFriendRequest(friendshipId) {
            if (!isSignedIn || !userToken) {
                return;
            }
            
            try {
                const response = await fetch(`/api/friends?friendship_id=${friendshipId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Friend request cancelled!', 'success');
                    // Reload requests
                    await loadFriendsData('requests');
                } else {
                    throw new Error(data.error || 'Failed to cancel friend request');
                }
                
            } catch (error) {
                console.error('Error cancelling friend request:', error);
                showNotification('Failed to cancel friend request. Please try again.', 'error');
            }
        }

        async function removeFriend(friendshipId) {
            if (!isSignedIn || !userToken) {
                return;
            }
            
            if (!confirm('Are you sure you want to remove this friend?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/friends?friendship_id=${friendshipId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Friend removed!', 'success');
                    // Reload friends
                    await loadFriendsData('friends');
                } else {
                    throw new Error(data.error || 'Failed to remove friend');
                }
                
            } catch (error) {
                console.error('Error removing friend:', error);
                showNotification('Failed to remove friend. Please try again.', 'error');
            }
        }

        function showFriendsError(message) {
            const feedContainer = document.querySelector('#socialFeed .container');
            feedContainer.innerHTML = `
                <div class="no-friends">
                    <div class="empty-icon">âš ï¸</div>
                    <h4>Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }

        // Profile Functions
        async function loadProfileData() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            const feedContainer = document.querySelector('#socialFeed .container');
            const loadingSpinner = document.getElementById('feedLoading');
            
            // Show loading
            loadingSpinner.style.display = 'flex';
            
            try {
                const response = await fetch('/api/profile?include_stats=true&include_posts=true');
                const data = await response.json();
                
                if (data.success) {
                    displayProfile(data.profile, data.stats, data.posts);
                } else {
                    showProfileError('Failed to load profile');
                }
            } catch (error) {
                console.error('Profile load error:', error);
                showProfileError('Network error loading profile');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function displayProfile(profile, stats, posts) {
            const feedContainer = document.querySelector('#socialFeed .container');
            
            const profileHTML = `
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            ${profile.avatar_url ? 
                                `<img src="${profile.avatar_url}" alt="Profile Avatar">` :
                                profile.display_name?.charAt(0) || 'ðŸŽµ'
                            }
                        </div>
                        <div class="profile-name">${escapeHtml(profile.display_name || 'User')}</div>
                        ${profile.bio ? `<div class="profile-bio">${escapeHtml(profile.bio)}</div>` : ''}
                        
                        <div class="profile-meta">
                            ${profile.location ? `
                                <div class="profile-meta-item">
                                    <span>ðŸ“</span>
                                    <span>${escapeHtml(profile.location)}</span>
                                </div>
                            ` : ''}
                            ${profile.website ? `
                                <div class="profile-meta-item">
                                    <span>ðŸŒ</span>
                                    <a href="${profile.website}" target="_blank" rel="noopener">${escapeHtml(profile.website)}</a>
                                </div>
                            ` : ''}
                            <div class="profile-meta-item">
                                <span>ðŸ“…</span>
                                <span>Joined ${formatTimeAgo(profile.created_at)}</span>
                            </div>
                        </div>
                        
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="profile-stat-number">${stats?.total_posts || 0}</span>
                                <span class="profile-stat-label">Posts</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-number">${stats?.friends_count || 0}</span>
                                <span class="profile-stat-label">Friends</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-number">${stats?.public_posts || 0}</span>
                                <span class="profile-stat-label">Public</span>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="profile-action-btn btn-edit-profile" onclick="showEditProfileModal()">
                                âœï¸ Edit Profile
                            </button>
                            <button class="profile-action-btn btn-settings" onclick="showSettingsModal()">
                                âš™ï¸ Settings
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-content">
                        <div class="profile-main">
                            <h3>Recent Posts</h3>
                            ${posts && posts.length > 0 ? `
                                <div class="profile-posts-grid">
                                    ${posts.map(post => `
                                        <div class="profile-post-card">
                                            <div class="profile-post-artwork">
                                                ${post.track_artwork_url ? 
                                                    `<img src="${post.track_artwork_url}" alt="${post.track_title}">` :
                                                    'ðŸŽµ'
                                                }
                                            </div>
                                            <div class="profile-post-title">${escapeHtml(post.track_title)}</div>
                                            <div class="profile-post-artist">${escapeHtml(post.track_artist)}</div>
                                            <div class="profile-post-stats">
                                                <span>â¤ï¸ ${post.like_count || 0}</span>
                                                <span>ðŸ’¬ ${post.comment_count || 0}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="no-friends">
                                    <div class="empty-icon">ðŸŽµ</div>
                                    <h4>No posts yet</h4>
                                    <p>Start sharing your favorite music!</p>
                                    <button class="btn btn-primary" onclick="showCreatePostModal()">Share Music</button>
                                </div>
                            `}
                        </div>
                        
                        <div class="profile-sidebar">
                            <div class="profile-widget">
                                <h3>Music Preferences</h3>
                                <p>Customize your music taste and discover new genres.</p>
                                <button class="btn btn-secondary" onclick="showMusicPreferencesModal()">
                                    Edit Preferences
                                </button>
                            </div>
                            
                            <div class="profile-widget">
                                <h3>Privacy Settings</h3>
                                <p>Control who can see your posts and profile information.</p>
                                <button class="btn btn-secondary" onclick="showPrivacySettingsModal()">
                                    Privacy Settings
                                </button>
                            </div>
                            
                            <div class="profile-widget">
                                <h3>Activity History</h3>
                                <p>View your recent activity and engagement.</p>
                                <button class="btn btn-secondary" onclick="showActivityHistoryModal()">
                                    View Activity
                                </button>
                            </div>
                            
                            <div class="profile-widget">
                                <h3>Music Analytics</h3>
                                <p>Discover your music listening patterns and insights.</p>
                                <button class="btn btn-secondary" onclick="showAnalyticsModal()">
                                    View Analytics
                                </button>
                            </div>
                            
                            <div class="profile-widget">
                                <h3>Listening Insights</h3>
                                <p>Deep dive into your personal music journey and trends.</p>
                                <button class="btn btn-primary" onclick="showInsightsModal()">
                                    View Insights
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            feedContainer.innerHTML = profileHTML;
        }

        function showProfileError(message) {
            const feedContainer = document.querySelector('#socialFeed .container');
            feedContainer.innerHTML = `
                <div class="no-friends">
                    <div class="empty-icon">âš ï¸</div>
                    <h4>Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }

        function showEditProfileModal() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            // Load current profile data
            loadCurrentProfileData();
            
            // Show modal
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        async function loadCurrentProfileData() {
            try {
                const response = await fetch('/api/profile');
                const data = await response.json();
                
                if (data.success) {
                    const profile = data.profile;
                    
                    // Populate form fields
                    document.getElementById('profileDisplayName').value = profile.display_name || '';
                    document.getElementById('profileLocation').value = profile.location || '';
                    document.getElementById('profileBio').value = profile.bio || '';
                    document.getElementById('profileWebsite').value = profile.website || '';
                    document.getElementById('profileBirthDate').value = profile.birth_date || '';
                    document.getElementById('profileAvatarUrl').value = profile.avatar_url || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
                showNotification('Failed to load profile data', 'error');
            }
        }

        async function saveProfileChanges(event) {
            event.preventDefault();
            
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            const form = document.getElementById('editProfileForm');
            const formData = new FormData(form);
            
            const profileData = {
                display_name: formData.get('display_name'),
                location: formData.get('location'),
                bio: formData.get('bio'),
                website: formData.get('website'),
                birth_date: formData.get('birth_date'),
                avatar_url: formData.get('avatar_url')
            };

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Profile updated successfully!', 'success');
                    closeModal('editProfileModal');
                    
                    // Reload profile page if currently viewing it
                    if (currentFeed === 'profile') {
                        await loadProfileData();
                    }
                } else {
                    throw new Error(data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile. Please try again.', 'error');
            }
        }

        function showSettingsModal() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            // Load current settings
            loadCurrentSettings();
            
            // Show modal
            document.getElementById('settingsModal').style.display = 'flex';
        }

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/profile');
                const data = await response.json();
                
                if (data.success) {
                    const profile = data.profile;
                    const privacySettings = profile.privacy_settings || {};
                    
                    // Set privacy settings
                    document.getElementById('profileVisibility').value = privacySettings.profile_visibility || 'public';
                    document.getElementById('showEmail').checked = privacySettings.show_email || false;
                    document.getElementById('defaultPostPrivacy').value = privacySettings.default_post_privacy || 'friends';
                    
                    // Set notification settings (these would come from a separate settings API)
                    document.getElementById('emailNotifications').checked = true; // Default
                    document.getElementById('pushNotifications').checked = true; // Default
                    document.getElementById('autoShare').checked = false; // Default
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Failed to load settings', 'error');
            }
        }

        async function saveSettings() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            const settingsData = {
                privacy_settings: {
                    profile_visibility: document.getElementById('profileVisibility').value,
                    show_email: document.getElementById('showEmail').checked,
                    default_post_privacy: document.getElementById('defaultPostPrivacy').value,
                    allow_friend_requests: true, // Default
                    allow_messages: true // Default
                },
                music_preferences: {
                    auto_share: document.getElementById('autoShare').checked,
                    email_notifications: document.getElementById('emailNotifications').checked,
                    push_notifications: document.getElementById('pushNotifications').checked
                }
            };

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(settingsData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Settings saved successfully!', 'success');
                    closeModal('settingsModal');
                } else {
                    throw new Error(data.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Failed to save settings. Please try again.', 'error');
            }
        }

        function showMusicPreferencesModal() {
            // TODO: Implement music preferences modal
            alert('Music preferences feature coming soon!');
        }

        function showPrivacySettingsModal() {
            // TODO: Implement privacy settings modal
            alert('Privacy settings feature coming soon!');
        }

        function showActivityHistoryModal() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            // Show modal
            document.getElementById('activityHistoryModal').style.display = 'flex';
            
            // Load activity data
            loadActivityHistory();
        }

        async function loadActivityHistory() {
            const activityList = document.getElementById('activityList');
            const activityStats = document.getElementById('activityStats');
            
            // Show loading
            activityList.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading activity...</p>
                </div>
            `;
            
            try {
                const type = document.getElementById('activityType').value;
                const period = document.getElementById('activityPeriod').value;
                
                // Calculate date range
                let startDate = null;
                let endDate = null;
                
                if (period !== 'all') {
                    endDate = new Date();
                    switch (period) {
                        case 'week':
                            startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000);
                            break;
                        case 'year':
                            startDate = new Date(endDate.getTime() - 365 * 24 * 60 * 60 * 1000);
                            break;
                    }
                }
                
                const params = new URLSearchParams({
                    type: type,
                    limit: '50',
                    include_stats: 'true'
                });
                
                if (startDate) params.append('start_date', startDate.toISOString());
                if (endDate) params.append('end_date', endDate.toISOString());
                
                const response = await fetch(`/api/activity-history?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayActivityHistory(data.activities, data.stats);
                } else {
                    throw new Error(data.error || 'Failed to load activity');
                }
            } catch (error) {
                console.error('Error loading activity history:', error);
                activityList.innerHTML = `
                    <div class="no-activity">
                        <div class="empty-icon">âš ï¸</div>
                        <h4>Error</h4>
                        <p>Failed to load activity history</p>
                    </div>
                `;
            }
        }

        function displayActivityHistory(activities, stats) {
            const activityList = document.getElementById('activityList');
            const activityStats = document.getElementById('activityStats');
            
            // Show stats
            if (stats) {
                document.getElementById('postsCreated').textContent = stats.posts_created || 0;
                document.getElementById('likesGiven').textContent = stats.likes_given || 0;
                document.getElementById('commentsMade').textContent = stats.comments_made || 0;
                document.getElementById('friendsAdded').textContent = stats.friends_added || 0;
                activityStats.style.display = 'block';
            }
            
            // Display activities
            if (activities && activities.length > 0) {
                activityList.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${escapeHtml(activity.title)}</div>
                            <div class="activity-description">${escapeHtml(activity.description)}</div>
                            <div class="activity-time">${formatTimeAgo(activity.timestamp)}</div>
                            ${activity.metadata ? `
                                <div class="activity-metadata">
                                    ${activity.metadata.track_title ? `Track: ${escapeHtml(activity.metadata.track_title)}` : ''}
                                    ${activity.metadata.track_artist ? ` by ${escapeHtml(activity.metadata.track_artist)}` : ''}
                                    ${activity.metadata.content ? `Comment: "${escapeHtml(activity.metadata.content.substring(0, 100))}${activity.metadata.content.length > 100 ? '...' : ''}"` : ''}
                                    ${activity.metadata.friend_name ? `Friend: ${escapeHtml(activity.metadata.friend_name)}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                activityList.innerHTML = `
                    <div class="no-activity">
                        <div class="empty-icon">ðŸ“Š</div>
                        <h4>No Activity Found</h4>
                        <p>No activity matches your current filters.</p>
                    </div>
                `;
            }
        }

        function filterActivityHistory() {
            loadActivityHistory();
        }

        // Music Recommendations Functions
        async function loadRecommendations() {
            showLoadingIndicator();
            
            try {
                const headers = {};
                if (isSignedIn && userToken) {
                    headers['Authorization'] = `Bearer ${userToken}`;
                }
                
                const response = await fetch('/api/recommendations?limit=20', { headers });
                const data = await response.json();
                
                if (data.success && data.recommendations) {
                    displayRecommendations(data.recommendations);
                } else {
                    showError('Failed to load recommendations');
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                showError('Network error loading recommendations');
            } finally {
                hideLoadingIndicator();
            }
        }

        function displayRecommendations(recommendations) {
            const grid = document.getElementById('musicGrid');
            
            if (recommendations.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ’¡</div>
                        <h4>No Recommendations Yet</h4>
                        <p>Start liking and sharing music to get personalized recommendations!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = recommendations.map(rec => `
                <div class="track-card" data-track-id="${rec.id}">
                    <div class="track-artwork">
                        <img src="${rec.artwork}" 
                             alt="${rec.title}"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk11c2ljPC90ZXh0Pjwvc3ZnPg=='"
                             onload="this.classList.add('loaded')">
                        <div class="play-overlay">
                            <button class="play-button" onclick="playTrack('${escapeJs(rec.url)}', '${escapeJs(rec.title)}', '${escapeJs(rec.artist)}')">
                                â–¶ï¸
                            </button>
                        </div>
                    </div>
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(rec.title)}</div>
                        <div class="track-artist">${escapeHtml(rec.artist)}</div>
                        <div class="recommendation-reason">${escapeHtml(rec.recommendation_reason)}</div>
                        ${rec.popularity ? `<div class="track-popularity">${getPopularityBars(rec.popularity)}</div>` : ''}
                    </div>
                    <button class="track-action-btn" onclick="playTrack('${escapeJs(rec.url)}', '${escapeJs(rec.title)}', '${escapeJs(rec.artist)}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
        }

        // Playlist Functions
        async function loadPlaylists() {
            showLoadingIndicator();
            
            try {
                const headers = {};
                if (isSignedIn && userToken) {
                    headers['Authorization'] = `Bearer ${userToken}`;
                }
                
                const response = await fetch('/api/playlists?limit=20', { headers });
                const data = await response.json();
                
                if (data.success && data.playlists) {
                    displayPlaylists(data.playlists);
                } else {
                    showError('Failed to load playlists');
                }
            } catch (error) {
                console.error('Error loading playlists:', error);
                showError('Network error loading playlists');
            } finally {
                hideLoadingIndicator();
            }
        }

        function displayPlaylists(playlists) {
            const grid = document.getElementById('musicGrid');
            
            if (playlists.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“‹</div>
                        <h4>No Playlists Yet</h4>
                        <p>Create your first playlist to organize your favorite music!</p>
                        ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreatePlaylistModal()">Create Playlist</button>' : ''}
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = playlists.map(playlist => `
                <div class="playlist-card" data-playlist-id="${playlist.id}">
                    <div class="playlist-artwork">
                        ${playlist.artwork_url ? 
                            `<img src="${playlist.artwork_url}" alt="${playlist.name}" loading="lazy">` :
                            '<div class="playlist-placeholder">ðŸ“‹</div>'
                        }
                        <div class="playlist-overlay">
                            <button class="play-button" onclick="playPlaylist('${playlist.id}')">
                                â–¶ï¸
                            </button>
                        </div>
                    </div>
                    <div class="playlist-info">
                        <div class="playlist-name">${escapeHtml(playlist.name)}</div>
                        <div class="playlist-meta">
                            <span>${playlist.track_count} tracks</span>
                            <span>â€¢</span>
                            <span>${playlist.profiles?.display_name || 'Unknown'}</span>
                        </div>
                        ${playlist.description ? `<div class="playlist-description">${escapeHtml(playlist.description)}</div>` : ''}
                        <div class="playlist-stats">
                            <span>â¤ï¸ ${playlist.like_count || 0}</span>
                            <span>ðŸ“¤ ${playlist.share_count || 0}</span>
                        </div>
                    </div>
                    <div class="playlist-actions">
                        <button class="btn btn-secondary" onclick="viewPlaylist('${playlist.id}')">View</button>
                        <button class="btn btn-primary" onclick="playPlaylist('${playlist.id}')">Play</button>
                    </div>
                </div>
            `).join('');
        }

        function playPlaylist(playlistId) {
            // TODO: Implement playlist playback
            alert('Playlist playback coming soon!');
        }

        function viewPlaylist(playlistId) {
            // TODO: Implement playlist view modal
            alert('Playlist view coming soon!');
        }

        function showCreatePlaylistModal() {
            // TODO: Implement create playlist modal
            alert('Create playlist feature coming soon!');
        }

        // Analytics Functions
        function showAnalyticsModal() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            // Show modal
            document.getElementById('analyticsModal').style.display = 'flex';
            
            // Load analytics data
            loadAnalytics();
        }

        async function loadAnalytics() {
            const analyticsContent = document.getElementById('analyticsContent');
            
            // Show loading
            analyticsContent.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading analytics...</p>
                </div>
            `;
            
            try {
                const type = document.getElementById('analyticsType').value;
                const period = document.getElementById('analyticsPeriod').value;
                
                const response = await fetch(`/api/profile?analytics_type=${type}&analytics_period=${period}`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalytics(data.analytics, type);
                } else {
                    throw new Error(data.error || 'Failed to load analytics');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                analyticsContent.innerHTML = `
                    <div class="no-activity">
                        <div class="empty-icon">âš ï¸</div>
                        <h4>Error</h4>
                        <p>Failed to load analytics</p>
                    </div>
                `;
            }
        }

        function displayAnalytics(analytics, type) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            switch (type) {
                case 'overview':
                    displayOverviewAnalytics(analytics);
                    break;
                case 'genres':
                    displayGenreAnalytics(analytics);
                    break;
                case 'artists':
                    displayArtistAnalytics(analytics);
                    break;
                case 'trends':
                    displayTrendAnalytics(analytics);
                    break;
                case 'social':
                    displaySocialAnalytics(analytics);
                    break;
                case 'listening_patterns':
                    displayListeningPatternAnalytics(analytics);
                    break;
                default:
                    analyticsContent.innerHTML = '<div class="no-activity"><div class="empty-icon">ðŸ“Š</div><h4>No Data</h4><p>No analytics data available</p></div>';
            }
        }

        function displayOverviewAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>ðŸ“Š Summary</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Posts Created</div>
                            <div class="card-value">${analytics.summary?.posts_created || 0}</div>
                            <div class="card-change positive">+${analytics.summary?.posts_created || 0} this period</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Likes Given</div>
                            <div class="card-value">${analytics.summary?.likes_given || 0}</div>
                            <div class="card-change positive">+${analytics.summary?.likes_given || 0} this period</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Comments Made</div>
                            <div class="card-value">${analytics.summary?.comments_made || 0}</div>
                            <div class="card-change positive">+${analytics.summary?.comments_made || 0} this period</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Playlists Created</div>
                            <div class="card-value">${analytics.summary?.playlists_created || 0}</div>
                            <div class="card-change positive">+${analytics.summary?.playlists_created || 0} this period</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ“ˆ Activity</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Posts per Day</div>
                            <div class="card-value">${analytics.activity?.posts_per_day || 0}</div>
                            <div class="card-change neutral">Average</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Likes per Day</div>
                            <div class="card-value">${analytics.activity?.likes_per_day || 0}</div>
                            <div class="card-change neutral">Average</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Most Active Day</div>
                            <div class="card-value">${analytics.activity?.most_active_day || 'N/A'}</div>
                            <div class="card-change neutral">Peak activity</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ’¬ Engagement</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Likes Received</div>
                            <div class="card-value">${analytics.engagement?.likes_received || 0}</div>
                            <div class="card-change positive">+${analytics.engagement?.likes_received || 0}</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Comments Received</div>
                            <div class="card-value">${analytics.engagement?.comments_received || 0}</div>
                            <div class="card-change positive">+${analytics.engagement?.comments_received || 0}</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Engagement Rate</div>
                            <div class="card-value">${analytics.engagement?.engagement_rate || 0}</div>
                            <div class="card-change neutral">per post</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ” Discovery</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Unique Artists</div>
                            <div class="card-value">${analytics.discovery?.unique_artists || 0}</div>
                            <div class="card-change positive">Artists discovered</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Unique Genres</div>
                            <div class="card-value">${analytics.discovery?.unique_genres || 0}</div>
                            <div class="card-change positive">Genres explored</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Discovery Score</div>
                            <div class="card-value">${analytics.discovery?.discovery_score || 0}</div>
                            <div class="card-change neutral">out of 100</div>
                        </div>
                    </div>
                </div>

                ${analytics.discovery?.most_shared_track ? `
                    <div class="insight-card">
                        <h4>ðŸŽµ Most Shared Track</h4>
                        <p>"${analytics.discovery.most_shared_track.track_title}" by ${analytics.discovery.most_shared_track.track_artist}</p>
                    </div>
                ` : ''}
            `;
        }

        function displayGenreAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            const genreChart = analytics.distribution?.map(genre => `
                <div class="chart-bar">
                    <div class="chart-bar-label">${genre.genre}</div>
                    <div class="chart-bar-fill">
                        <div class="chart-bar-progress" style="width: ${genre.percentage}%"></div>
                    </div>
                    <div class="chart-bar-value">${genre.percentage}%</div>
                </div>
            `).join('') || '';

            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>ðŸŽµ Genre Distribution</h3>
                    <div class="chart-container">
                        <div class="chart-title">Your Music Taste Breakdown</div>
                        ${genreChart}
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ“ˆ Genre Trends</h3>
                    <div class="analytics-grid">
                        ${analytics.trends?.map(trend => `
                            <div class="analytics-card">
                                <div class="card-title">${trend.genre}</div>
                                <div class="card-value">
                                    <span class="trend-indicator ${trend.trend}">
                                        ${trend.trend === 'increasing' ? 'â†—ï¸' : trend.trend === 'decreasing' ? 'â†˜ï¸' : 'â†’'} 
                                        ${trend.change}%
                                    </span>
                                </div>
                            </div>
                        `).join('') || ''}
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ† Top Genres</h3>
                    <div class="analytics-grid">
                        ${analytics.top_genres?.map((genre, index) => `
                            <div class="analytics-card">
                                <div class="card-title">#${index + 1}</div>
                                <div class="card-value">${genre}</div>
                            </div>
                        `).join('') || ''}
                    </div>
                </div>

                <div class="insight-card">
                    <h4>ðŸŽ¯ Genre Diversity Score</h4>
                    <p>Your music taste has a diversity score of ${analytics.genre_diversity_score || 0}/100. ${analytics.genre_diversity_score > 70 ? 'You have a very diverse taste in music!' : analytics.genre_diversity_score > 40 ? 'You have a moderately diverse taste in music.' : 'Consider exploring more genres to diversify your music taste.'}</p>
                </div>
            `;
        }

        function displayArtistAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            const topArtists = analytics.top_artists?.map(artist => `
                <div class="chart-bar">
                    <div class="chart-bar-label">${artist.artist}</div>
                    <div class="chart-bar-fill">
                        <div class="chart-bar-progress" style="width: ${(artist.count / Math.max(...analytics.top_artists.map(a => a.count))) * 100}%"></div>
                    </div>
                    <div class="chart-bar-value">${artist.count}</div>
                </div>
            `).join('') || '';

            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>ðŸŽ¤ Top Artists</h3>
                    <div class="chart-container">
                        <div class="chart-title">Most Listened Artists</div>
                        ${topArtists}
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ“Š Artist Insights</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Artist Diversity</div>
                            <div class="card-value">${analytics.artist_diversity || 0}</div>
                            <div class="card-change neutral">unique artists</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Discovery Rate</div>
                            <div class="card-value">${Math.round((analytics.artist_discovery_rate || 0) * 100)}%</div>
                            <div class="card-change positive">new artists</div>
                        </div>
                        ${analytics.most_engaged_artist ? `
                            <div class="analytics-card">
                                <div class="card-title">Most Engaged</div>
                                <div class="card-value">${analytics.most_engaged_artist.artist}</div>
                                <div class="card-change positive">${analytics.most_engaged_artist.engagement} interactions</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function displayTrendAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>ðŸ“ˆ Activity Trends</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Activity Trend</div>
                            <div class="card-value">
                                <span class="trend-indicator ${analytics.activity_trend}">
                                    ${analytics.activity_trend === 'increasing' ? 'â†—ï¸' : analytics.activity_trend === 'decreasing' ? 'â†˜ï¸' : 'â†’'} 
                                    ${analytics.activity_trend}
                                </span>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Engagement Trend</div>
                            <div class="card-value">
                                <span class="trend-indicator ${analytics.engagement_trend}">
                                    ${analytics.engagement_trend === 'increasing' ? 'â†—ï¸' : analytics.engagement_trend === 'decreasing' ? 'â†˜ï¸' : 'â†’'} 
                                    ${analytics.engagement_trend}
                                </span>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Growth Rate</div>
                            <div class="card-value">${analytics.growth_rate || 0}%</div>
                            <div class="card-change ${analytics.growth_rate > 0 ? 'positive' : 'negative'}">monthly</div>
                        </div>
                    </div>
                </div>

                ${analytics.peak_performance ? `
                    <div class="insight-card">
                        <h4>ðŸ† Peak Performance</h4>
                        <p>Your best day was ${analytics.peak_performance.date} with ${analytics.peak_performance.value} interactions!</p>
                    </div>
                ` : ''}

                <div class="analytics-section">
                    <h3>ðŸ“… Weekly Patterns</h3>
                    <div class="pattern-grid">
                        ${analytics.seasonal_patterns?.map(pattern => `
                            <div class="pattern-day ${pattern.activity > 1.1 ? 'high' : pattern.activity > 0.9 ? 'medium' : 'low'}">
                                <div class="pattern-day-label">${pattern.day.slice(0, 3)}</div>
                                <div class="pattern-day-value">${pattern.activity.toFixed(1)}</div>
                            </div>
                        `).join('') || ''}
                    </div>
                </div>
            `;
        }

        function displaySocialAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>ðŸ‘¥ Social Impact</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Social Influence</div>
                            <div class="card-value">${analytics.social_influence || 0}</div>
                            <div class="card-change neutral">out of 100</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Friend Engagement</div>
                            <div class="card-value">${Math.round((analytics.friend_engagement || 0) * 100)}%</div>
                            <div class="card-change positive">engagement rate</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Social Reach</div>
                            <div class="card-value">${analytics.social_reach || 0}</div>
                            <div class="card-change positive">people reached</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Community Impact</div>
                            <div class="card-value">${analytics.community_impact || 0}</div>
                            <div class="card-change neutral">out of 100</div>
                        </div>
                    </div>
                </div>

                <div class="insight-card">
                    <h4>ðŸŒŸ Social Insights</h4>
                    <p>Your music taste has influenced ${analytics.social_reach || 0} people in your network. Keep sharing great music!</p>
                </div>
            `;
        }

        function displayListeningPatternAnalytics(analytics) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            const peakHours = analytics.peak_hours?.map(hour => `
                <span class="trend-indicator increasing">${hour}:00</span>
            `).join(' ') || '';

            analyticsContent.innerHTML = `
                <div class="analytics-section">
                    <h3>â° Listening Patterns</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-title">Frequency</div>
                            <div class="card-value">${analytics.listening_frequency || 'Daily'}</div>
                            <div class="card-change neutral">listening habit</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-title">Consistency Score</div>
                            <div class="card-value">${analytics.consistency_score || 0}</div>
                            <div class="card-change neutral">out of 100</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ• Peak Hours</h3>
                    <div class="chart-container">
                        <div class="chart-title">When You're Most Active</div>
                        <p>${peakHours}</p>
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸ“… Weekly Patterns</h3>
                    <div class="pattern-grid">
                        ${analytics.weekly_patterns?.map(pattern => `
                            <div class="pattern-day ${pattern.posts > 4 ? 'high' : pattern.posts > 2 ? 'medium' : 'low'}">
                                <div class="pattern-day-label">${pattern.day.slice(0, 3)}</div>
                                <div class="pattern-day-value">${pattern.posts}</div>
                            </div>
                        `).join('') || ''}
                    </div>
                </div>

                <div class="analytics-section">
                    <h3>ðŸŽ­ Mood Analysis</h3>
                    <div class="chart-container">
                        ${analytics.mood_analysis?.map(mood => `
                            <div class="chart-bar">
                                <div class="chart-bar-label">${mood.mood}</div>
                                <div class="chart-bar-fill">
                                    <div class="chart-bar-progress" style="width: ${mood.percentage}%"></div>
                                </div>
                                <div class="chart-bar-value">${mood.percentage}%</div>
                            </div>
                        `).join('') || ''}
                    </div>
                </div>
            `;
        }

        // Performance Optimization Utilities
        class PerformanceOptimizer {
            constructor() {
                this.imageObserver = null;
                this.intersectionObserver = null;
                this.initLazyLoading();
            }
            
            initLazyLoading() {
                // Lazy load images
                this.imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.classList.add('loaded');
                                this.imageObserver.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '50px 0px',
                    threshold: 0.1
                });
                
                // Observe all lazy images
                document.querySelectorAll('img[data-src]').forEach(img => {
                    this.imageObserver.observe(img);
                });
            }
            
            // Debounce function for search and other inputs
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Throttle function for scroll events
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
            
            // Virtual scrolling for large lists
            createVirtualScroller(container, items, itemHeight, renderItem) {
                const visibleCount = Math.ceil(container.clientHeight / itemHeight);
                const buffer = 5; // Extra items to render outside viewport
                
                let scrollTop = 0;
                let startIndex = 0;
                let endIndex = Math.min(startIndex + visibleCount + buffer, items.length);
                
                const updateItems = () => {
                    const fragment = document.createDocumentFragment();
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const item = renderItem(items[i], i);
                        item.style.position = 'absolute';
                        item.style.top = `${i * itemHeight}px`;
                        item.style.height = `${itemHeight}px`;
                        fragment.appendChild(item);
                    }
                    
                    container.innerHTML = '';
                    container.appendChild(fragment);
                };
                
                const handleScroll = this.throttle((e) => {
                    scrollTop = e.target.scrollTop;
                    const newStartIndex = Math.floor(scrollTop / itemHeight);
                    const newEndIndex = Math.min(newStartIndex + visibleCount + buffer, items.length);
                    
                    if (newStartIndex !== startIndex || newEndIndex !== endIndex) {
                        startIndex = newStartIndex;
                        endIndex = newEndIndex;
                        updateItems();
                    }
                }, 16); // ~60fps
                
                container.addEventListener('scroll', handleScroll);
                updateItems();
                
                return {
                    updateItems: (newItems) => {
                        items = newItems;
                        updateItems();
                    },
                    destroy: () => {
                        container.removeEventListener('scroll', handleScroll);
                    }
                };
            }
            
            // Preload critical resources
            preloadCriticalResources() {
                const criticalImages = [
                    'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk11c2ljPC90ZXh0Pjwvc3ZnPg=='
                ];
                
                criticalImages.forEach(src => {
                    const img = new Image();
                    img.src = src;
                });
            }
            
            // Optimize animations with requestAnimationFrame
            animateElement(element, properties, duration, easing = 'ease-out') {
                return new Promise((resolve) => {
                    const startTime = performance.now();
                    const startValues = {};
                    
                    // Get initial values
                    Object.keys(properties).forEach(prop => {
                        startValues[prop] = parseFloat(getComputedStyle(element)[prop]) || 0;
                    });
                    
                    const animate = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // Apply easing
                        const easedProgress = easing === 'ease-out' 
                            ? 1 - Math.pow(1 - progress, 3)
                            : progress;
                        
                        // Update properties
                        Object.keys(properties).forEach(prop => {
                            const start = startValues[prop];
                            const end = properties[prop];
                            const current = start + (end - start) * easedProgress;
                            element.style[prop] = current + (prop.includes('opacity') ? '' : 'px');
                        });
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            resolve();
                        }
                    };
                    
                    requestAnimationFrame(animate);
                });
            }
        }
        
        // Global performance optimizer
        const perfOptimizer = new PerformanceOptimizer();
        
        // Enhanced Polling Manager with Memory Leak Prevention
        class PollingManager {
            constructor() {
                this.intervals = new Map();
                this.listeners = new Map();
                this.abortControllers = new Map();
                this.isActive = false;
            }
            
            startPolling(name, callback, interval) {
                // Clean up existing if any
                this.stopPolling(name);
                
                if (!this.isActive) return;
                
                // Create abort controller for fetch cancellation
                const controller = new AbortController();
                this.abortControllers.set(name, controller);
                
                // Wrapper with error handling and abort signal
                const wrappedCallback = async () => {
                    try {
                        await callback(controller.signal);
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error(`Polling error in ${name}:`, error);
                        }
                    }
                };
                
                // Start interval
                const intervalId = setInterval(wrappedCallback, interval);
                this.intervals.set(name, intervalId);
                
                // Run immediately
                wrappedCallback();
            }
            
            stopPolling(name) {
                // Clear interval
                const intervalId = this.intervals.get(name);
                if (intervalId) {
                    clearInterval(intervalId);
                    this.intervals.delete(name);
                }
                
                // Abort pending requests
                const controller = this.abortControllers.get(name);
                if (controller) {
                    controller.abort();
                    this.abortControllers.delete(name);
                }
            }
            
            addEventListener(element, event, handler) {
                const key = `${element.id || 'doc'}_${event}`;
                
                // Remove old listener if exists
                this.removeEventListener(element, event);
                
                // Add new listener
                element.addEventListener(event, handler);
                this.listeners.set(key, { element, event, handler });
            }
            
            removeEventListener(element, event) {
                const key = `${element.id || 'doc'}_${event}`;
                const listener = this.listeners.get(key);
                
                if (listener) {
                    listener.element.removeEventListener(listener.event, listener.handler);
                    this.listeners.delete(key);
                }
            }
            
            start() {
                this.isActive = true;
                
                // Start notification polling (every 30 seconds)
                this.startPolling('notifications', async (signal) => {
                    if (!isSignedIn || !userToken) return;
                    
                    try {
                        const response = await fetch('/api/friends?notifications=1&limit=10', { signal });
                        const data = await response.json();
                        
                        if (data.success) {
                            const newUnreadCount = data.unread_count || 0;
                            
                            if (newUnreadCount !== unreadNotificationCount) {
                                unreadNotificationCount = newUnreadCount;
                                updateNotificationBadge();
                            }
                        }
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Error checking notifications:', error);
                        }
                    }
                }, 30000);
                
                // Start feed polling (every 2 minutes for active feeds)
                this.startPolling('feed', async (signal) => {
                    if (!isSignedIn || !userToken) return;
                    
                    try {
                        const response = await fetch('/api/feed?limit=20', { signal });
                        const data = await response.json();
                        
                        if (data.success && data.posts) {
                            // Only update if feed is visible
                            const feedSection = document.getElementById('socialFeed');
                            if (feedSection && feedSection.style.display !== 'none') {
                                displayFeed(data.posts);
                            }
                        }
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Error checking feed updates:', error);
                        }
                    }
                }, 120000);
            }
            
            stop() {
                this.isActive = false;
                
                // Stop all polling
                this.intervals.forEach((_, name) => this.stopPolling(name));
                
                // Remove all listeners
                this.listeners.forEach(listener => {
                    listener.element.removeEventListener(listener.event, listener.handler);
                });
                this.listeners.clear();
            }
            
            cleanup() {
                this.stop();
            }
        }
        
        // Global polling manager instance
        const pollingManager = new PollingManager();
        
        // Real-time Update Functions (Updated)
        function startRealTimeUpdates() {
            if (!isSignedIn || !userToken) {
                return;
            }
            pollingManager.start();
        }

        function stopRealTimeUpdates() {
            pollingManager.stop();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const container = document.getElementById('notificationsContainer');
            
            if (unreadNotificationCount > 0) {
                badge.textContent = unreadNotificationCount > 99 ? '99+' : unreadNotificationCount;
                badge.style.display = 'flex';
                container.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Advanced Music Discovery Functions
        let currentMood = null;
        let currentTimeFilter = 'all';
        let currentDiscoveryType = 'trending';
        let discoveryStats = {};

        async function filterByGenre() {
            const genre = document.getElementById('genreFilter').value;
            await switchGenre(genre);
            updateDiscoveryStats();
        }

        async function filterByMood(mood) {
            // Update mood button states
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mood="${mood}"]`).classList.add('active');
            
            currentMood = mood;
            await loadMoodBasedRecommendations(mood);
            updateDiscoveryStats();
        }

        async function filterByTime() {
            const timeFilter = document.getElementById('timeFilter').value;
            currentTimeFilter = timeFilter;
            await loadTimeFilteredMusic(timeFilter);
            updateDiscoveryStats();
        }

        async function changeDiscoveryType() {
            const discoveryType = document.getElementById('discoveryType').value;
            currentDiscoveryType = discoveryType;
            
            switch(discoveryType) {
                case 'trending':
                    await switchGenre(currentGenre);
                    break;
                case 'recommendations':
                    await loadRecommendations();
                    break;
                case 'new-releases':
                    await loadNewReleases();
                    break;
                case 'playlists':
                    await loadPlaylists();
                    break;
            }
            updateDiscoveryStats();
        }

        async function loadMoodBasedRecommendations(mood) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '<div class="loading">Loading mood-based recommendations...</div>';
            
            try {
                const response = await fetch(`/api/profile?recommendations=true&mood=${mood}&limit=20`, {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.recommendations) {
                    displayMoodRecommendations(data.recommendations, mood);
                } else {
                    // Fallback to trending music
                    await switchGenre(currentGenre);
                }
            } catch (error) {
                console.error('Error loading mood recommendations:', error);
                await switchGenre(currentGenre);
            }
        }

        function displayMoodRecommendations(recommendations, mood) {
            const grid = document.getElementById('musicGrid');
            
            if (recommendations.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸŽµ</div>
                        <h3>No ${mood} music found</h3>
                        <p>Try a different mood or browse trending music.</p>
                        <button class="btn btn-primary" onclick="switchGenre('all')">Browse All</button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = recommendations.map(track => `
                <div class="track-card recommended" data-track-id="${track.id}">
                    <div class="track-artwork">
                        <img src="${track.artwork || 'https://via.placeholder.com/300x300/667eea/ffffff?text=Music'}" 
                             alt="${track.title}"
                             loading="lazy"
                             onerror="this.src='https://via.placeholder.com/300x300/667eea/ffffff?text=Music'"
                             onload="this.classList.add('loaded')">
                        <div class="play-overlay">
                            <button class="play-button" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                â–¶ï¸
                            </button>
                        </div>
                    </div>
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(track.title)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        ${track.popularity ? `<div class="track-popularity">${getPopularityBars(track.popularity)}</div>` : ''}
                        <div class="recommendation-reason">${track.recommendation_reason || `Perfect for ${mood} vibes`}</div>
                    </div>
                    <button class="track-action-btn" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
        }

        async function loadTimeFilteredMusic(timeFilter) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '<div class="loading">Loading music from ' + timeFilter + '...</div>';
            
            try {
                const response = await fetch(`/api/search?q=year:${timeFilter}&limit=20`);
                const data = await response.json();
                
                if (data.success && data.tracks) {
                    displayTracks(data.tracks);
                } else {
                    // Fallback to trending
                    await switchGenre(currentGenre);
                }
            } catch (error) {
                console.error('Error loading time-filtered music:', error);
                await switchGenre(currentGenre);
            }
        }

        async function loadNewReleases() {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '<div class="loading">Loading new releases...</div>';
            
            try {
                const response = await fetch('/api/trending?genre=new-releases&limit=20');
                const data = await response.json();
                
                if (data.success && data.tracks) {
                    displayTracks(data.tracks);
                } else {
                    await switchGenre(currentGenre);
                }
            } catch (error) {
                console.error('Error loading new releases:', error);
                await switchGenre(currentGenre);
            }
        }

        function updateDiscoveryStats() {
            const tracks = document.querySelectorAll('.track-card');
            if (tracks.length === 0) return;
            
            // Calculate stats
            const totalTracks = tracks.length;
            const popularities = Array.from(tracks).map(track => {
                const popularityEl = track.querySelector('.track-popularity');
                return popularityEl ? parseInt(popularityEl.textContent) || 0 : 0;
            });
            
            const avgPopularity = popularities.length > 0 
                ? Math.round(popularities.reduce((a, b) => a + b, 0) / popularities.length)
                : 0;
            
            const genres = Array.from(tracks).map(track => {
                const genreEl = track.querySelector('[data-genre]');
                return genreEl ? genreEl.dataset.genre : 'unknown';
            });
            
            const genreCounts = genres.reduce((acc, genre) => {
                acc[genre] = (acc[genre] || 0) + 1;
                return acc;
            }, {});
            
            const topGenre = Object.keys(genreCounts).reduce((a, b) => 
                genreCounts[a] > genreCounts[b] ? a : b, 'unknown'
            );
            
            const newReleases = Array.from(tracks).filter(track => 
                track.classList.contains('recommended')
            ).length;
            
            // Update UI
            document.getElementById('totalTracks').textContent = totalTracks;
            document.getElementById('avgPopularity').textContent = avgPopularity;
            document.getElementById('topGenre').textContent = topGenre.charAt(0).toUpperCase() + topGenre.slice(1);
            document.getElementById('newReleases').textContent = newReleases;
            
            // Show stats
            document.getElementById('discoveryStats').style.display = 'grid';
        }

        // Playlist Management Functions
        let currentPlaylist = null;
        let userPlaylists = [];

        async function loadPlaylists() {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '<div class="loading">Loading playlists...</div>';
            
            try {
                const response = await fetch('/api/posts?playlists=true&limit=20', {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.playlists) {
                    displayPlaylists(data.playlists);
                } else {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸŽµ</div>
                            <h3>No Playlists Found</h3>
                            <p>Create your first playlist to get started!</p>
                            ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreatePlaylistModal()">Create Playlist</button>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading playlists:', error);
                grid.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">âš ï¸</div>
                        <h3>Error Loading Playlists</h3>
                        <p>Something went wrong. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadPlaylists()">Retry</button>
                    </div>
                `;
            }
        }

        function displayPlaylists(playlists) {
            const grid = document.getElementById('musicGrid');
            
            if (playlists.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸŽµ</div>
                        <h3>No Playlists Yet</h3>
                        <p>Create your first playlist to get started!</p>
                        ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreatePlaylistModal()">Create Playlist</button>' : ''}
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = `
                <div class="playlist-grid">
                    ${playlists.map(playlist => `
                        <div class="playlist-card" onclick="viewPlaylist('${playlist.id}')">
                            <div class="playlist-card-artwork">
                                ${playlist.artwork_url ? 
                                    `<img src="${playlist.artwork_url}" alt="${escapeHtml(playlist.name)}">` : 
                                    'ðŸŽµ'
                                }
                            </div>
                            <div class="playlist-card-info">
                                <h3>${escapeHtml(playlist.name)}</h3>
                                <div class="playlist-card-meta">
                                    ${playlist.track_count || 0} tracks â€¢ ${playlist.privacy || 'private'}
                                    ${playlist.collaborative ? ' â€¢ Collaborative' : ''}
                                </div>
                            </div>
                            <div class="playlist-card-actions">
                                <button class="playlist-card-btn primary" onclick="event.stopPropagation(); playPlaylist('${playlist.id}')">
                                    Play
                                </button>
                                <button class="playlist-card-btn" onclick="event.stopPropagation(); sharePlaylist('${playlist.id}')">
                                    Share
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${isSignedIn ? `
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="showCreatePlaylistModal()">
                            Create New Playlist
                        </button>
                    </div>
                ` : ''}
            `;
        }

        function showCreatePlaylistModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('playlistCreateModal').style.display = 'flex';
            document.getElementById('playlistName').focus();
        }

        function closePlaylistCreateModal() {
            document.getElementById('playlistCreateModal').style.display = 'none';
            document.getElementById('playlistCreateForm').reset();
        }

        async function createPlaylist(event) {
            event.preventDefault();
            
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            const formData = {
                name: document.getElementById('playlistName').value,
                description: document.getElementById('playlistDescription').value,
                privacy: document.getElementById('playlistPrivacy').value,
                collaborative: document.getElementById('playlistCollaborative').value === 'true'
            };
            
            try {
                const response = await fetch('/api/posts?playlists=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Playlist created successfully!', 'success');
                    closePlaylistCreateModal();
                    await loadPlaylists();
                } else {
                    showNotification(data.error || 'Failed to create playlist', 'error');
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                showNotification('Network error', 'error');
            }
        }

        async function viewPlaylist(playlistId) {
            try {
                const response = await fetch(`/api/posts?playlists=true&playlist_id=${playlistId}`, {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.playlist) {
                    currentPlaylist = data.playlist;
                    displayPlaylistView(data.playlist);
                    document.getElementById('playlistViewModal').style.display = 'flex';
                } else {
                    showNotification('Failed to load playlist', 'error');
                }
            } catch (error) {
                console.error('Error viewing playlist:', error);
                showNotification('Network error', 'error');
            }
        }

        function displayPlaylistView(playlist) {
            document.getElementById('playlistViewName').textContent = playlist.name;
            document.getElementById('playlistViewMeta').textContent = 
                `${playlist.track_count || 0} tracks â€¢ Created by ${playlist.creator?.display_name || 'Unknown'}`;
            
            const artworkEl = document.getElementById('playlistViewArtwork');
            if (playlist.artwork_url) {
                artworkEl.innerHTML = `<img src="${playlist.artwork_url}" alt="${escapeHtml(playlist.name)}">`;
            } else {
                artworkEl.innerHTML = 'ðŸŽµ';
            }
            
            const trackListEl = document.getElementById('playlistTrackList');
            if (playlist.tracks && playlist.tracks.length > 0) {
                trackListEl.innerHTML = playlist.tracks.map((track, index) => `
                    <div class="track-item" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                        <div class="track-number">${index + 1}</div>
                        <div class="track-item-artwork">
                            ${track.artwork ? 
                                `<img src="${track.artwork}" alt="${escapeHtml(track.title)}">` : 
                                'ðŸŽµ'
                            }
                        </div>
                        <div class="track-item-info">
                            <div class="track-item-title">${escapeHtml(track.title)}</div>
                            <div class="track-item-artist">${escapeHtml(track.artist)}</div>
                        </div>
                        <div class="track-item-duration">${formatDuration(track.duration_ms || 0)}</div>
                        <div class="track-item-actions">
                            <button class="btn btn-sm" onclick="event.stopPropagation(); removeFromPlaylist('${track.id}')">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                trackListEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸŽµ</div>
                        <h3>No Tracks Yet</h3>
                        <p>Add some tracks to your playlist!</p>
                    </div>
                `;
            }
        }

        function closePlaylistViewModal() {
            document.getElementById('playlistViewModal').style.display = 'none';
            currentPlaylist = null;
        }

        async function playPlaylist(playlistId = null) {
            const playlist = playlistId ? 
                userPlaylists.find(p => p.id === playlistId) : 
                currentPlaylist;
            
            if (!playlist || !playlist.tracks || playlist.tracks.length === 0) {
                showNotification('No tracks to play', 'error');
                return;
            }
            
            // Play first track
            const firstTrack = playlist.tracks[0];
            playTrack(firstTrack.url, firstTrack.title, firstTrack.artist);
            
            showNotification(`Playing "${playlist.name}"`, 'success');
        }

        async function removeFromPlaylist(trackId) {
            if (!isSignedIn || !userToken || !currentPlaylist) return;
            
            try {
                const response = await fetch('/api/posts?playlists=true', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        playlist_id: currentPlaylist.id,
                        track_id: trackId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Track removed from playlist', 'success');
                    await viewPlaylist(currentPlaylist.id); // Refresh view
                } else {
                    showNotification(data.error || 'Failed to remove track', 'error');
                }
            } catch (error) {
                console.error('Error removing track from playlist:', error);
                showNotification('Network error', 'error');
            }
        }

        function sharePlaylist(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist) return;
            
            const shareUrl = `${window.location.origin}/playlist/${playlistId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: playlist.name,
                    text: `Check out my playlist: ${playlist.name}`,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('Playlist link copied to clipboard!', 'success');
                });
            }
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // User Listening Insights Functions
        let currentInsightsPeriod = '30d';
        let insightsData = {};

        function showInsightsModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('insightsModal').style.display = 'flex';
            loadListeningInsights();
        }

        async function loadListeningInsights() {
            const insightsGrid = document.getElementById('insightsGrid');
            insightsGrid.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Analyzing your listening patterns...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/profile?analytics_type=insights&analytics_period=${currentInsightsPeriod}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                const data = await response.json();
                
                if (data.success && data.insights) {
                    insightsData = data.insights;
                    displayListeningInsights(data.insights);
                } else {
                    displayInsightsEmpty();
                }
            } catch (error) {
                console.error('Error loading insights:', error);
                displayInsightsError();
            }
        }

        function displayListeningInsights(insights) {
            const insightsGrid = document.getElementById('insightsGrid');
            
            insightsGrid.innerHTML = `
                <!-- Total Listening Time -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">â±ï¸</div>
                        <h3 class="insight-title">Total Listening Time</h3>
                    </div>
                    <div class="insight-value">${formatListeningTime(insights.total_listening_time || 0)}</div>
                    <div class="insight-description">Time spent listening to music this period</div>
                    <div class="insight-trend">
                        <span class="trend-indicator ${getTrendClass(insights.listening_time_trend)}">
                            ${getTrendIcon(insights.listening_time_trend)} ${insights.listening_time_trend || 0}%
                        </span>
                        <span>vs previous period</span>
                    </div>
                </div>

                <!-- Tracks Played -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸŽµ</div>
                        <h3 class="insight-title">Tracks Played</h3>
                    </div>
                    <div class="insight-value">${(insights.tracks_played || 0).toLocaleString()}</div>
                    <div class="insight-description">Unique tracks you've discovered</div>
                    <div class="insight-trend">
                        <span class="trend-indicator ${getTrendClass(insights.tracks_trend)}">
                            ${getTrendIcon(insights.tracks_trend)} ${insights.tracks_trend || 0}%
                        </span>
                        <span>vs previous period</span>
                    </div>
                </div>

                <!-- Top Genre -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸŽ­</div>
                        <h3 class="insight-title">Top Genre</h3>
                    </div>
                    <div class="insight-value">${insights.top_genre || 'Unknown'}</div>
                    <div class="insight-description">Your most listened genre</div>
                    <div class="insight-chart">
                        <div class="chart-bar">
                            ${generateGenreChart(insights.genre_distribution || {})}
                        </div>
                        <div class="chart-labels">
                            <span>Least</span>
                            <span>Most</span>
                        </div>
                    </div>
                </div>

                <!-- Discovery Score -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸ”</div>
                        <h3 class="insight-title">Discovery Score</h3>
                    </div>
                    <div class="insight-value">${insights.discovery_score || 0}%</div>
                    <div class="insight-description">How much new music you've discovered</div>
                    <div class="insight-trend">
                        <span class="trend-indicator ${getTrendClass(insights.discovery_trend)}">
                            ${getTrendIcon(insights.discovery_trend)} ${insights.discovery_trend || 0}%
                        </span>
                        <span>vs previous period</span>
                    </div>
                </div>

                <!-- Top Artists -->
                <div class="insight-card" style="grid-column: 1 / -1;">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸ‘¤</div>
                        <h3 class="insight-title">Top Artists</h3>
                    </div>
                    <div class="top-artists-list">
                        ${generateTopArtists(insights.top_artists || [])}
                    </div>
                </div>

                <!-- Listening Pattern -->
                <div class="insight-card" style="grid-column: 1 / -1;">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸ“…</div>
                        <h3 class="insight-title">Weekly Listening Pattern</h3>
                    </div>
                    <div class="insight-description">Your most active listening days</div>
                    <div class="listening-pattern">
                        ${generateWeeklyPattern(insights.weekly_pattern || {})}
                    </div>
                </div>

                <!-- Music Mood -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸ˜Š</div>
                        <h3 class="insight-title">Music Mood</h3>
                    </div>
                    <div class="insight-value">${insights.dominant_mood || 'Balanced'}</div>
                    <div class="insight-description">Your overall music mood</div>
                    <div class="insight-chart">
                        <div class="chart-bar">
                            ${generateMoodChart(insights.mood_distribution || {})}
                        </div>
                    </div>
                </div>

                <!-- Listening Streak -->
                <div class="insight-card">
                    <div class="insight-card-header">
                        <div class="insight-icon">ðŸ”¥</div>
                        <h3 class="insight-title">Listening Streak</h3>
                    </div>
                    <div class="insight-value">${insights.listening_streak || 0}</div>
                    <div class="insight-description">Days in a row you've listened to music</div>
                    <div class="insight-trend">
                        <span class="trend-indicator ${getTrendClass(insights.streak_trend)}">
                            ${getTrendIcon(insights.streak_trend)} ${insights.streak_trend || 0}%
                        </span>
                        <span>vs previous period</span>
                    </div>
                </div>
            `;
        }

        function generateGenreChart(distribution) {
            const genres = Object.keys(distribution);
            const maxValue = Math.max(...Object.values(distribution));
            
            return genres.map(genre => {
                const height = (distribution[genre] / maxValue) * 100;
                return `<div class="chart-bar-item" style="height: ${height}%" title="${genre}: ${distribution[genre]} plays"></div>`;
            }).join('');
        }

        function generateMoodChart(distribution) {
            const moods = Object.keys(distribution);
            const maxValue = Math.max(...Object.values(distribution));
            
            return moods.map(mood => {
                const height = (distribution[mood] / maxValue) * 100;
                return `<div class="chart-bar-item" style="height: ${height}%" title="${mood}: ${distribution[mood]} plays"></div>`;
            }).join('');
        }

        function generateTopArtists(artists) {
            if (artists.length === 0) {
                return '<div class="insights-empty"><p>No artist data available</p></div>';
            }
            
            return artists.slice(0, 5).map((artist, index) => `
                <div class="artist-item">
                    <div class="artist-rank">${index + 1}</div>
                    <div class="artist-image">
                        ${artist.image ? `<img src="${artist.image}" alt="${escapeHtml(artist.name)}">` : 'ðŸŽ¤'}
                    </div>
                    <div class="artist-info">
                        <div class="artist-name">${escapeHtml(artist.name)}</div>
                        <div class="artist-plays">${artist.plays || 0} plays</div>
                    </div>
                </div>
            `).join('');
        }

        function generateWeeklyPattern(pattern) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const maxValue = Math.max(...Object.values(pattern));
            
            return days.map(day => {
                const value = pattern[day.toLowerCase()] || 0;
                const intensity = maxValue > 0 ? (value / maxValue) * 100 : 0;
                const isActive = intensity > 20;
                
                return `<div class="pattern-day ${isActive ? 'active' : ''}" style="opacity: ${intensity / 100}" title="${day}: ${value} plays"></div>`;
            }).join('');
        }

        function formatListeningTime(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function getTrendClass(trend) {
            if (trend > 0) return 'trend-up';
            if (trend < 0) return 'trend-down';
            return 'trend-neutral';
        }

        function getTrendIcon(trend) {
            if (trend > 0) return 'â†—ï¸';
            if (trend < 0) return 'â†˜ï¸';
            return 'âž¡ï¸';
        }

        function filterInsights(period) {
            // Update filter buttons
            document.querySelectorAll('.insight-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            currentInsightsPeriod = period;
            loadListeningInsights();
        }

        function displayInsightsEmpty() {
            const insightsGrid = document.getElementById('insightsGrid');
            insightsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">ðŸ“Š</div>
                    <h3>No Insights Yet</h3>
                    <p>Start listening to music to see your personalized insights!</p>
                    <button class="btn btn-primary" onclick="switchGenre('all')">Discover Music</button>
                </div>
            `;
        }

        function displayInsightsError() {
            const insightsGrid = document.getElementById('insightsGrid');
            insightsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Insights</h3>
                    <p>Something went wrong while loading your insights.</p>
                    <button class="btn btn-primary" onclick="loadListeningInsights()">Try Again</button>
                </div>
            `;
        }

        // Music Groups & Communities Functions
        let currentGroupFilter = 'all';
        let userGroups = [];

        async function loadGroups() {
            const groupsGrid = document.getElementById('groupsGrid');
            groupsGrid.innerHTML = '<div class="loading">Loading groups...</div>';
            
            try {
                const response = await fetch(`/api/friends?groups=true&filter=${currentGroupFilter}`, {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.groups) {
                    displayGroups(data.groups);
                } else {
                    displayGroupsEmpty();
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                displayGroupsError();
            }
        }

        function displayGroups(groups) {
            const groupsGrid = document.getElementById('groupsGrid');
            
            if (groups.length === 0) {
                displayGroupsEmpty();
                return;
            }
            
            groupsGrid.innerHTML = groups.map(group => `
                <div class="group-card" onclick="viewGroup('${group.id}')">
                    <div class="group-header">
                        <div class="group-avatar">
                            ${group.avatar_url ? 
                                `<img src="${group.avatar_url}" alt="${escapeHtml(group.name)}">` : 
                                getGroupIcon(group.type)
                            }
                        </div>
                        <div class="group-info">
                            <h3>${escapeHtml(group.name)}</h3>
                            <div class="group-meta">
                                ${group.type.charAt(0).toUpperCase() + group.type.slice(1)} â€¢ ${group.privacy}
                                ${group.genre ? ` â€¢ ${group.genre}` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="group-description">
                        ${escapeHtml(group.description || 'No description available')}
                    </div>
                    
                    <div class="group-stats">
                        <div class="group-stat">
                            <div class="group-stat-number">${group.member_count || 0}</div>
                            <div class="group-stat-label">Members</div>
                        </div>
                        <div class="group-stat">
                            <div class="group-stat-number">${group.post_count || 0}</div>
                            <div class="group-stat-label">Posts</div>
                        </div>
                        <div class="group-stat">
                            <div class="group-stat-number">${group.activity_score || 0}</div>
                            <div class="group-stat-label">Activity</div>
                        </div>
                    </div>
                    
                    <div class="group-members">
                        ${generateGroupMembers(group.recent_members || [])}
                    </div>
                    
                    <div class="group-recent-activity">
                        <h4>Recent Activity</h4>
                        ${generateGroupActivity(group.recent_activity || [])}
                    </div>
                    
                    <div class="group-actions">
                        ${generateGroupActions(group)}
                    </div>
                </div>
            `).join('');
        }

        function generateGroupMembers(members) {
            if (members.length === 0) {
                return '<div class="group-member">No members yet</div>';
            }
            
            return members.slice(0, 5).map(member => `
                <div class="group-member">
                    <div class="group-member-avatar">
                        ${member.avatar_url ? 
                            `<img src="${member.avatar_url}" alt="${escapeHtml(member.display_name)}">` : 
                            'ðŸ‘¤'
                        }
                    </div>
                    <span>${escapeHtml(member.display_name)}</span>
                </div>
            `).join('');
        }

        function generateGroupActivity(activities) {
            if (activities.length === 0) {
                return '<div class="activity-item">No recent activity</div>';
            }
            
            return activities.slice(0, 3).map(activity => `
                <div class="activity-item">
                    <div class="activity-avatar">
                        ${activity.user_avatar ? 
                            `<img src="${activity.user_avatar}" alt="${escapeHtml(activity.user_name)}">` : 
                            'ðŸ‘¤'
                        }
                    </div>
                    <div class="activity-content">
                        <strong>${escapeHtml(activity.user_name)}</strong> ${activity.action}
                    </div>
                    <div class="activity-time">${formatTimeAgo(activity.created_at)}</div>
                </div>
            `).join('');
        }

        function generateGroupActions(group) {
            const isMember = group.is_member;
            const isOwner = group.is_owner;
            
            if (isOwner) {
                return `
                    <button class="group-action-btn primary" onclick="event.stopPropagation(); manageGroup('${group.id}')">
                        Manage
                    </button>
                    <button class="group-action-btn" onclick="event.stopPropagation(); shareGroup('${group.id}')">
                        Share
                    </button>
                `;
            } else if (isMember) {
                return `
                    <button class="group-action-btn primary" onclick="event.stopPropagation(); leaveGroup('${group.id}')">
                        Leave
                    </button>
                    <button class="group-action-btn" onclick="event.stopPropagation(); viewGroup('${group.id}')">
                        View
                    </button>
                `;
            } else {
                return `
                    <button class="group-action-btn primary" onclick="event.stopPropagation(); joinGroup('${group.id}')">
                        Join
                    </button>
                    <button class="group-action-btn" onclick="event.stopPropagation(); viewGroup('${group.id}')">
                        View
                    </button>
                `;
            }
        }

        function getGroupIcon(type) {
            const icons = {
                'genre': 'ðŸŽ­',
                'artist': 'ðŸ‘¤',
                'local': 'ðŸ“',
                'general': 'ðŸŽµ'
            };
            return icons[type] || 'ðŸŽµ';
        }

        function filterGroups(filter) {
            // Update filter buttons
            document.querySelectorAll('.group-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-group-type="${filter}"]`).classList.add('active');
            
            currentGroupFilter = filter;
            loadGroups();
        }

        function showCreateGroupModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('groupCreateModal').style.display = 'flex';
            document.getElementById('groupName').focus();
        }

        function closeGroupCreateModal() {
            document.getElementById('groupCreateModal').style.display = 'none';
            document.getElementById('groupCreateForm').reset();
        }

        async function createGroup(event) {
            event.preventDefault();
            
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            const formData = {
                name: document.getElementById('groupName').value,
                description: document.getElementById('groupDescription').value,
                type: document.getElementById('groupType').value,
                genre: document.getElementById('groupGenre').value,
                privacy: document.getElementById('groupPrivacy').value
            };
            
            try {
                const response = await fetch('/api/friends?groups=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Group created successfully!', 'success');
                    closeGroupCreateModal();
                    await loadGroups();
                } else {
                    showNotification(data.error || 'Failed to create group', 'error');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                showNotification('Network error', 'error');
            }
        }

        async function joinGroup(groupId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/friends?groups=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        group_id: groupId,
                        action: 'join'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Joined group successfully!', 'success');
                    await loadGroups();
                } else {
                    showNotification(data.error || 'Failed to join group', 'error');
                }
            } catch (error) {
                console.error('Error joining group:', error);
                showNotification('Network error', 'error');
            }
        }

        async function leaveGroup(groupId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/friends?groups=true', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        group_id: groupId,
                        action: 'leave'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Left group successfully', 'success');
                    await loadGroups();
                } else {
                    showNotification(data.error || 'Failed to leave group', 'error');
                }
            } catch (error) {
                console.error('Error leaving group:', error);
                showNotification('Network error', 'error');
            }
        }

        function viewGroup(groupId) {
            // For now, just show a notification
            // In a full implementation, this would open a detailed group view
            showNotification('Group view coming soon!', 'info');
        }

        function manageGroup(groupId) {
            showNotification('Group management coming soon!', 'info');
        }

        function shareGroup(groupId) {
            const shareUrl = `${window.location.origin}/group/${groupId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this music group!',
                    text: 'Join this music community on TrackShare',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('Group link copied to clipboard!', 'success');
                });
            }
        }

        function displayGroupsEmpty() {
            const groupsGrid = document.getElementById('groupsGrid');
            groupsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">ðŸŽ­</div>
                    <h3>No Groups Found</h3>
                    <p>No groups match your current filter. Try a different category or create your own group!</p>
                    ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreateGroupModal()">Create Group</button>' : ''}
                </div>
            `;
        }

        function displayGroupsError() {
            const groupsGrid = document.getElementById('groupsGrid');
            groupsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Groups</h3>
                    <p>Something went wrong while loading groups.</p>
                    <button class="btn btn-primary" onclick="loadGroups()">Try Again</button>
                </div>
            `;
        }

        // Music Challenges & Competitions Functions
        let currentChallengeFilter = 'all';
        let userChallenges = [];

        async function loadChallenges() {
            const challengesGrid = document.getElementById('challengesGrid');
            challengesGrid.innerHTML = '<div class="loading">Loading challenges...</div>';
            
            try {
                const response = await fetch(`/api/posts?challenges=true&filter=${currentChallengeFilter}`, {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.challenges) {
                    displayChallenges(data.challenges);
                } else {
                    displayChallengesEmpty();
                }
            } catch (error) {
                console.error('Error loading challenges:', error);
                displayChallengesError();
            }
        }

        function displayChallenges(challenges) {
            const challengesGrid = document.getElementById('challengesGrid');
            
            if (challenges.length === 0) {
                displayChallengesEmpty();
                return;
            }
            
            challengesGrid.innerHTML = challenges.map(challenge => `
                <div class="challenge-card ${challenge.featured ? 'featured' : ''}" onclick="viewChallenge('${challenge.id}')">
                    <div class="challenge-header">
                        <div class="challenge-icon">
                            ${getChallengeIcon(challenge.type)}
                        </div>
                        <div class="challenge-info">
                            <h3>${escapeHtml(challenge.name)}</h3>
                            <div class="challenge-meta">
                                ${challenge.type.charAt(0).toUpperCase() + challenge.type.slice(1)} â€¢ ${challenge.duration}
                                ${challenge.genre ? ` â€¢ ${challenge.genre}` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="challenge-description">
                        ${escapeHtml(challenge.description || 'No description available')}
                    </div>
                    
                    <div class="challenge-stats">
                        <div class="challenge-stat">
                            <div class="challenge-stat-number">${challenge.participants || 0}</div>
                            <div class="challenge-stat-label">Participants</div>
                        </div>
                        <div class="challenge-stat">
                            <div class="challenge-stat-number">${challenge.goal}</div>
                            <div class="challenge-stat-label">Goal</div>
                        </div>
                        <div class="challenge-stat">
                            <div class="challenge-stat-number">${challenge.time_left || '0d'}</div>
                            <div class="challenge-stat-label">Time Left</div>
                        </div>
                    </div>
                    
                    ${challenge.user_progress !== undefined ? `
                        <div class="challenge-progress">
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: ${(challenge.user_progress / challenge.goal) * 100}%"></div>
                            </div>
                            <div class="challenge-progress-text">
                                ${challenge.user_progress}/${challenge.goal} completed
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="challenge-rewards">
                        ${generateChallengeRewards(challenge.rewards || [])}
                    </div>
                    
                    <div class="challenge-actions">
                        ${generateChallengeActions(challenge)}
                    </div>
                </div>
            `).join('');
        }

        function generateChallengeRewards(rewards) {
            if (rewards.length === 0) {
                return '<div class="challenge-reward"><span class="challenge-reward-icon">ðŸ†</span> Completion Badge</div>';
            }
            
            return rewards.map(reward => `
                <div class="challenge-reward">
                    <span class="challenge-reward-icon">${getRewardIcon(reward.type)}</span>
                    ${escapeHtml(reward.name)}
                </div>
            `).join('');
        }

        function generateChallengeActions(challenge) {
            const isParticipant = challenge.is_participant;
            const isCompleted = challenge.user_progress >= challenge.goal;
            const isExpired = challenge.time_left === '0d';
            
            if (isCompleted) {
                return `
                    <button class="challenge-action-btn completed" onclick="event.stopPropagation(); claimReward('${challenge.id}')">
                        Claim Reward
                    </button>
                    <button class="challenge-action-btn" onclick="event.stopPropagation(); viewChallenge('${challenge.id}')">
                        View Details
                    </button>
                `;
            } else if (isParticipant) {
                return `
                    <button class="challenge-action-btn primary" onclick="event.stopPropagation(); updateProgress('${challenge.id}')">
                        Update Progress
                    </button>
                    <button class="challenge-action-btn" onclick="event.stopPropagation(); viewChallenge('${challenge.id}')">
                        View Details
                    </button>
                `;
            } else if (isExpired) {
                return `
                    <button class="challenge-action-btn" disabled>
                        Challenge Ended
                    </button>
                    <button class="challenge-action-btn" onclick="event.stopPropagation(); viewChallenge('${challenge.id}')">
                        View Results
                    </button>
                `;
            } else {
                return `
                    <button class="challenge-action-btn primary" onclick="event.stopPropagation(); joinChallenge('${challenge.id}')">
                        Join Challenge
                    </button>
                    <button class="challenge-action-btn" onclick="event.stopPropagation(); viewChallenge('${challenge.id}')">
                        View Details
                    </button>
                `;
            }
        }

        function getChallengeIcon(type) {
            const icons = {
                'listening': 'ðŸŽ§',
                'discovery': 'ðŸ”',
                'sharing': 'ðŸ“¤',
                'playlist': 'ðŸ“',
                'genre': 'ðŸŽ­'
            };
            return icons[type] || 'ðŸ†';
        }

        function getRewardIcon(type) {
            const icons = {
                'badge': 'ðŸ†',
                'points': 'â­',
                'trophy': 'ðŸ¥‡',
                'medal': 'ðŸ¥‰',
                'certificate': 'ðŸ“œ'
            };
            return icons[type] || 'ðŸ†';
        }

        function filterChallenges(filter) {
            // Update filter buttons
            document.querySelectorAll('.challenge-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-challenge-type="${filter}"]`).classList.add('active');
            
            currentChallengeFilter = filter;
            loadChallenges();
        }

        function showCreateChallengeModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('challengeCreateModal').style.display = 'flex';
            document.getElementById('challengeName').focus();
        }

        function closeChallengeCreateModal() {
            document.getElementById('challengeCreateModal').style.display = 'none';
            document.getElementById('challengeCreateForm').reset();
        }

        async function createChallenge(event) {
            event.preventDefault();
            
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            const formData = {
                name: document.getElementById('challengeName').value,
                description: document.getElementById('challengeDescription').value,
                type: document.getElementById('challengeType').value,
                duration: document.getElementById('challengeDuration').value,
                goal: document.getElementById('challengeGoal').value,
                reward: document.getElementById('challengeReward').value
            };
            
            try {
                const response = await fetch('/api/posts?challenges=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Challenge created successfully!', 'success');
                    closeChallengeCreateModal();
                    await loadChallenges();
                } else {
                    showNotification(data.error || 'Failed to create challenge', 'error');
                }
            } catch (error) {
                console.error('Error creating challenge:', error);
                showNotification('Network error', 'error');
            }
        }

        async function joinChallenge(challengeId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?challenges=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        action: 'join'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Joined challenge successfully!', 'success');
                    await loadChallenges();
                } else {
                    showNotification(data.error || 'Failed to join challenge', 'error');
                }
            } catch (error) {
                console.error('Error joining challenge:', error);
                showNotification('Network error', 'error');
            }
        }

        async function updateProgress(challengeId) {
            if (!isSignedIn || !userToken) return;
            
            const progress = prompt('Enter your progress (e.g., 5 songs, 2 hours):');
            if (!progress) return;
            
            try {
                const response = await fetch('/api/posts?challenges=true', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        progress: progress
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Progress updated successfully!', 'success');
                    await loadChallenges();
                } else {
                    showNotification(data.error || 'Failed to update progress', 'error');
                }
            } catch (error) {
                console.error('Error updating progress:', error);
                showNotification('Network error', 'error');
            }
        }

        async function claimReward(challengeId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?challenges=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        action: 'claim_reward'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Reward claimed successfully!', 'success');
                    await loadChallenges();
                } else {
                    showNotification(data.error || 'Failed to claim reward', 'error');
                }
            } catch (error) {
                console.error('Error claiming reward:', error);
                showNotification('Network error', 'error');
            }
        }

        function viewChallenge(challengeId) {
            // For now, just show a notification
            // In a full implementation, this would open a detailed challenge view
            showNotification('Challenge details coming soon!', 'info');
        }

        function displayChallengesEmpty() {
            const challengesGrid = document.getElementById('challengesGrid');
            challengesGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">ðŸ†</div>
                    <h3>No Challenges Found</h3>
                    <p>No challenges match your current filter. Try a different category or create your own challenge!</p>
                    ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreateChallengeModal()">Create Challenge</button>' : ''}
                </div>
            `;
        }

        function displayChallengesError() {
            const challengesGrid = document.getElementById('challengesGrid');
            challengesGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Challenges</h3>
                    <p>Something went wrong while loading challenges.</p>
                    <button class="btn btn-primary" onclick="loadChallenges()">Try Again</button>
                </div>
            `;
        }

        // Music Events & Festivals Functions
        let currentEventFilter = 'all';
        let userEvents = [];

        async function loadEvents() {
            const eventsGrid = document.getElementById('eventsGrid');
            eventsGrid.innerHTML = '<div class="loading">Loading events...</div>';
            
            try {
                const response = await fetch(`/api/posts?events=true&filter=${currentEventFilter}`, {
                    headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                });
                
                const data = await response.json();
                
                if (data.success && data.events) {
                    displayEvents(data.events);
                } else {
                    displayEventsEmpty();
                }
            } catch (error) {
                console.error('Error loading events:', error);
                displayEventsError();
            }
        }

        function displayEvents(events) {
            const eventsGrid = document.getElementById('eventsGrid');
            
            if (events.length === 0) {
                displayEventsEmpty();
                return;
            }
            
            eventsGrid.innerHTML = events.map(event => `
                <div class="event-card ${event.status}" onclick="viewEvent('${event.id}')">
                    <div class="event-header">
                        <div class="event-image">
                            ${event.image ? `<img src="${event.image}" alt="${event.name}">` : getEventIcon(event.type)}
                        </div>
                        <div class="event-info">
                            <h3>${escapeHtml(event.name)}</h3>
                            <div class="event-meta">
                                ${event.type.charAt(0).toUpperCase() + event.type.slice(1).replace('-', ' ')}
                                ${event.genre && event.genre !== 'all' ? ` â€¢ ${event.genre.charAt(0).toUpperCase() + event.genre.slice(1)}` : ''}
                            </div>
                            <div class="event-date">
                                ${formatEventDate(event.date)} â€¢ ${event.location}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-description">
                        ${escapeHtml(event.description || 'No description available')}
                    </div>
                    
                    ${event.countdown ? `
                        <div class="event-countdown">
                            ${generateCountdown(event.countdown)}
                        </div>
                    ` : ''}
                    
                    <div class="event-details">
                        <div class="event-detail">
                            <span class="event-detail-icon">ðŸ“</span>
                            ${escapeHtml(event.location)}
                        </div>
                        <div class="event-detail">
                            <span class="event-detail-icon">ðŸ’°</span>
                            ${event.price || 'Free'}
                        </div>
                        <div class="event-detail">
                            <span class="event-detail-icon">ðŸ‘¥</span>
                            ${event.capacity ? `${event.attendees || 0}/${event.capacity}` : 'Unlimited'}
                        </div>
                        <div class="event-detail">
                            <span class="event-detail-icon">ðŸŽµ</span>
                            ${event.artists ? event.artists.split(',').length : 0} Artists
                        </div>
                    </div>
                    
                    ${event.artists ? `
                        <div class="event-lineup">
                            <h4>Featured Artists</h4>
                            <div class="lineup-artists">
                                ${generateLineupArtists(event.artists)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="event-stats">
                        <div class="event-stat">
                            <div class="event-stat-number">${event.attendees || 0}</div>
                            <div class="event-stat-label">Attendees</div>
                        </div>
                        <div class="event-stat">
                            <div class="event-stat-number">${event.interested || 0}</div>
                            <div class="event-stat-label">Interested</div>
                        </div>
                        <div class="event-stat">
                            <div class="event-stat-number">${event.shares || 0}</div>
                            <div class="event-stat-label">Shares</div>
                        </div>
                    </div>
                    
                    <div class="event-actions">
                        ${generateEventActions(event)}
                    </div>
                </div>
            `).join('');
        }

        function generateCountdown(countdown) {
            return `
                <div class="countdown-item">
                    <div class="countdown-number">${countdown.days || 0}</div>
                    <div class="countdown-label">Days</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-number">${countdown.hours || 0}</div>
                    <div class="countdown-label">Hours</div>
                </div>
                <div class="countdown-item">
                    <div class="countdown-number">${countdown.minutes || 0}</div>
                    <div class="countdown-label">Minutes</div>
                </div>
            `;
        }

        function generateLineupArtists(artists) {
            return artists.split(',').slice(0, 5).map(artist => `
                <div class="lineup-artist">
                    <div class="lineup-artist-avatar">
                        ${artist.trim().charAt(0).toUpperCase()}
                    </div>
                    ${escapeHtml(artist.trim())}
                </div>
            `).join('');
        }

        function generateEventActions(event) {
            const isAttending = event.is_attending;
            const isInterested = event.is_interested;
            const isLive = event.status === 'live';
            const isUpcoming = event.status === 'upcoming';
            
            if (isLive) {
                return `
                    <button class="event-action-btn live" onclick="event.stopPropagation(); joinLiveEvent('${event.id}')">
                        Join Live
                    </button>
                    <button class="event-action-btn" onclick="event.stopPropagation(); shareEvent('${event.id}')">
                        Share
                    </button>
                `;
            } else if (isAttending) {
                return `
                    <button class="event-action-btn attending" onclick="event.stopPropagation(); leaveEvent('${event.id}')">
                        Attending
                    </button>
                    <button class="event-action-btn" onclick="event.stopPropagation(); shareEvent('${event.id}')">
                        Share
                    </button>
                `;
            } else if (isInterested) {
                return `
                    <button class="event-action-btn primary" onclick="event.stopPropagation(); attendEvent('${event.id}')">
                        Attend
                    </button>
                    <button class="event-action-btn" onclick="event.stopPropagation(); uninterestedEvent('${event.id}')">
                        Not Interested
                    </button>
                `;
            } else {
                return `
                    <button class="event-action-btn primary" onclick="event.stopPropagation(); interestedEvent('${event.id}')">
                        Interested
                    </button>
                    <button class="event-action-btn" onclick="event.stopPropagation(); shareEvent('${event.id}')">
                        Share
                    </button>
                `;
            }
        }

        function getEventIcon(type) {
            const icons = {
                'concert': 'ðŸŽµ',
                'festival': 'ðŸŽª',
                'live-stream': 'ðŸ“º',
                'virtual-event': 'ðŸ’»',
                'listening-party': 'ðŸŽ§',
                'music-meetup': 'ðŸ‘¥'
            };
            return icons[type] || 'ðŸŽµ';
        }

        function formatEventDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return 'Past Event';
            } else if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Tomorrow';
            } else if (diffDays <= 7) {
                return `In ${diffDays} days`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function filterEvents(filter) {
            // Update filter buttons
            document.querySelectorAll('.event-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-event-type="${filter}"]`).classList.add('active');
            
            currentEventFilter = filter;
            loadEvents();
        }

        function showCreateEventModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('eventCreateModal').style.display = 'flex';
            document.getElementById('eventName').focus();
        }

        function closeEventCreateModal() {
            document.getElementById('eventCreateModal').style.display = 'none';
            document.getElementById('eventCreateForm').reset();
        }

        async function createEvent(event) {
            event.preventDefault();
            
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            const formData = {
                name: document.getElementById('eventName').value,
                description: document.getElementById('eventDescription').value,
                type: document.getElementById('eventType').value,
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                artists: document.getElementById('eventArtists').value,
                genre: document.getElementById('eventGenre').value,
                capacity: document.getElementById('eventCapacity').value,
                price: document.getElementById('eventPrice').value
            };
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Event created successfully!', 'success');
                    closeEventCreateModal();
                    await loadEvents();
                } else {
                    showNotification(data.error || 'Failed to create event', 'error');
                }
            } catch (error) {
                console.error('Error creating event:', error);
                showNotification('Network error', 'error');
            }
        }

        async function interestedEvent(eventId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        action: 'interested'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Marked as interested!', 'success');
                    await loadEvents();
                } else {
                    showNotification(data.error || 'Failed to mark interest', 'error');
                }
            } catch (error) {
                console.error('Error marking interest:', error);
                showNotification('Network error', 'error');
            }
        }

        async function attendEvent(eventId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        action: 'attend'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('You\'re attending this event!', 'success');
                    await loadEvents();
                } else {
                    showNotification(data.error || 'Failed to attend event', 'error');
                }
            } catch (error) {
                console.error('Error attending event:', error);
                showNotification('Network error', 'error');
            }
        }

        async function leaveEvent(eventId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        action: 'leave'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('You\'re no longer attending this event', 'info');
                    await loadEvents();
                } else {
                    showNotification(data.error || 'Failed to leave event', 'error');
                }
            } catch (error) {
                console.error('Error leaving event:', error);
                showNotification('Network error', 'error');
            }
        }

        async function joinLiveEvent(eventId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        action: 'join_live'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Joined live event!', 'success');
                    // In a real implementation, this would open the live stream
                    window.open(data.stream_url || '#', '_blank');
                } else {
                    showNotification(data.error || 'Failed to join live event', 'error');
                }
            } catch (error) {
                console.error('Error joining live event:', error);
                showNotification('Network error', 'error');
            }
        }

        async function shareEvent(eventId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/posts?events=true', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        action: 'share'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Event shared successfully!', 'success');
                    await loadEvents();
                } else {
                    showNotification(data.error || 'Failed to share event', 'error');
                }
            } catch (error) {
                console.error('Error sharing event:', error);
                showNotification('Network error', 'error');
            }
        }

        function viewEvent(eventId) {
            // For now, just show a notification
            // In a full implementation, this would open a detailed event view
            showNotification('Event details coming soon!', 'info');
        }

        function displayEventsEmpty() {
            const eventsGrid = document.getElementById('eventsGrid');
            eventsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">ðŸŽª</div>
                    <h3>No Events Found</h3>
                    <p>No events match your current filter. Try a different category or create your own event!</p>
                    ${isSignedIn ? '<button class="btn btn-primary" onclick="showCreateEventModal()">Create Event</button>' : ''}
                </div>
            `;
        }

        function displayEventsError() {
            const eventsGrid = document.getElementById('eventsGrid');
            eventsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Events</h3>
                    <p>Something went wrong while loading events.</p>
                    <button class="btn btn-primary" onclick="loadEvents()">Try Again</button>
                </div>
            `;
        }

        // Playlist Analytics Functions
        let currentAnalyticsPeriod = '7d';
        let currentAnalyticsTab = 'overview';
        let analyticsData = {};

        async function loadPlaylistAnalytics() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            const analyticsGrid = document.getElementById('analyticsGrid');
            const analyticsSummary = document.getElementById('analyticsSummary');
            
            analyticsGrid.innerHTML = '<div class="loading">Loading analytics...</div>';
            analyticsSummary.innerHTML = '<div class="loading">Loading summary...</div>';
            
            try {
                const response = await fetch(`/api/profile?analytics=true&period=${currentAnalyticsPeriod}&type=${currentAnalyticsTab}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    analyticsData = data.analytics;
                    displayAnalyticsSummary(data.summary);
                    displayAnalyticsContent(data.analytics);
                } else {
                    displayAnalyticsError();
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                displayAnalyticsError();
            }
        }

        function displayAnalyticsSummary(summary) {
            const analyticsSummary = document.getElementById('analyticsSummary');
            
            analyticsSummary.innerHTML = `
                <h3>Analytics Summary - ${getPeriodLabel(currentAnalyticsPeriod)}</h3>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_plays || 0}</div>
                        <div class="summary-stat-label">Total Plays</div>
                        <div class="summary-stat-change ${getChangeClass(summary.plays_change)}">
                            ${formatChange(summary.plays_change)} from last period
                        </div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_likes || 0}</div>
                        <div class="summary-stat-label">Total Likes</div>
                        <div class="summary-stat-change ${getChangeClass(summary.likes_change)}">
                            ${formatChange(summary.likes_change)} from last period
                        </div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_comments || 0}</div>
                        <div class="summary-stat-label">Total Comments</div>
                        <div class="summary-stat-change ${getChangeClass(summary.comments_change)}">
                            ${formatChange(summary.comments_change)} from last period
                        </div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_shares || 0}</div>
                        <div class="summary-stat-label">Total Shares</div>
                        <div class="summary-stat-change ${getChangeClass(summary.shares_change)}">
                            ${formatChange(summary.shares_change)} from last period
                        </div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.avg_engagement || 0}%</div>
                        <div class="summary-stat-label">Avg Engagement</div>
                        <div class="summary-stat-change ${getChangeClass(summary.engagement_change)}">
                            ${formatChange(summary.engagement_change)} from last period
                        </div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.top_genre || 'N/A'}</div>
                        <div class="summary-stat-label">Top Genre</div>
                        <div class="summary-stat-change neutral">
                            Most played genre
                        </div>
                    </div>
                </div>
            `;
        }

        function displayAnalyticsContent(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            switch (currentAnalyticsTab) {
                case 'overview':
                    displayOverviewAnalytics(analytics);
                    break;
                case 'playlists':
                    displayPlaylistAnalytics(analytics);
                    break;
                case 'engagement':
                    displayEngagementAnalytics(analytics);
                    break;
                case 'trends':
                    displayTrendsAnalytics(analytics);
                    break;
                case 'insights':
                    displayInsightsAnalytics(analytics);
                    break;
                default:
                    displayOverviewAnalytics(analytics);
            }
        }

        function displayOverviewAnalytics(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            analyticsGrid.innerHTML = `
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-chart">
                        <h4>Daily Plays</h4>
                        <div class="chart-container">
                            ${generateChartBars(analytics.daily_plays || [])}
                        </div>
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-chart">
                        <h4>Genre Distribution</h4>
                        <div class="chart-container">
                            ${generateChartBars(analytics.genre_distribution || [])}
                        </div>
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Top Insights</h4>
                        ${generateInsights(analytics.insights || [])}
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-stats">
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.most_played_track || 'N/A'}</div>
                            <div class="playlist-analytics-stat-label">Most Played Track</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.most_played_artist || 'N/A'}</div>
                            <div class="playlist-analytics-stat-label">Most Played Artist</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.avg_session_duration || '0m'}</div>
                            <div class="playlist-analytics-stat-label">Avg Session Duration</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.total_listening_time || '0h'}</div>
                            <div class="playlist-analytics-stat-label">Total Listening Time</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayPlaylistAnalytics(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            if (!analytics.playlists || analytics.playlists.length === 0) {
                analyticsGrid.innerHTML = `
                    <div class="insights-empty">
                        <div class="insights-empty-icon">ðŸ“</div>
                        <h3>No Playlists Found</h3>
                        <p>Create some playlists to see analytics!</p>
                    </div>
                `;
                return;
            }
            
            analyticsGrid.innerHTML = analytics.playlists.map(playlist => `
                <div class="playlist-analytics-card ${playlist.featured ? 'featured' : ''}" onclick="viewPlaylistAnalytics('${playlist.id}')">
                    <div class="playlist-analytics-header-card">
                        <div class="playlist-analytics-image">
                            ${playlist.image ? `<img src="${playlist.image}" alt="${playlist.name}">` : 'ðŸ“'}
                        </div>
                        <div class="playlist-analytics-info">
                            <h3>${escapeHtml(playlist.name)}</h3>
                            <div class="playlist-analytics-meta">
                                ${playlist.track_count} tracks â€¢ ${playlist.total_duration}
                            </div>
                        </div>
                    </div>
                    
                    <div class="playlist-analytics-description">
                        ${escapeHtml(playlist.description || 'No description available')}
                    </div>
                    
                    <div class="playlist-analytics-stats">
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${playlist.plays || 0}</div>
                            <div class="playlist-analytics-stat-label">Plays</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${playlist.likes || 0}</div>
                            <div class="playlist-analytics-stat-label">Likes</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${playlist.shares || 0}</div>
                            <div class="playlist-analytics-stat-label">Shares</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${playlist.engagement_rate || 0}%</div>
                            <div class="playlist-analytics-stat-label">Engagement</div>
                        </div>
                    </div>
                    
                    <div class="playlist-analytics-chart">
                        <h4>Play Trend</h4>
                        <div class="chart-container">
                            ${generateChartBars(playlist.play_trend || [])}
                        </div>
                    </div>
                    
                    <div class="playlist-analytics-insights">
                        <h4>Insights</h4>
                        ${generatePlaylistInsights(playlist.insights || [])}
                    </div>
                    
                    <div class="playlist-analytics-actions">
                        <button class="playlist-analytics-action-btn primary" onclick="event.stopPropagation(); viewPlaylist('${playlist.id}')">
                            View Playlist
                        </button>
                        <button class="playlist-analytics-action-btn success" onclick="event.stopPropagation(); sharePlaylist('${playlist.id}')">
                            Share
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayEngagementAnalytics(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            analyticsGrid.innerHTML = `
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-chart">
                        <h4>Engagement Over Time</h4>
                        <div class="chart-container">
                            ${generateChartBars(analytics.engagement_timeline || [])}
                        </div>
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-stats">
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.avg_likes_per_post || 0}</div>
                            <div class="playlist-analytics-stat-label">Avg Likes/Post</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.avg_comments_per_post || 0}</div>
                            <div class="playlist-analytics-stat-label">Avg Comments/Post</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.avg_shares_per_post || 0}</div>
                            <div class="playlist-analytics-stat-label">Avg Shares/Post</div>
                        </div>
                        <div class="playlist-analytics-stat">
                            <div class="playlist-analytics-stat-number">${analytics.total_reach || 0}</div>
                            <div class="playlist-analytics-stat-label">Total Reach</div>
                        </div>
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Engagement Insights</h4>
                        ${generateEngagementInsights(analytics.engagement_insights || [])}
                    </div>
                </div>
            `;
        }

        function displayTrendsAnalytics(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            analyticsGrid.innerHTML = `
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-chart">
                        <h4>Music Trends</h4>
                        <div class="chart-container">
                            ${generateChartBars(analytics.music_trends || [])}
                        </div>
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Trending Insights</h4>
                        ${generateTrendInsights(analytics.trend_insights || [])}
                    </div>
                </div>
            `;
        }

        function displayInsightsAnalytics(analytics) {
            const analyticsGrid = document.getElementById('analyticsGrid');
            
            analyticsGrid.innerHTML = `
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Music Taste Analysis</h4>
                        ${generateMusicTasteInsights(analytics.music_taste || [])}
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Listening Patterns</h4>
                        ${generateListeningPatternInsights(analytics.listening_patterns || [])}
                    </div>
                </div>
                
                <div class="playlist-analytics-card">
                    <div class="playlist-analytics-insights">
                        <h4>Recommendations</h4>
                        ${generateRecommendationInsights(analytics.recommendations || [])}
                    </div>
                </div>
            `;
        }

        function generateChartBars(data) {
            if (!data || data.length === 0) {
                return '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 2rem;">No data available</div>';
            }
            
            const maxValue = Math.max(...data.map(item => item.value));
            
            return data.map(item => `
                <div class="chart-bar" style="height: ${(item.value / maxValue) * 100}%">
                    <div class="chart-bar-label">${item.label}</div>
                </div>
            `).join('');
        }

        function generateInsights(insights) {
            if (!insights || insights.length === 0) {
                return '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 1rem;">No insights available</div>';
            }
            
            return insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon || 'ðŸ’¡'}</div>
                    <div class="insight-text">${escapeHtml(insight.text)}</div>
                </div>
            `).join('');
        }

        function generatePlaylistInsights(insights) {
            return generateInsights(insights);
        }

        function generateEngagementInsights(insights) {
            return generateInsights(insights);
        }

        function generateTrendInsights(insights) {
            return generateInsights(insights);
        }

        function generateMusicTasteInsights(insights) {
            return generateInsights(insights);
        }

        function generateListeningPatternInsights(insights) {
            return generateInsights(insights);
        }

        function generateRecommendationInsights(insights) {
            return generateInsights(insights);
        }

        function filterAnalytics(period) {
            // Update filter buttons
            document.querySelectorAll('.playlist-analytics-filter').forEach(filter => {
                filter.classList.remove('active');
            });
            document.querySelector(`[data-analytics-period="${period}"]`).classList.add('active');
            
            currentAnalyticsPeriod = period;
            loadPlaylistAnalytics();
        }

        function switchAnalyticsTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.playlist-analytics-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            document.querySelector(`[data-analytics-type="${tab}"]`).classList.add('active');
            
            currentAnalyticsTab = tab;
            displayAnalyticsContent(analyticsData);
        }

        function getPeriodLabel(period) {
            const labels = {
                '7d': 'Last 7 Days',
                '30d': 'Last 30 Days',
                '90d': 'Last 90 Days',
                'all': 'All Time'
            };
            return labels[period] || period;
        }

        function getChangeClass(change) {
            if (change > 0) return 'positive';
            if (change < 0) return 'negative';
            return 'neutral';
        }

        function formatChange(change) {
            if (change > 0) return `+${change}%`;
            if (change < 0) return `${change}%`;
            return '0%';
        }

        function viewPlaylistAnalytics(playlistId) {
            showNotification('Playlist analytics details coming soon!', 'info');
        }

        function displayAnalyticsError() {
            const analyticsGrid = document.getElementById('analyticsGrid');
            analyticsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Analytics</h3>
                    <p>Something went wrong while loading analytics.</p>
                    <button class="btn btn-primary" onclick="loadPlaylistAnalytics()">Try Again</button>
                </div>
            `;
        }

        // Music Achievements Functions
        let currentAchievementFilter = 'all';
        let currentAchievementTab = 'listening';
        let achievementsData = {};

        async function loadAchievements() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            const achievementsGrid = document.getElementById('achievementsGrid');
            const achievementSummary = document.getElementById('achievementSummary');
            
            achievementsGrid.innerHTML = '<div class="loading">Loading achievements...</div>';
            achievementSummary.innerHTML = '<div class="loading">Loading summary...</div>';
            
            try {
                const response = await fetch(`/api/profile?achievements=true&filter=${currentAchievementFilter}&type=${currentAchievementTab}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    achievementsData = data.achievements;
                    displayAchievementSummary(data.summary);
                    displayAchievements(data.achievements);
                } else {
                    displayAchievementsError();
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
                displayAchievementsError();
            }
        }

        function displayAchievementSummary(summary) {
            const achievementSummary = document.getElementById('achievementSummary');
            
            achievementSummary.innerHTML = `
                <h3>Achievement Summary</h3>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_earned || 0}</div>
                        <div class="summary-stat-label">Achievements Earned</div>
                        <div class="summary-stat-description">Out of ${summary.total_available || 0} available</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.total_points || 0}</div>
                        <div class="summary-stat-label">Total Points</div>
                        <div class="summary-stat-description">Earned from achievements</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.rarity_breakdown?.rare || 0}</div>
                        <div class="summary-stat-label">Rare Badges</div>
                        <div class="summary-stat-description">ðŸ’Ž Rare achievements</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.rarity_breakdown?.epic || 0}</div>
                        <div class="summary-stat-label">Epic Badges</div>
                        <div class="summary-stat-description">ðŸ”¥ Epic achievements</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.completion_rate || 0}%</div>
                        <div class="summary-stat-label">Completion Rate</div>
                        <div class="summary-stat-description">Overall progress</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-number">${summary.recent_earned || 0}</div>
                        <div class="summary-stat-label">Recent Achievements</div>
                        <div class="summary-stat-description">This week</div>
                    </div>
                </div>
            `;
        }

        function displayAchievements(achievements) {
            const achievementsGrid = document.getElementById('achievementsGrid');
            
            if (!achievements || achievements.length === 0) {
                achievementsGrid.innerHTML = `
                    <div class="insights-empty">
                        <div class="insights-empty-icon">ðŸ†</div>
                        <h3>No Achievements Found</h3>
                        <p>Start using TrackShare to earn your first achievements!</p>
                    </div>
                `;
                return;
            }
            
            achievementsGrid.innerHTML = achievements.map(achievement => `
                <div class="achievement-card ${achievement.status}" onclick="viewAchievement('${achievement.id}')">
                    <div class="achievement-icon">
                        ${achievement.icon || 'ðŸ†'}
                    </div>
                    
                    <div class="achievement-title">${escapeHtml(achievement.title)}</div>
                    <div class="achievement-description">${escapeHtml(achievement.description)}</div>
                    
                    ${achievement.status === 'progress' ? `
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar">
                                <div class="achievement-progress-fill" style="width: ${achievement.progress_percentage || 0}%"></div>
                            </div>
                            <div class="achievement-progress-text">
                                ${achievement.current_value || 0} / ${achievement.target_value || 0} ${achievement.progress_unit || ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${achievement.reward ? `
                        <div class="achievement-reward">
                            <div class="achievement-reward-icon">${achievement.reward.icon || 'â­'}</div>
                            <div class="achievement-reward-text">${escapeHtml(achievement.reward.text)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="achievement-stats">
                        <div class="achievement-stat">
                            <div class="achievement-stat-number">${achievement.points || 0}</div>
                            <div class="achievement-stat-label">Points</div>
                        </div>
                        <div class="achievement-stat">
                            <div class="achievement-stat-number">${achievement.rarity || 'Common'}</div>
                            <div class="achievement-stat-label">Rarity</div>
                        </div>
                    </div>
                    
                    <div class="achievement-actions">
                        ${achievement.status === 'earned' ? `
                            <button class="achievement-action-btn claim" onclick="event.stopPropagation(); claimAchievement('${achievement.id}')">
                                Claim Reward
                            </button>
                        ` : achievement.status === 'progress' ? `
                            <button class="achievement-action-btn primary" onclick="event.stopPropagation(); viewProgress('${achievement.id}')">
                                View Progress
                            </button>
                        ` : `
                            <button class="achievement-action-btn primary" onclick="event.stopPropagation(); viewRequirements('${achievement.id}')">
                                View Requirements
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function filterAchievements(filter) {
            // Update filter buttons
            document.querySelectorAll('.achievement-filter').forEach(filterEl => {
                filterEl.classList.remove('active');
            });
            document.querySelector(`[data-achievement-filter="${filter}"]`).classList.add('active');
            
            currentAchievementFilter = filter;
            loadAchievements();
        }

        function switchAchievementTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.achievement-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            document.querySelector(`[data-achievement-type="${tab}"]`).classList.add('active');
            
            currentAchievementTab = tab;
            loadAchievements();
        }

        function viewAchievement(achievementId) {
            showNotification('Achievement details coming soon!', 'info');
        }

        function claimAchievement(achievementId) {
            showNotification('Reward claimed!', 'success');
        }

        function viewProgress(achievementId) {
            showNotification('Progress details coming soon!', 'info');
        }

        function viewRequirements(achievementId) {
            showNotification('Requirements coming soon!', 'info');
        }

        function displayAchievementsError() {
            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = `
                <div class="insights-empty">
                    <div class="insights-empty-icon">âš ï¸</div>
                    <h3>Error Loading Achievements</h3>
                    <p>Something went wrong while loading achievements.</p>
                    <button class="btn btn-primary" onclick="loadAchievements()">Try Again</button>
                </div>
            `;
        }

        // Missing JavaScript Functions
        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters) {
                const isVisible = advancedFilters.style.display !== 'none';
                advancedFilters.style.display = isVisible ? 'none' : 'block';
                
                // Update button state
                const filterBtn = document.querySelector('.filter-btn');
                if (filterBtn) {
                    filterBtn.classList.toggle('active', !isVisible);
                }
            }
        }

        function showSignInModal() {
            const signInModal = document.getElementById('signInModal');
            if (signInModal) {
                signInModal.style.display = 'flex';
            }
        }

        function hideSignInModal() {
            const signInModal = document.getElementById('signInModal');
            if (signInModal) {
                signInModal.style.display = 'none';
            }
        }

        // Missing JavaScript Functions
        function clearFilters() {
            // Reset all filter dropdowns to default values
            const genreFilter = document.getElementById('genreFilter');
            const yearFilter = document.getElementById('yearFilter');
            const popularityFilter = document.getElementById('popularityFilter');
            const explicitFilter = document.getElementById('explicitFilter');
            const sortByFilter = document.getElementById('sortByFilter');
            const artistFilter = document.getElementById('artistFilter');
            const albumFilter = document.getElementById('albumFilter');
            
            if (genreFilter) genreFilter.value = 'any';
            if (yearFilter) yearFilter.value = 'any';
            if (popularityFilter) popularityFilter.value = 'any';
            if (explicitFilter) explicitFilter.value = 'any';
            if (sortByFilter) sortByFilter.value = 'relevance';
            if (artistFilter) artistFilter.value = '';
            if (albumFilter) albumFilter.value = '';
            
            // Hide the advanced filters panel
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters) {
                advancedFilters.style.display = 'none';
            }
            
            // Clear search and go back to trending
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Switch back to trending
            switchGenre('all');
        }

        // Enhanced switchGenre function
        async function switchGenre(genre) {
            currentGenre = genre;
            
            // Update tab visual state
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-genre="${genre}"]`).classList.add('active');
            
            // Show loading state
            showLoadingIndicator();
            
            // Check client-side cache first
            if (genreCache[genre]) {
                displayTracks(genreCache[genre]);
                hideLoadingIndicator();
                updateDiscoveryStats();
                return;
            }
            
            // Fetch from API based on discovery type
            try {
                let response;
                if (genre === 'recommendations') {
                    response = await fetch('/api/profile?recommendations=true&limit=20', {
                        headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                    });
                } else if (genre === 'playlists') {
                    response = await fetch('/api/posts?playlists=true&limit=20', {
                        headers: isSignedIn ? { 'Authorization': `Bearer ${userToken}` } : {}
                    });
                } else {
                    response = await fetch(`/api/trending?genre=${genre}&limit=${calculateTracksPerPage()}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const tracks = data.tracks || data.recommendations || data.playlists || [];
                    genreCache[genre] = tracks;
                    displayTracks(tracks);
                    updateDiscoveryStats();
                } else {
                    showError('Failed to load music');
                }
            } catch (error) {
                console.error('Genre fetch error:', error);
                showError('Network error');
            } finally {
                hideLoadingIndicator();
            }
        }

        // Friend Management Functions
        async function loadFriendsData() {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/friends', {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return {
                        friends: data.friends || [],
                        requests: data.requests || [],
                        suggestions: data.suggestions || []
                    };
                }
            } catch (error) {
                console.error('Error loading friends data:', error);
            }
            
            return { friends: [], requests: [], suggestions: [] };
        }

        async function sendFriendRequest(userId) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        action: 'request',
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Friend request sent!', 'success');
                    // Refresh friends data
                    await loadFriendsData();
                } else {
                    showNotification(data.error || 'Failed to send friend request', 'error');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Network error', 'error');
            }
        }

        async function respondToFriendRequest(requestId, action) {
            if (!isSignedIn || !userToken) return;
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        action: action,
                        request_id: requestId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Friend request ${action === 'accept' ? 'accepted' : 'declined'}!`, 'success');
                    // Refresh friends data
                    await loadFriendsData();
                } else {
                    showNotification(data.error || 'Failed to respond to friend request', 'error');
                }
            } catch (error) {
                console.error('Error responding to friend request:', error);
                showNotification('Network error', 'error');
            }
        }

        async function removeFriend(userId) {
            if (!isSignedIn || !userToken) return;
            
            if (!confirm('Are you sure you want to remove this friend?')) return;
            
            try {
                const response = await fetch('/api/friends', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Friend removed', 'success');
                    // Refresh friends data
                    await loadFriendsData();
                } else {
                    showNotification(data.error || 'Failed to remove friend', 'error');
                }
            } catch (error) {
                console.error('Error removing friend:', error);
                showNotification('Network error', 'error');
            }
        }

        // Helper function to create feed post HTML
        function createFeedPostHTML(post) {
            return `
                <div class="feed-post" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-avatar">
                            ${post.profiles?.display_name?.charAt(0) || 'ðŸŽµ'}
                        </div>
                        <div class="post-user-info">
                            <h4>${escapeHtml(post.profiles?.display_name || 'TrackShare Official')}</h4>
                            <p>${formatTimeAgo(post.posted_at)}</p>
                        </div>
                    </div>
                    
                    <div class="post-content">
                        <div class="post-track">
                            <div class="post-track-artwork">
                                ${post.track_artwork_url ? 
                                    `<img src="${post.track_artwork_url}" alt="${escapeHtml(post.track_title)}" loading="lazy">` : 
                                    'ðŸŽµ'
                                }
                            </div>
                            <div class="post-track-info">
                                <h5>${escapeHtml(post.track_title)}</h5>
                                <p>${escapeHtml(post.track_artist)}</p>
                            </div>
                        </div>
                        
                        ${post.caption ? `<div class="post-caption">${escapeHtml(post.caption)}</div>` : ''}
                    </div>
                    
                    <div class="post-actions">
                        <div class="post-actions-left">
                            <button class="post-action ${post.is_liked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
                                <span>${post.is_liked ? 'â¤ï¸' : 'ðŸ¤'}</span>
                                <span>${post.like_count || 0}</span>
                            </button>
                            
                            <button class="post-action" onclick="showComments('${post.id}')">
                                <span>ðŸ’¬</span>
                                <span>${post.comment_count || 0}</span>
                            </button>
                            
                            <button class="post-action" onclick="sharePost('${post.id}')">
                                <span>ðŸ“¤</span>
                                <span>${post.share_count || 0}</span>
                            </button>
                        </div>
                        
                        <button class="post-action-btn" onclick="playTrack('${escapeJs(post.track_spotify_url)}', '${escapeJs(post.track_title)}', '${escapeJs(post.track_artist)}')">
                            Play & Share
                        </button>
                    </div>
                </div>
            `;
        }

        async function checkForFeedUpdates() {
            if (!isSignedIn || !userToken || currentFeed === 'discover') {
                return;
            }

            try {
                // Only check for updates if user is on a social feed
                if (currentFeed === 'trending' || currentFeed === 'friends') {
                    const sinceParam = lastFeedUpdate ? `&since=${lastFeedUpdate}` : '';
                    const response = await fetch(`/api/posts?type=${currentFeed}&limit=5&offset=0${sinceParam}`, {
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success && data.posts) {
                        // Check if there are new posts (compare with cached data)
                        const cachedPosts = feedCache[currentFeed] || [];
                        const newPosts = data.posts.filter(newPost => 
                            !cachedPosts.some(cachedPost => cachedPost.id === newPost.id)
                        );
                        
                        if (newPosts.length > 0) {
                            // Show notification for new posts
                            if (newPosts.length === 1) {
                                showNotification(`New post from ${newPosts[0].profiles?.display_name || 'a friend'}`, 'info');
                            } else {
                                showNotification(`${newPosts.length} new posts from friends!`, 'info');
                            }
                            
                            // Add new posts to the top of the current feed
                            const feedContainer = document.getElementById('socialFeed');
                            if (feedContainer) {
                                const newPostsHTML = newPosts.map(post => createFeedPostHTML(post)).join('');
                                feedContainer.insertAdjacentHTML('afterbegin', newPostsHTML);
                            }
                            
                            // Update cache
                            feedCache[currentFeed] = [...newPosts, ...(feedCache[currentFeed] || [])];
                            
                            // Update last feed update time
                            lastFeedUpdate = new Date().toISOString();
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking feed updates:', error);
            }
        }

        async function showNotifications() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }

            document.getElementById('notificationsModal').style.display = 'flex';
            
            try {
                const response = await fetch('/api/friends?notifications=1&limit=20');
                const data = await response.json();
                
                if (data.success) {
                    displayNotifications(data.notifications);
                } else {
                    showNotificationsError('Failed to load notifications');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                showNotificationsError('Network error loading notifications');
            }
        }

        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            
            if (!notifications || notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="no-notifications">
                        <div class="empty-icon">ðŸ””</div>
                        <h4>No notifications</h4>
                        <p>You're all caught up!</p>
                    </div>
                `;
                return;
            }
            
            const notificationsHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" onclick="handleNotificationClick('${notification.id}', '${notification.type}')">
                    <div class="notification-avatar">
                        ${notification.avatar ? 
                            `<img src="${notification.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                            'ðŸŽµ'
                        }
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${escapeHtml(notification.title)}</div>
                        <div class="notification-message">${escapeHtml(notification.message)}</div>
                        <div class="notification-time">${formatTimeAgo(notification.created_at)}</div>
                        ${notification.type === 'friend_request' ? `
                            <div class="notification-actions">
                                <button class="notification-action-btn btn-accept-notification" onclick="event.stopPropagation(); respondToNotificationFriendRequest('${notification.user_id}', 'accept')">
                                    Accept
                                </button>
                                <button class="notification-action-btn btn-decline-notification" onclick="event.stopPropagation(); respondToNotificationFriendRequest('${notification.user_id}', 'decline')">
                                    Decline
                                </button>
                            </div>
                        ` : notification.type === 'like' || notification.type === 'comment' ? `
                            <div class="notification-actions">
                                <button class="notification-action-btn btn-view-notification" onclick="event.stopPropagation(); viewNotificationPost('${notification.post_id}')">
                                    View Post
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            notificationsList.innerHTML = notificationsHTML;
        }

        function showNotificationsError(message) {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = `
                <div class="no-notifications">
                    <div class="empty-icon">âš ï¸</div>
                    <h4>Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }

        function handleNotificationClick(notificationId, type) {
            // Mark notification as read
            markNotificationAsRead(notificationId);
            
            // Handle different notification types
            switch (type) {
                case 'friend_request':
                    // Already handled by action buttons
                    break;
                case 'like':
                case 'comment':
                    // Could navigate to the specific post
                    break;
                default:
                    break;
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                await fetch('/api/friends?notifications=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        notification_ids: [notificationId]
                    })
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                await fetch('/api/friends?notifications=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        mark_all: true
                    })
                });
                
                // Update UI
                unreadNotificationCount = 0;
                updateNotificationBadge();
                
                // Reload notifications
                await showNotifications();
                
                showNotification('All notifications marked as read', 'success');
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showNotification('Failed to mark notifications as read', 'error');
            }
        }

        async function respondToNotificationFriendRequest(userId, action) {
            try {
                // Find the friendship ID for this user
                const response = await fetch(`/api/friends?type=pending`);
                const data = await response.json();
                
                if (data.success) {
                    const request = data.pendingReceived?.find(req => req.user.id === userId);
                    if (request) {
                        await respondToFriendRequest(request.id, action);
                        // Reload notifications
                        await showNotifications();
                    }
                }
            } catch (error) {
                console.error('Error responding to friend request from notification:', error);
            }
        }

        function viewNotificationPost(postId) {
            // Close notifications modal
            closeModal('notificationsModal');
            
            // Switch to trending feed and scroll to post
            switchFeed('trending');
            
            // Could implement scrolling to specific post
            setTimeout(() => {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    postElement.style.border = '2px solid #667eea';
                    setTimeout(() => {
                        postElement.style.border = 'none';
                    }, 3000);
                }
            }, 500);
        }

        function sharePost(postId) {
            // TODO: Implement share functionality
            alert('Share feature coming soon!');
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        // Create Post Functions
        function showCreatePostModal() {
            if (!isSignedIn) {
                showSignInModal();
                return;
            }
            
            document.getElementById('createPostModal').style.display = 'flex';
            
            // Setup form event listeners
            setupCreatePostForm();
        }

        function setupCreatePostForm() {
            const trackUrlInput = document.getElementById('postTrackUrl');
            const captionInput = document.getElementById('postCaption');
            const captionCount = document.getElementById('captionCount');
            const submitBtn = document.getElementById('createPostSubmitBtn');
            
            // Track URL input handler
            trackUrlInput.addEventListener('input', async (e) => {
                const url = e.target.value.trim();
                if (url && (url.includes('spotify.com') || url.includes('music.apple.com') || url.includes('music.youtube.com'))) {
                    await resolveTrackForPost(url);
                } else {
                    hidePostPreview();
                }
            });
            
            // Caption character count
            captionInput.addEventListener('input', (e) => {
                const count = e.target.value.length;
                captionCount.textContent = count;
                
                if (count > 500) {
                    captionCount.style.color = '#ef4444';
                } else {
                    captionCount.style.color = '#6b7280';
                }
            });
            
            // Update preview caption
            captionInput.addEventListener('input', (e) => {
                const previewCaption = document.getElementById('previewCaption');
                if (e.target.value.trim()) {
                    previewCaption.textContent = e.target.value;
                    previewCaption.style.display = 'block';
                } else {
                    previewCaption.style.display = 'none';
                }
            });
        }

        async function resolveTrackForPost(url) {
            try {
                const response = await fetch(apiUrl(`/api/resolve?url=${encodeURIComponent(url)}`));
                const data = await response.json();
                
                if (data.success && data.track) {
                    showPostPreview(data.track);
                    document.getElementById('createPostSubmitBtn').disabled = false;
                } else {
                    hidePostPreview();
                    document.getElementById('createPostSubmitBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error resolving track:', error);
                hidePostPreview();
                document.getElementById('createPostSubmitBtn').disabled = true;
            }
        }

        function showPostPreview(track) {
            const preview = document.getElementById('postPreview');
            const artwork = document.getElementById('previewArtwork');
            const title = document.getElementById('previewTitle');
            const artist = document.getElementById('previewArtist');
            
            if (track.artwork) {
                artwork.innerHTML = `<img src="${track.artwork}" alt="${escapeHtml(track.title)}">`;
            } else {
                artwork.textContent = 'ðŸŽµ';
            }
            
            title.textContent = track.title;
            artist.textContent = track.artist;
            
            preview.style.display = 'block';
        }

        function hidePostPreview() {
            document.getElementById('postPreview').style.display = 'none';
            document.getElementById('createPostSubmitBtn').disabled = true;
        }

        async function createPost() {
            if (!isSignedIn || !userToken) {
                showSignInModal();
                return;
            }
            
            const trackUrl = document.getElementById('postTrackUrl').value.trim();
            const caption = document.getElementById('postCaption').value.trim();
            const privacy = document.getElementById('postPrivacy').value;
            
            if (!trackUrl) {
                alert('Please enter a music link');
                return;
            }
            
            const submitBtn = document.getElementById('createPostSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Sharing...';
            submitBtn.disabled = true;
            
            try {
                // First resolve the track
                const resolveResponse = await fetch(apiUrl(`/api/resolve?url=${encodeURIComponent(trackUrl)}`));
                const resolveData = await resolveResponse.json();
                
                if (!resolveData.success || !resolveData.track) {
                    throw new Error('Could not resolve track information');
                }
                
                const track = resolveData.track;
                
                // Create the post
                const postResponse = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        track_id: track.id,
                        track_title: track.title,
                        track_artist: track.artist,
                        track_album: track.album,
                        track_artwork_url: track.artwork,
                        track_spotify_url: track.sourceUrl,
                        track_duration_ms: track.durationMs,
                        caption: caption || null,
                        privacy: privacy
                    })
                });
                
                const postData = await postResponse.json();
                
                if (postData.success) {
                    // Close modal and refresh feed
                    closeModal('createPostModal');
                    clearCreatePostForm();
                    
                    // Refresh the current feed
                    if (currentFeed === 'trending' || currentFeed === 'friends') {
                        feedCache[currentFeed] = null; // Clear cache
                        await loadFeed(currentFeed);
                    }
                    
                    // Show success message
                    showNotification('Post shared successfully!', 'success');
                } else {
                    throw new Error(postData.error || 'Failed to create post');
                }
                
            } catch (error) {
                console.error('Error creating post:', error);
                showNotification('Failed to share post. Please try again.', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function clearCreatePostForm() {
            document.getElementById('postTrackUrl').value = '';
            document.getElementById('postCaption').value = '';
            document.getElementById('captionCount').textContent = '0';
            document.getElementById('postPrivacy').value = 'friends';
            hidePostPreview();
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        async function switchGenre(genre) {
            currentGenre = genre;
            
            // Update tab visual state
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-genre="${genre}"]`).classList.add('active');
            
            // Show loading state
            showLoadingIndicator();
            
            // Check client-side cache first
            if (genreCache[genre]) {
                displayTracks(genreCache[genre]);
                hideLoadingIndicator();
                return;
            }
            
            // Calculate how many tracks to load based on screen size
            const tracksPerPage = calculateTracksPerPage();
            
            // Handle special cases
            if (genre === 'recommendations') {
                await loadRecommendations();
                return;
            } else if (genre === 'playlists') {
                await loadPlaylists();
                return;
            }
            
            // Fetch from API with pagination
            try {
                const response = await fetch(`/api/trending?genre=${genre}&limit=${tracksPerPage}&offset=0`);
                const data = await response.json();
                
                if (data.success && data.tracks) {
                    genreCache[genre] = data.tracks;
                    displayTracks(data.tracks, data.hasMore);
                } else {
                    showError('Failed to load genre music');
                }
            } catch (error) {
                console.error('Genre fetch error:', error);
                showError('Network error');
            } finally {
                hideLoadingIndicator();
            }
        }

        function displayTracks(tracks, hasMore = false) {
            const grid = document.getElementById('musicGrid');
            
            if (tracks.length === 0) {
                grid.innerHTML = '<div class="empty-state">No tracks found</div>';
                return;
            }
            
            grid.innerHTML = tracks.map(track => `
                <div class="track-card" data-track-id="${track.id}">
                    <div class="track-artwork">
                        <img src="${track.artwork}" 
                             alt="${track.title}"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GVPzwvdGV4dD4KPC9zdmc+'"
                             onload="this.classList.add('loaded')">
                        <div class="play-overlay">
                            <button class="play-button" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                â–¶ï¸
                            </button>
                        </div>
                        ${track.explicit ? '<div class="explicit-badge">E</div>' : ''}
                    </div>
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(track.title)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        ${track.popularity ? `<div class="track-popularity">${getPopularityBars(track.popularity)}</div>` : ''}
                    </div>
                    <button class="track-action-btn" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
            
            // Add "Load More" button if there are more results
            if (hasMore) {
                grid.innerHTML += `
                    <div class="load-more-container">
                        <button class="btn btn-secondary" onclick="loadMoreTrending()">
                            Load More ${currentGenre} Music
                        </button>
                    </div>
                `;
            }
        }

        function showError(message) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="switchGenre('${currentGenre}')">
                        Try Again
                    </button>
                </div>
            `;
        }

        function loadTrendingMusic(genre) {
            const grid = document.getElementById('musicGrid');
            const music = trendingMusic[genre] || [];
            
            if (music.length === 0) {
                grid.innerHTML = '<div class="loading">Loading trending music...</div>';
                return;
            }
            
            grid.innerHTML = music.map(track => `
                <div class="track-card">
                    <div class="track-artwork">
                        <img src="${track.artwork}" alt="${track.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">
                        <div style="display: none; align-items: center; justify-content: center; font-size: 3rem; color: #999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">ðŸŽµ</div>
                    </div>
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                    <button class="play-btn" onclick="playTrack('${track.url.replace(/'/g, "\\'")}', '${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
        }

        function playTrack(url, title, artist) {
            currentTrack = { url, title, artist };
            
            // Generate share link using our API
            fetch(apiUrl(`/api/resolve?url=${encodeURIComponent(url)}`))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('shareLink').textContent = data.track.shortUrl;
                        showModal('shareModal');
                    } else {
                        alert('Error generating share link: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error generating share link');
                });
        }

        function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            // Check if it's a URL
            if (query.includes('spotify.com') || query.includes('music.apple.com') || query.includes('music.youtube.com')) {
                playTrack(query, 'Unknown Track', 'Unknown Artist');
            } else {
                // For text searches, we'll implement a simple search through our mock data
                searchInMockData(query);
            }
        }
        
        async function searchInMockData(query) {
            // First try our mock data - search across all genres
            const allTracks = [...trendingMusic.all, ...trendingMusic.pop, ...trendingMusic.rock, ...trendingMusic['hip-hop'], ...trendingMusic.country, ...trendingMusic.electronic];
            const mockResults = allTracks.filter(track => 
                track.title.toLowerCase().includes(query.toLowerCase()) ||
                track.artist.toLowerCase().includes(query.toLowerCase())
            );
            
            if (mockResults.length > 0) {
                displaySearchResults(mockResults);
            } else {
                // Try to search using our API for more comprehensive results
                try {
                    await searchWithAPI(query);
                } catch (error) {
                    console.error('API search failed:', error);
                    alert('No tracks found. Try pasting a music link instead!');
                }
            }
        }
        
        async function searchWithAPI(query) {
            // Use the proper search API instead of resolve API
            try {
                const response = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=20`));
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    // Convert tracks to posts format for feed display
                    const feedData = data.tracks.map(track => ({
                        id: track.id || Math.random().toString(36).substr(2, 9),
                        user_id: SYSTEM_USER_ID,
                        track_title: track.title,
                        track_artist: track.artist,
                        track_album: track.album,
                        track_artwork_url: track.artwork,
                        track_spotify_url: track.url,
                        caption: `Search result: ${track.title} by ${track.artist}`,
                        privacy: 'public',
                        like_count: Math.floor(Math.random() * 50),
                        comment_count: Math.floor(Math.random() * 10),
                        play_count: Math.floor(Math.random() * 100),
                        share_count: Math.floor(Math.random() * 20),
                        posted_at: new Date().toISOString(),
                        user: {
                            display_name: 'TrackShare',
                            avatar_url: 'https://via.placeholder.com/40'
                        }
                    }));
                    
                    // Display in feed format
                    displayFeed(feedData);
                    updateSectionTitle(`Search Results for "${query}" (${data.total || data.tracks.length} found)`);
                } else {
                    displayEmptyState(`No tracks found for "${query}"`);
                }
            } catch (error) {
                console.error('Search API error:', error);
                displayEmptyState(`Search failed for "${query}"`);
            }
        }
        
        function displayEmptyState(message) {
            const feedContainer = document.querySelector('#socialFeed .container');
            if (feedContainer) {
                feedContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸŽµ</div>
                        <h3>${message}</h3>
                        <p>Try searching for something else or check back later!</p>
                    </div>
                `;
            }
        }
        
        function displayExpandedSearchResults(query) {
            // Expanded mock data for better search results
            const expandedTracks = [
                // Taylor Swift songs
                { id: '1', title: 'Anti-Hero', artist: 'Taylor Swift', artwork: 'https://i.scdn.co/image/ab67616d0000b273bb54dde68cd23e2a268ae0f5', url: 'https://open.spotify.com/track/0V3wPSX9ygBnCm8psDIegu', platform: 'spotify' },
                { id: '2', title: 'Shake It Off', artist: 'Taylor Swift', artwork: 'https://i.scdn.co/image/ab67616d0000b2739abdf14e6058bd3903686148', url: 'https://open.spotify.com/track/5yIt6VMNpxjySAaG8yH2Cx', platform: 'spotify' },
                { id: '3', title: 'Love Story', artist: 'Taylor Swift', artwork: 'https://i.scdn.co/image/ab67616d0000b2738f6b4035c82eb9cf22d356d2', url: 'https://open.spotify.com/track/1D4LO9uTzQJYX5EEM466Aw', platform: 'spotify' },
                { id: '4', title: 'Blank Space', artist: 'Taylor Swift', artwork: 'https://i.scdn.co/image/ab67616d0000b273e787cffec20aa2a396a61647', url: 'https://open.spotify.com/track/1p80LdxRV74UKvL8gnD7ky', platform: 'spotify' },
                { id: '5', title: 'You Belong With Me', artist: 'Taylor Swift', artwork: 'https://i.scdn.co/image/ab67616d0000b2738f6b4035c82eb9cf22d356d2', url: 'https://open.spotify.com/track/4lsPG2IQgZCVXc6m6cqRsy', platform: 'spotify' },
                
                // Ed Sheeran songs
                { id: '6', title: 'Shape of You', artist: 'Ed Sheeran', artwork: 'https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96', url: 'https://open.spotify.com/track/7qiZfU4dY1lWllzX7mPBI3', platform: 'spotify' },
                { id: '7', title: 'Perfect', artist: 'Ed Sheeran', artwork: 'https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96', url: 'https://open.spotify.com/track/0tgVpDi06FyKpA1z0VMD4v', platform: 'spotify' },
                { id: '8', title: 'Thinking Out Loud', artist: 'Ed Sheeran', artwork: 'https://i.scdn.co/image/ab67616d0000b273ba5db46f4b838ef6027e6f96', url: 'https://open.spotify.com/track/1Slwb6dOYkBlWalB14Wjbf', platform: 'spotify' },
                
                // The Weeknd songs
                { id: '9', title: 'Blinding Lights', artist: 'The Weeknd', artwork: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36', url: 'https://open.spotify.com/track/0VjIjW4WUjzctJjODdQn8f', platform: 'spotify' },
                { id: '10', title: 'Starboy', artist: 'The Weeknd', artwork: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36', url: 'https://open.spotify.com/track/7MXVkk9YMctZqd1Srtv4MB', platform: 'spotify' },
                { id: '11', title: 'The Hills', artist: 'The Weeknd', artwork: 'https://i.scdn.co/image/ab67616d0000b2738863bc11d2aa12b54f5aeb36', url: 'https://open.spotify.com/track/7fBv7CLKzipRk6EC6TWHOB', platform: 'spotify' }
            ];
            
            const results = expandedTracks.filter(track => 
                track.title.toLowerCase().includes(query.toLowerCase()) ||
                track.artist.toLowerCase().includes(query.toLowerCase())
            );
            
            if (results.length > 0) {
                displaySearchResults(results);
            } else {
                alert('No tracks found. Try pasting a music link instead!');
            }
        }
        
        function displaySearchResults(results) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = results.map(track => `
                <div class="track-card">
                    <div class="track-artwork">
                        <img src="${track.artwork}" alt="${track.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.nextElementSibling.style.display='none';">
                        <div style="display: none; align-items: center; justify-content: center; font-size: 3rem; color: #999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">ðŸŽµ</div>
                    </div>
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                    <button class="play-btn" onclick="playTrack('${track.url.replace(/'/g, "\\'")}', '${track.title.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
            
            // Update section title
            document.querySelector('.section-title').textContent = `Search Results (${results.length} found)`;
        }

        function showSignIn() {
            showModal('signInModal');
        }

        function showSignUp() {
            showModal('signUpModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function signInWithGoogle() {
            // Redirect to Google OAuth (using correct endpoint)
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + '/auth/google/callback')}&response_type=code&scope=openid%20email%20profile`;
            window.location.href = googleAuthUrl;
        }

        function signInWithApple() {
            // Redirect to Apple OAuth
            const appleAuthUrl = `https://appleid.apple.com/auth/authorize?client_id=${APPLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin + '/auth/apple/callback')}&response_type=code&scope=name%20email`;
            window.location.href = appleAuthUrl;
        }

        function signUpWithGoogle() {
            // Same as sign in for OAuth
            signInWithGoogle();
        }

        function signUpWithApple() {
            // Same as sign in for OAuth
            signInWithApple();
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(shareLink).then(() => {
                alert('Link copied to clipboard!');
            });
        }

function openInSpotify() {
    if (!currentTrack) return;
    
    const trackId = currentTrack.url.match(/track\/([a-zA-Z0-9]+)/)?.[1];
    if (!trackId) {
        console.error('Could not extract Spotify track ID from URL:', currentTrack.url);
        return;
    }
    
    // Use single colon for custom scheme (Android compatible)
    const appUrl = `spotify:track:${trackId}`;
    const webUrl = `https://open.spotify.com/track/${trackId}`;
    
    // Try app first, fallback to web after delay
    window.open(appUrl, '_blank');
    setTimeout(() => {
        window.open(webUrl, '_blank');
    }, 800);
}

function openInAppleMusic() {
    if (!currentTrack) return;
    
    // Use HTTPS URL - Android OS handles app interception
    const searchTerm = encodeURIComponent(`${currentTrack.title} ${currentTrack.artist}`);
    window.open(`https://music.apple.com/search?term=${searchTerm}`, '_blank');
}

function openInYouTubeMusic() {
    if (!currentTrack) return;
    
    const videoId = currentTrack.url.match(/v=([a-zA-Z0-9_-]+)/)?.[1];
    if (!videoId) {
        console.error('Could not extract YouTube video ID from URL:', currentTrack.url);
        return;
    }
    
    // Use HTTPS URL - Android OS handles app interception
    window.open(`https://music.youtube.com/watch?v=${videoId}`, '_blank');
}

        // Check for OAuth callback parameters
        function checkAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const userParam = urlParams.get('user');
            const errorParam = urlParams.get('error');
            
            if (errorParam) {
                alert('Authentication failed: ' + decodeURIComponent(errorParam));
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (userParam) {
                const userData = JSON.parse(decodeURIComponent(userParam));
                handleSuccessfulAuth(userData);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        function handleSuccessfulAuth(userData) {
            // Store user data in localStorage
            localStorage.setItem('trackshare_user', JSON.stringify(userData));
            
            // Update UI to show logged in state
            updateAuthUI(userData);
            
            alert(`Welcome, ${userData.name}! You're now signed in to TrackShare.`);
        }
        
        function updateAuthUI(userData) {
            isSignedIn = true;
            userToken = userData.token; // Assuming token is stored
            
            const authButtons = document.querySelector('.auth-buttons');
            authButtons.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img src="${userData.picture || 'https://via.placeholder.com/32'}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">
                    <span style="color: #333; font-weight: 600;">${userData.name}</span>
                    <button class="btn btn-secondary" onclick="showCreatePostModal()">+ Share Music</button>
                    <button class="btn btn-outline" onclick="signOut()">Sign Out</button>
                </div>
            `;
            
            // Show authenticated-only tabs
            document.querySelectorAll('.auth-only').forEach(tab => {
                tab.style.display = 'flex';
            });
            
            // Show notifications container
            const notificationsContainer = document.getElementById('notificationsContainer');
            if (notificationsContainer) {
                notificationsContainer.style.display = 'block';
            }
            
            // Start real-time updates
            startRealTimeUpdates();
        }
        
        function signOut() {
            // Use secure auth service
            authService.logout().then(() => {
                // Stop real-time updates
                stopRealTimeUpdates();
                
                // Hide authenticated-only tabs
                document.querySelectorAll('.auth-only').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // Reset to trending tab
                switchFeed('trending');
                
                // Hide notifications
                const notificationsContainer = document.getElementById('notificationsContainer');
                if (notificationsContainer) {
                    notificationsContainer.style.display = 'none';
                }
                unreadNotificationCount = 0;
                
                localStorage.removeItem('trackshare_user');
                location.reload();
            }).catch(error => {
                console.error('Sign out error:', error);
                // Still perform cleanup even if API call fails
                stopRealTimeUpdates();
                document.querySelectorAll('.auth-only').forEach(tab => {
                    tab.style.display = 'none';
                });
                switchFeed('trending');
                const notificationsContainer = document.getElementById('notificationsContainer');
                if (notificationsContainer) {
                    notificationsContainer.style.display = 'none';
                }
                unreadNotificationCount = 0;
                localStorage.removeItem('trackshare_user');
                location.reload();
            });
        }
        
        async function checkExistingAuth() {
            try {
                const isAuth = await authService.checkAuthStatus();
                if (isAuth) {
                    const user = authService.getCurrentUser();
                    updateAuthUI(user);
                } else {
                    // Fallback to localStorage for backward compatibility
                    const userData = localStorage.getItem('trackshare_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        updateAuthUI(user);
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // Fallback to localStorage
                const userData = localStorage.getItem('trackshare_user');
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        updateAuthUI(user);
                    } catch (parseError) {
                        console.error('Error parsing stored user data:', parseError);
                        localStorage.removeItem('trackshare_user');
                    }
                }
            }
        }

        // Enhanced search functionality
        function setupSearchHandlers() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.querySelector('.btn-search');
            
            if (!searchInput || !searchButton) {
                console.warn('Search elements not found, skipping search handler setup');
                return;
            }
            
            // Debounced search on typing
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timer
                clearTimeout(searchDebounceTimer);
                
                if (query.length === 0) {
                    // Back to trending
                    switchGenre(currentGenre);
                    return;
                }
                
                if (query.length < 2) {
                    return; // Wait for at least 2 characters
                }
                
                // Debounce 300ms
                searchDebounceTimer = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
            
            // Immediate search on button click
            searchButton.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    performSearch(query);
                }
            });
            
            // Search on Enter key
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value.trim();
                    if (query) {
                        clearTimeout(searchDebounceTimer);
                        performSearch(query);
                    }
                }
            });
        }

        async function resolveUrl(url) {
            showLoadingIndicator();
            updateSectionTitle('Resolving URL...');
            
            try {
                const response = await fetch(apiUrl(`/api/resolve?url=${encodeURIComponent(url)}`));
                const data = await response.json();
                
                if (data.success && data.track) {
                    // Create search results from API response
                    const apiResults = [{
                        id: data.track.id,
                        title: data.track.title,
                        artist: data.track.artist,
                        artwork: data.track.artwork,
                        url: data.track.sourceUrl,
                        platform: data.track.platform || 'unknown'
                    }];
                    
                    displaySearchResults(apiResults, false);
                    updateSectionTitle(`Resolved: ${data.track.title}`);
                } else {
                    displayEmptyState(
                        'URL Not Found',
                        'We couldn\'t resolve this music URL.',
                        'Try a different link or search for the track directly.'
                    );
                }
            } catch (error) {
                console.error('URL resolve error:', error);
                displayErrorState(
                    'Resolve Failed',
                    'Something went wrong while resolving the URL.',
                    'Please try again or search for the track directly.'
                );
            } finally {
                hideLoadingIndicator();
            }
        }

        async function performSearch(query) {
            currentSearchQuery = query;
            searchOffset = 0;
            
            // Check if it's a URL (more specific detection)
            if (query.match(/^https?:\/\/.+\..+/)) {
                resolveUrl(query);
                return;
            }
            
            // Show loading
            showLoadingIndicator();
            updateSectionTitle('Searching...');
            
            try {
                const response = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=50`));
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    displaySearchResults(data.tracks, data.hasMore);
                    updateSectionTitle(`Search Results for "${query}" (${data.total.toLocaleString()} found)`);
                } else {
                    displayEmptyState(
                        'No Results',
                        `We couldn't find any tracks matching "${query}".`,
                        'Try a different search term or browse trending music.'
                    );
                }
            } catch (error) {
                console.error('Search error:', error);
                displayErrorState(
                    'Search Failed',
                    'Something went wrong while searching.',
                    'Please try again or browse trending music.'
                );
            } finally {
                hideLoadingIndicator();
            }
        }

        function displaySearchResults(tracks, hasMore) {
            const grid = document.getElementById('musicGrid');
            
            grid.innerHTML = tracks.map(track => `
                <div class="track-card search-result" data-track-id="${track.id}">
                    <div class="track-artwork">
                        <img src="${track.artwork || track.artworkMedium}" 
                             alt="${track.title}"
                             loading="lazy"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GVPzwvdGV4dD4KPC9zdmc+'"
                             onload="this.classList.add('loaded')">
                        <div class="play-overlay">
                            <button class="play-button" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                â–¶ï¸
                            </button>
                        </div>
                        ${track.explicit ? '<div class="explicit-badge">E</div>' : ''}
                    </div>
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(track.title)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        <div class="track-meta">
                            <span class="track-album">${escapeHtml(track.album)}</span>
                            ${track.popularity ? `<span class="track-popularity">${getPopularityBars(track.popularity)}</span>` : ''}
                        </div>
                    </div>
                    <button class="track-action-btn" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                        Play & Share
                    </button>
                </div>
            `).join('');
            
            // Add "Load More" button if there are more results
            if (hasMore) {
                grid.innerHTML += `
                    <div class="load-more-container">
                        <button class="btn btn-secondary" onclick="loadMoreSearchResults()">
                            Load More Results
                        </button>
                    </div>
                `;
            }
        }

        async function loadMoreTrending() {
            const tracksPerPage = calculateTracksPerPage();
            const currentOffset = document.querySelectorAll('.track-card').length;
            
            try {
                const response = await fetch(`/api/trending?genre=${currentGenre}&limit=${tracksPerPage}&offset=${currentOffset}`);
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    // Append results to existing grid
                    const grid = document.getElementById('musicGrid');
                    const loadMoreBtn = grid.querySelector('.load-more-container');
                    
                    if (loadMoreBtn) {
                        loadMoreBtn.remove();
                    }
                    
                    const newCards = data.tracks.map(track => `
                        <div class="track-card" data-track-id="${track.id}">
                            <div class="track-artwork">
                                <img src="${track.artwork}" 
                                     alt="${track.title}"
                                     loading="lazy"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GVPzwvdGV4dD4KPC9zdmc+'"
                                     onload="this.classList.add('loaded')">
                                <div class="play-overlay">
                                    <button class="play-button" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                        â–¶ï¸
                                    </button>
                                </div>
                                ${track.explicit ? '<div class="explicit-badge">E</div>' : ''}
                            </div>
                            <div class="track-info">
                                <div class="track-title">${escapeHtml(track.title)}</div>
                                <div class="track-artist">${escapeHtml(track.artist)}</div>
                                ${track.popularity ? `<div class="track-popularity">${getPopularityBars(track.popularity)}</div>` : ''}
                            </div>
                            <button class="track-action-btn" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                Play & Share
                            </button>
                        </div>
                    `).join('');
                    
                    grid.insertAdjacentHTML('beforeend', newCards);
                    
                    if (data.hasMore) {
                        grid.insertAdjacentHTML('beforeend', `
                            <div class="load-more-container">
                                <button class="btn btn-secondary" onclick="loadMoreTrending()">
                                    Load More ${currentGenre} Music
                                </button>
                            </div>
                        `);
                    }
                }
            } catch (error) {
                console.error('Load more trending error:', error);
                alert('Failed to load more music');
            }
        }

        async function loadMoreSearchResults() {
            searchOffset += 50;
            
            try {
                const response = await fetch(apiUrl(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&limit=50&offset=${searchOffset}`));
                const data = await response.json();
                
                if (data.success && data.tracks && data.tracks.length > 0) {
                    // Append results to existing grid
                    const grid = document.getElementById('musicGrid');
                    const loadMoreBtn = grid.querySelector('.load-more-container');
                    
                    if (loadMoreBtn) {
                        loadMoreBtn.remove();
                    }
                    
                    const newCards = data.tracks.map(track => `
                        <div class="track-card search-result" data-track-id="${track.id}">
                            <div class="track-artwork">
                                <img src="${track.artwork || track.artworkMedium}" 
                                     alt="${track.title}"
                                     loading="lazy"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GVPzwvdGV4dD4KPC9zdmc+'"
                                     onload="this.classList.add('loaded')">
                                <div class="play-overlay">
                                    <button class="play-button" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                        â–¶ï¸
                                    </button>
                                </div>
                                ${track.explicit ? '<div class="explicit-badge">E</div>' : ''}
                            </div>
                            <div class="track-info">
                                <div class="track-title">${escapeHtml(track.title)}</div>
                                <div class="track-artist">${escapeHtml(track.artist)}</div>
                                <div class="track-meta">
                                    <span class="track-album">${escapeHtml(track.album)}</span>
                                    ${track.popularity ? `<span class="track-popularity">${getPopularityBars(track.popularity)}</span>` : ''}
                                </div>
                            </div>
                            <button class="track-action-btn" onclick="playTrack('${escapeJs(track.url)}', '${escapeJs(track.title)}', '${escapeJs(track.artist)}')">
                                Play & Share
                            </button>
                        </div>
                    `).join('');
                    
                    grid.insertAdjacentHTML('beforeend', newCards);
                    
                    if (data.hasMore) {
                        grid.insertAdjacentHTML('beforeend', `
                            <div class="load-more-container">
                                <button class="btn btn-secondary" onclick="loadMoreSearchResults()">
                                    Load More Results
                                </button>
                            </div>
                        `);
                    }
                }
            } catch (error) {
                console.error('Load more error:', error);
                alert('Failed to load more results');
            }
        }

        function getPopularityBars(popularity) {
            const bars = Math.ceil(popularity / 20); // 0-5 bars
            return 'ðŸ”¥'.repeat(bars);
        }

        function escapeJs(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showLoadingIndicator() {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            `;
        }

        function hideLoadingIndicator() {
            // Loading indicator will be replaced by content
        }

        function updateSectionTitle(title) {
            const titleElement = document.querySelector('.section-title');
            if (titleElement) {
                titleElement.textContent = title;
            }
        }

        // Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            pollingManager.cleanup();
        });
        
        // Accessibility Utilities
        class AccessibilityManager {
            constructor() {
                this.announcements = document.getElementById('announcements');
                this.focusHistory = [];
                this.init();
            }
            
            init() {
                // Track focus for modal management
                document.addEventListener('focusin', (e) => {
                    this.focusHistory.push(e.target);
                    if (this.focusHistory.length > 10) {
                        this.focusHistory.shift();
                    }
                });
                
                // Handle escape key for modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.handleEscapeKey();
                    }
                });
                
                // Handle tab key for focus management
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        this.handleTabKey(e);
                    }
                });
            }
            
            // Announce messages to screen readers
            announce(message, priority = 'polite') {
                if (this.announcements) {
                    this.announcements.setAttribute('aria-live', priority);
                    this.announcements.textContent = message;
                    
                    // Clear after announcement
                    setTimeout(() => {
                        this.announcements.textContent = '';
                    }, 1000);
                }
            }
            
            // Trap focus within modal
            trapFocus(modal) {
                const focusableElements = modal.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        if (e.shiftKey) {
                            if (document.activeElement === firstElement) {
                                lastElement.focus();
                                e.preventDefault();
                            }
                        } else {
                            if (document.activeElement === lastElement) {
                                firstElement.focus();
                                e.preventDefault();
                            }
                        }
                    }
                });
                
                // Focus first element
                if (firstElement) {
                    firstElement.focus();
                }
            }
            
            // Restore focus after modal closes
            restoreFocus() {
                const lastFocused = this.focusHistory[this.focusHistory.length - 1];
                if (lastFocused && lastFocused.focus) {
                    lastFocused.focus();
                }
            }
            
            // Handle escape key
            handleEscapeKey() {
                const openModal = document.querySelector('.modal[aria-hidden="false"]');
                if (openModal) {
                    const closeButton = openModal.querySelector('.modal-close');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            }
            
            // Handle tab key for better focus management
            handleTabKey(e) {
                const openModal = document.querySelector('.modal[aria-hidden="false"]');
                if (openModal) {
                    // Let the modal handle tab trapping
                    return;
                }
                
                // Skip to main content if tabbing from header
                if (e.target.closest('.header') && !e.shiftKey) {
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.focus();
                        e.preventDefault();
                    }
                }
            }
            
            // Add ARIA labels to dynamic content
            addAriaLabels() {
                // Add labels to track cards
                document.querySelectorAll('.track-card').forEach((card, index) => {
                    if (!card.getAttribute('aria-label')) {
                        const title = card.querySelector('.track-title')?.textContent || 'Track';
                        const artist = card.querySelector('.track-artist')?.textContent || 'Unknown Artist';
                        card.setAttribute('aria-label', `Track ${index + 1}: ${title} by ${artist}`);
                    }
                });
                
                // Add labels to post cards
                document.querySelectorAll('.post-card').forEach((card, index) => {
                    if (!card.getAttribute('aria-label')) {
                        const title = card.querySelector('.track-title')?.textContent || 'Track';
                        const artist = card.querySelector('.track-artist')?.textContent || 'Unknown Artist';
                        card.setAttribute('aria-label', `Post ${index + 1}: ${title} by ${artist}`);
                    }
                });
            }
            
            // Update page title for screen readers
            updatePageTitle(title) {
                document.title = `${title} - TrackShare`;
                this.announce(`Page changed to ${title}`);
            }
            
            // Handle loading states
            announceLoading(message = 'Loading content') {
                this.announce(message);
            }
            
            announceLoaded(message = 'Content loaded') {
                this.announce(message);
            }
            
            announceError(message = 'An error occurred') {
                this.announce(message, 'assertive');
            }
        }
        
        // Global accessibility manager
        const a11y = new AccessibilityManager();
        
        // PWA and Service Worker Support
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.isInstalled = false;
                this.init();
            }
            
            async init() {
                // Register service worker
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered:', registration);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showUpdateNotification();
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
                
                // Listen for install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallButton();
                });
                
                // Check if already installed
                window.addEventListener('appinstalled', () => {
                    this.isInstalled = true;
                    this.hideInstallButton();
                    console.log('PWA installed successfully');
                });
                
                // Handle offline/online status
                window.addEventListener('online', () => {
                    this.updateOnlineStatus(true);
                });
                
                window.addEventListener('offline', () => {
                    this.updateOnlineStatus(false);
                });
                
                // Initial online status
                this.updateOnlineStatus(navigator.onLine);
            }
            
            showInstallButton() {
                const installButton = document.createElement('button');
                installButton.className = 'btn btn-primary pwa-install-btn';
                installButton.innerHTML = 'ðŸ“± Install App';
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideInUp 0.3s ease-out;
                `;
                
                installButton.addEventListener('click', () => {
                    this.installApp();
                });
                
                document.body.appendChild(installButton);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (installButton.parentNode) {
                        installButton.remove();
                    }
                }, 10000);
            }
            
            hideInstallButton() {
                const installButton = document.querySelector('.pwa-install-btn');
                if (installButton) {
                    installButton.remove();
                }
            }
            
            async installApp() {
                if (!this.deferredPrompt) return;
                
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                console.log('Install prompt outcome:', outcome);
                this.deferredPrompt = null;
                
                if (outcome === 'accepted') {
                    this.hideInstallButton();
                }
            }
            
            showUpdateNotification() {
                const updateNotification = document.createElement('div');
                updateNotification.className = 'pwa-update-notification';
                updateNotification.innerHTML = `
                    <div style="background: #667eea; color: white; padding: 1rem; border-radius: 8px; margin: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <h4>ðŸŽµ Update Available</h4>
                        <p>TrackShare has been updated with new features!</p>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove(); window.location.reload();">
                            Update Now
                        </button>
                    </div>
                `;
                
                document.body.appendChild(updateNotification);
            }
            
            updateOnlineStatus(isOnline) {
                const statusIndicator = document.querySelector('.online-status') || this.createStatusIndicator();
                
                if (isOnline) {
                    statusIndicator.innerHTML = 'ðŸŸ¢ Online';
                    statusIndicator.style.color = '#10b981';
                } else {
                    statusIndicator.innerHTML = 'ðŸ”´ Offline';
                    statusIndicator.style.color = '#ef4444';
                }
            }
            
            createStatusIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'online-status';
                indicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 1000;
                    font-size: 12px;
                    font-weight: 600;
                    background: rgba(255,255,255,0.9);
                    padding: 4px 8px;
                    border-radius: 4px;
                    backdrop-filter: blur(10px);
                `;
                document.body.appendChild(indicator);
                return indicator;
            }
            
            // Offline action queue
            async queueOfflineAction(url, options) {
                if (navigator.onLine) {
                    return fetch(url, options);
                }
                
                // Store for later sync
                const action = {
                    url,
                    options,
                    timestamp: Date.now()
                };
                
                try {
                    const db = await this.openDB();
                    const transaction = db.transaction(['actions'], 'readwrite');
                    const store = transaction.objectStore('actions');
                    await store.add(action);
                    console.log('Action queued for offline sync');
                } catch (error) {
                    console.error('Failed to queue offline action:', error);
                }
            }
            
            openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('TrackShareOffline', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = () => {
                        const db = request.result;
                        if (!db.objectStoreNames.contains('actions')) {
                            db.createObjectStore('actions', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            }
        }
        
        // Initialize PWA manager
        const pwaManager = new PWAManager();
        
        // Load initial music
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuthCallback();
            await checkExistingAuth();
            setupSearchHandlers(); // Initialize enhanced search
            loadFeed('trending'); // Load social feed by default
            
            // Setup form event listeners using polling manager
            const editProfileForm = document.getElementById('editProfileForm');
            if (editProfileForm) {
                pollingManager.addEventListener(editProfileForm, 'submit', saveProfileChanges);
            }
            
            const playlistCreateForm = document.getElementById('playlistCreateForm');
            if (playlistCreateForm) {
                pollingManager.addEventListener(playlistCreateForm, 'submit', createPlaylist);
            }
            
            const groupCreateForm = document.getElementById('groupCreateForm');
            if (groupCreateForm) {
                pollingManager.addEventListener(groupCreateForm, 'submit', createGroup);
            }
            
            const challengeCreateForm = document.getElementById('challengeCreateForm');
            if (challengeCreateForm) {
                pollingManager.addEventListener(challengeCreateForm, 'submit', createChallenge);
            }
            
            const eventCreateForm = document.getElementById('eventCreateForm');
            if (eventCreateForm) {
                pollingManager.addEventListener(eventCreateForm, 'submit', createEvent);
            }
            
            // Setup modal close handlers
            pollingManager.addEventListener(document, 'click', function(e) {
                if (e.target.classList.contains('playlist-create-modal')) {
                    closePlaylistCreateModal();
                    closePlaylistViewModal();
                }
            });
        });

        // Handle Enter key in search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });
    </script>
    </body>
    </html><!-- Force redeploy 10/21/2025 15:15:00 - Fixed OAuth endpoint + env vars -->
